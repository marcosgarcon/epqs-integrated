<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Process & Quality - Diagrama de Dispersão</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--card:#0b1220;--text:#e5e7eb;--accent:#22d3ee;--accent2:#a78bfa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px;}
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial;background:linear-gradient(120deg,#0b1020,#0a1328);color:var(--text);display:grid;grid-template-columns:280px 1fr;grid-template-rows:auto 1fr;gap:0;}
      header{grid-column:1/3;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(90deg,#0b1020,#0a1a35);border-bottom:1px solid #1e293b;position:sticky;top:0;z-index:5}
      .header-title h1{margin:0;font-size:20px;letter-spacing:.4px;color:var(--text);}.header-title .subtitle{margin:4px 0 0 0;font-size:14px;font-weight:normal;color:var(--accent);}.header-title .dev-credit{margin:4px 0 0 0;font-size:11px;font-weight:normal;color:#64748b;}
      header .actions{display:flex;flex-wrap:wrap;gap:8px}
      button, .btn{background:var(--muted);color:var(--text);border:1px solid #243041;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow);transition:.2s;font-weight:600;display:inline-flex;align-items:center;justify-content:center;gap:8px;}
      button:hover, .btn:hover{transform:translateY(-1px);border-color:#334155}
      button.primary, .btn.primary{background:linear-gradient(180deg,#0ea5e9,#2563eb);border-color:transparent}
      button.ghost, .btn.ghost{background:transparent;border-color:#334155}
      aside{border-right:1px solid #1f2937;background:linear-gradient(180deg,#0b1020,#0a1328);padding:16px;display:flex;flex-direction:column;gap:24px;justify-content:space-between;}
      .menu{display:flex;flex-direction:column;gap:8px}
      .menu a{display:flex;gap:10px;align-items:center;text-decoration:none;color:#cbd5e1;padding:10px 12px;border:1px solid #1e293b;border-radius:12px;background:rgba(255,255,255,.02);cursor:pointer;}
      .menu a.active, .menu a:hover{border-color:#334155;background:rgba(34,211,238,.08);color:#e2e8f0}
      main{padding:18px;overflow:auto}
      .hidden, .tab-content.hidden{display:none !important}
      section{background:rgba(255,255,255,.03);border:1px solid #1f2937;border-radius:var(--radius);padding:20px;margin-bottom:20px;box-shadow:var(--shadow)}
      h2, h3, h4{margin:0 0 12px 0;color:var(--accent);}
      .grid{display:grid;gap:16px;}
      .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
      .grid-2 { grid-template-columns: 1fr 1fr; }
      .field{display:flex;flex-direction:column;gap:6px}
      label{font-size:12px;color:#93c5fd}
      input, select, textarea{background:#0b1220;border:1px solid #243041;color:var(--text);padding:10px 12px;border-radius:10px;outline:none;font-family:inherit;font-size:14px;min-height:44px}
      table{width:100%;border-collapse:collapse;} th, td{padding:10px 12px;border-bottom:1px solid var(--muted);text-align:left;font-size:14px;vertical-align:middle;} th{background:rgba(255,255,255,.05);font-size:12px;color:#94a3b8;} td input{width:100%;font-size:13px;}
      .button-group{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap;}
      .chart-container{position:relative;min-height:450px;width:100%;}
      .stats-panel{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;text-align:center;}
      .stat-item{background:var(--card);padding:16px;border-radius:12px;border:1px solid var(--muted);}
      .stat-item h3{font-size:14px;color:var(--accent2);margin-bottom:8px;text-transform:uppercase;}
      .stat-item p{font-size:24px;font-weight:bold;margin:0;color:var(--text);}
      .stat-item .interpretation{font-size:16px;font-weight:normal;color:var(--accent);}
      #record-counter{background:rgba(255,255,255,.02);border:1px solid #1e293b;border-radius:12px;padding:12px;} #record-counter p{margin:8px 0;color:#cbd5e1;display:flex;justify-content:space-between;} #record-counter span{font-weight:bold;color:var(--accent);}
      .toast-container{position:fixed;top:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:10px;}
      .toast{padding:12px 18px;border-radius:12px;color:white;font-weight:600;font-size:14px;box-shadow:var(--shadow);opacity:0;transform:translateX(100%);transition:all 0.4s ease;}
      .toast.show{opacity:1;transform:translateX(0);}.toast.success{background:linear-gradient(90deg,#22c55e,#16a3b4);}.toast.error{background:linear-gradient(90deg,#ef4444,#dc2626);}.toast.info{background:linear-gradient(90deg,#3b82f6,#2563eb);}
      .help-content h3{color:var(--accent2);margin-top:24px;margin-bottom:10px;border-bottom:1px solid var(--muted);padding-bottom:5px;font-size:16px;}.help-content p,.help-content li{line-height:1.6;color:var(--text);}.help-content ul{list-style-position:inside;padding-left:10px;}.help-content code{background-color:var(--muted);padding:2px 6px;border-radius:4px;font-family:monospace;color:var(--accent);}
      @media print{body{grid-template-columns:1fr;color:#000;background:#fff;}header,aside,.hidden-print,.btn{display:none!important;}main{padding:0;}section{border:1px solid #ccc;box-shadow:none;background:#fff;page-break-inside:avoid;}h2,h3,h4,label,p,.stat-item p,.stat-item h3{color:black;}.stat-item{background:#f9f9f9;}}
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="header-title">
            <h1>Eng Process & Quality</h1>
            <p class="subtitle">Diagrama de Dispersão</p>
            <p class="dev-credit">Desenvolvido por Marcos Garçon</p>
        </div>
        <div class="actions">
            <button class="btn ghost" id="btn-restore-backup">Restaurar Backup</button>
            <button class="btn ghost" id="btn-download-backup">Baixar Backup (.json)</button>
            <button class="btn ghost" id="btn-archive-and-clear" style="color:var(--warn);">Arquivar e Limpar</button>
            <button class="btn primary hidden-print" id="btn-export-pdf">Exportar PDF</button>
        </div>
    </header>
    <aside>
        <div>
            <div class="menu">
                <a class="tab-link active" onclick="openTab(event, 'dashboard-container')"><i class="ph-bold ph-columns"></i> Dashboard</a>
                <a class="tab-link" onclick="openTab(event, 'help-container')"><i class="ph-bold ph-question"></i> Ajuda</a>
            </div>
        </div>
        <div id="record-counter">
            <h4>Registros</h4>
            <p>Análises Salvas: <span id="analysis-count">0</span></p>
        </div>
    </aside>
    <main>
        <div id="dashboard-container" class="tab-content">
            <section>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h2>Análises de Dispersão Salvas</h2>
                    <button id="btn-new-analysis" class="btn primary"><i class="ph-bold ph-plus-circle"></i> Nova Análise</button>
                </div>
                <table id="analysis-list-table">
                    <thead><tr><th>Título da Análise</th><th>Responsável</th><th>Data</th><th class="hidden-print">Ações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>

        <div id="form-container" class="tab-content hidden">
            <form id="dispersao-form">
                <input type="hidden" id="analysis-id">
                <section>
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <h2 id="form-title">Nova Análise de Dispersão</h2>
                        <button type="button" id="btn-back-dashboard" class="btn ghost"><i class="ph-bold ph-arrow-left"></i> Voltar</button>
                    </div>
                    <div class="grid grid-4">
                        <div class="field"><label for="analysis-title">Título</label><input type="text" id="analysis-title" placeholder="Ex: Temperatura vs. Defeitos"></div>
                        <div class="field"><label for="analysis-lead">Responsável</label><input type="text" id="analysis-lead"></div>
                        <div class="field"><label for="analysis-date">Data</label><input type="date" id="analysis-date"></div>
                    </div>
                    <div class="grid grid-2" style="margin-top:16px;">
                        <div class="field"><label for="axis-x-label">Nome da Variável X</label><input type="text" id="axis-x-label" placeholder="Ex: Temperatura (°C)"></div>
                        <div class="field"><label for="axis-y-label">Nome da Variável Y</label><input type="text" id="axis-y-label" placeholder="Ex: Nº de Defeitos"></div>
                    </div>
                </section>

                <section>
                    <h2>Dados de Entrada</h2>
                    <table id="dispersao-table">
                        <thead><tr><th>Ponto</th><th>Variável X</th><th>Variável Y</th><th class="hidden-print" style="text-align:center;">Ação</th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <div class="button-group">
                        <button type="button" id="add-dispersao-row" class="btn ghost"><i class="ph-bold ph-plus"></i> Adicionar Ponto</button>
                        <button type="button" id="clear-table-btn" class="btn ghost"><i class="ph-bold ph-trash"></i> Limpar Dados</button>
                    </div>
                </section>

                <div class="button-group hidden-print" style="justify-content: flex-end;">
                    <button type="button" id="btn-save-analysis" class="btn primary"><i class="ph-bold ph-check-circle"></i> Salvar Análise e Gerar Gráfico</button>
                </div>

                <section id="results-section" class="hidden">
                    <h2>Resultados Estatísticos</h2>
                    <div id="stats-panel-container" class="stats-panel"></div>
                </section>

                <section id="chart-section" class="hidden">
                    <h2>Gráfico de Dispersão</h2>
                    <div class="chart-container">
                        <canvas id="dispersao-chart"></canvas>
                    </div>
                </section>
            </form>
        </div>

        <div id="help-container" class="tab-content hidden">
            <section class="help-content">
                <h2>Guia de Utilização - Diagrama de Dispersão</h2>
                <p>Esta ferramenta é um sistema completo para analisar a relação entre duas variáveis, calcular estatísticas de correlação e visualizar os dados em um gráfico.</p>
                <h3>Fluxo de Trabalho</h3>
                <ol>
                    <li>No <strong>Dashboard</strong>, clique em <code>+ Nova Análise</code>.</li>
                    <li>Preencha as <strong>Informações da Análise</strong>, como título e nomes para os eixos X e Y.</li>
                    <li>Na tabela de <strong>Dados de Entrada</strong>, insira os pares de valores (X, Y) que você coletou. Use <code>+ Adicionar Ponto</code> se precisar de mais linhas.</li>
                    <li>Clique em <code>Salvar Análise e Gerar Gráfico</code>. A ferramenta irá automaticamente:
                        <ul>
                            <li>Salvar seu trabalho.</li>
                            <li>Calcular e exibir os <strong>Resultados Estatísticos</strong>.</li>
                            <li>Desenhar o <strong>Gráfico de Dispersão</strong> com a linha de tendência.</li>
                        </ul>
                    </li>
                    <li>Use o botão <code>Exportar PDF</code> no cabeçalho para imprimir ou salvar um relatório da sua análise.</li>
                </ol>
                 <h3>Interpretando os Resultados</h3>
                <ul>
                    <li><strong>Coeficiente de Correlação (r):</strong> Varia de -1 a +1.
                        <ul>
                            <li><strong>Próximo de +1:</strong> Correlação Positiva Forte (quando X aumenta, Y tende a aumentar).</li>
                            <li><strong>Próximo de -1:</strong> Correlação Negativa Forte (quando X aumenta, Y tende a diminuir).</li>
                            <li><strong>Próximo de 0:</strong> Não há correlação linear aparente.</li>
                        </ul>
                    </li>
                    <li><strong>R² (Coeficiente de Determinação):</strong> É o (r) ao quadrado. Um R² de 0.85 significa que 85% da variação na Variável Y é explicada pela variação na Variável X.</li>
                    <li><strong>Linha de Tendência:</strong> Mostra visualmente a direção e a força da correlação.</li>
                </ul>
            </section>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE, DBs & CONSTANTS ---
        let analyses = [];
        const DB_KEY = 'mg_dispersao_analyses_v1';
        let dispersionChart = null;

        // --- DOM ELEMENTS ---
        const main = document.querySelector('main');
        const dashboardContainer = document.getElementById('dashboard-container');
        const formContainer = document.getElementById('form-container');
        const helpContainer = document.getElementById('help-container');
        const analysisListBody = document.querySelector('#analysis-list-table tbody');
        const dataTableBody = document.querySelector('#dispersao-table tbody');
        const analysisCountSpan = document.getElementById('analysis-count');

        // --- HELPERS & NAVIGATION ---
        const showToast = (message, type = 'info') => { const c = document.getElementById('toast-container'), t = document.createElement('div'); t.className = `toast ${type}`; t.textContent = message; c.appendChild(t); setTimeout(() => t.classList.add('show'), 10); setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, 4000); };
        const saveData = () => { try { localStorage.setItem(DB_KEY, JSON.stringify(analyses)); } catch (e) { showToast('Erro ao salvar.', 'error'); } };
        const loadData = () => { analyses = JSON.parse(localStorage.getItem(DB_KEY)) || []; };

        window.openTab = (evt, tabId) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
            evt.currentTarget.classList.add('active');
        };
        
        const showForm = () => openTab({currentTarget: document.querySelector('.menu a')}, 'form-container');
        const showDashboard = () => { openTab({currentTarget: document.querySelector('.menu a[onclick*="dashboard-container"]')}, 'dashboard-container'); renderAnalysisList(); };

        // --- RENDER FUNCTIONS ---
        const renderAnalysisList = () => {
            analysisListBody.innerHTML = '';
            if (analyses.length === 0) {
                analysisListBody.innerHTML = '<tr><td colspan="4">Nenhuma análise salva.</td></tr>';
            } else {
                analyses.sort((a,b) => b.id - a.id).forEach(analysis => {
                    const row = analysisListBody.insertRow();
                    const analysisDate = analysis.date ? new Date(analysis.date + 'T00:00:00').toLocaleDateString() : 'N/A';
                    row.innerHTML = `
                        <td>${analysis.title || 'Sem Título'}</td>
                        <td>${analysis.lead || 'N/A'}</td>
                        <td>${analysisDate}</td>
                        <td class="hidden-print">
                            <button class="btn ghost btn-edit" data-id="${analysis.id}" style="padding:5px 10px">Editar</button>
                            <button class="btn ghost btn-delete" data-id="${analysis.id}" style="padding:5px 10px">Excluir</button>
                        </td>
                    `;
                });
            }
            analysisCountSpan.textContent = analyses.length;
        };

        const addPointRow = (point = { x: '', y: '' }) => {
            const rowCount = dataTableBody.rows.length;
            const row = dataTableBody.insertRow();
            row.innerHTML = `
                <td>${rowCount + 1}</td>
                <td><input type="number" class="point-x" value="${point.x}" step="any"></td>
                <td><input type="number" class="point-y" value="${point.y}" step="any"></td>
                <td class="hidden-print" style="text-align:center;"><button type="button" class="btn ghost btn-remove-row" style="padding:4px">&times;</button></td>
            `;
        };

        const calculateStatistics = (points) => {
            if (points.length < 2) return null;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
            points.forEach(p => {
                sumX += p.x; sumY += p.y; sumXY += p.x * p.y;
                sumX2 += p.x * p.x; sumY2 += p.y * p.y;
            });

            const n = points.length;
            const rNumerator = (n * sumXY) - (sumX * sumY);
            const rDenominator = Math.sqrt(((n * sumX2) - (sumX * sumX)) * ((n * sumY2) - (sumY * sumY)));
            const correlation = rDenominator === 0 ? 0 : rNumerator / rDenominator;
            
            const slope = ((n * sumXY) - (sumX * sumY)) / ((n * sumX2) - (sumX * sumX));
            const intercept = (sumY / n) - (slope * (sumX / n));

            let interpretation = "Sem Correlação Aparente";
            const absR = Math.abs(correlation);
            if (absR >= 0.9) interpretation = `Correlação ${correlation > 0 ? 'Positiva' : 'Negativa'} Muito Forte`;
            else if (absR >= 0.7) interpretation = `Correlação ${correlation > 0 ? 'Positiva' : 'Negativa'} Forte`;
            else if (absR >= 0.5) interpretation = `Correlação ${correlation > 0 ? 'Positiva' : 'Negativa'} Moderada`;
            else if (absR >= 0.3) interpretation = `Correlação ${correlation > 0 ? 'Positiva' : 'Negativa'} Fraca`;

            const minX = Math.min(...points.map(p => p.x));
            const maxX = Math.max(...points.map(p => p.x));
            const regressionPoints = [
                { x: minX, y: slope * minX + intercept },
                { x: maxX, y: slope * maxX + intercept }
            ];

            return { correlation, rSquared: correlation * correlation, equation: `y = ${slope.toFixed(3)}x + ${intercept.toFixed(3)}`, interpretation, regressionPoints };
        };
        
        const renderResults = (stats) => {
            const container = document.getElementById('stats-panel-container');
            if (!stats) {
                container.innerHTML = '<p>Adicione pelo menos 2 pontos e salve para gerar os resultados.</p>';
                return;
            }
            container.innerHTML = `
                <div class="stat-item"><h3>Correlação (r)</h3><p>${stats.correlation.toFixed(4)}</p></div>
                <div class="stat-item"><h3>R²</h3><p>${stats.rSquared.toFixed(4)}</p></div>
                <div class="stat-item"><h3>Equação da Reta</h3><p style="font-size: 18px;">${stats.equation}</p></div>
                <div class="stat-item"><h3>Interpretação</h3><p class="interpretation">${stats.interpretation}</p></div>
            `;
        };

        const renderChart = (points, stats, xLabel, yLabel) => {
            if (dispersionChart) dispersionChart.destroy();
            const ctx = document.getElementById('dispersao-chart').getContext('2d');
            const datasets = [{ label: 'Pontos de Dados', type: 'scatter', data: points, backgroundColor: 'rgba(34, 211, 238, 0.8)', pointRadius: 6 }];
            if(stats && stats.regressionPoints) { datasets.push({ label: 'Linha de Tendência', type: 'line', data: stats.regressionPoints, borderColor: 'rgba(239, 68, 68, 0.8)', borderWidth: 2, pointRadius: 0, fill: false }); }
            dispersionChart = new Chart(ctx, { data: { datasets }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: xLabel || 'Variável X' } }, y: { title: { display: true, text: yLabel || 'Variável Y' } } } } });
        };
        
        const populateForm = (analysis = {}) => {
            document.getElementById('dispersao-form').reset();
            document.getElementById('analysis-id').value = analysis.id || '';
            document.getElementById('analysis-title').value = analysis.title || '';
            document.getElementById('analysis-lead').value = analysis.lead || '';
            document.getElementById('analysis-date').value = analysis.date || new Date().toISOString().slice(0, 10);
            document.getElementById('axis-x-label').value = analysis.xLabel || '';
            document.getElementById('axis-y-label').value = analysis.yLabel || '';
            document.getElementById('form-title').textContent = analysis.id ? 'Editar Análise' : 'Nova Análise de Dispersão';

            dataTableBody.innerHTML = '';
            const points = analysis.points || [];
            if (points.length > 0) { points.forEach(p => addPointRow(p)); } 
            else { for(let i = 0; i < 5; i++) addPointRow(); }

            if (analysis.id) {
                const stats = calculateStatistics(points);
                renderResults(stats);
                renderChart(points, stats, analysis.xLabel, analysis.yLabel);
                document.getElementById('results-section').classList.remove('hidden');
                document.getElementById('chart-section').classList.remove('hidden');
            } else {
                document.getElementById('results-section').classList.add('hidden');
                document.getElementById('chart-section').classList.add('hidden');
            }
            showForm();
        };

        // --- EVENT LISTENERS ---
        document.getElementById('btn-new-analysis').addEventListener('click', () => populateForm());
        document.getElementById('btn-back-dashboard').addEventListener('click', showDashboard);
        document.getElementById('add-dispersao-row').addEventListener('click', () => addPointRow());
        document.getElementById('clear-table-btn').addEventListener('click', () => { dataTableBody.innerHTML = ''; for(let i=0; i<5; i++) addPointRow(); showToast('Dados limpos.', 'info'); });
        
        document.getElementById('btn-save-analysis').addEventListener('click', () => {
            const id = document.getElementById('analysis-id').value || `analysis_${Date.now()}`;
            const points = Array.from(dataTableBody.rows).map(row => ({
                x: parseFloat(row.querySelector('.point-x').value),
                y: parseFloat(row.querySelector('.point-y').value)
            })).filter(p => !isNaN(p.x) && !isNaN(p.y));

            if (points.length < 2) { showToast('É necessário pelo menos 2 pontos com dados válidos.', 'error'); return; }
            
            const analysisData = { id, title: document.getElementById('analysis-title').value, lead: document.getElementById('analysis-lead').value, date: document.getElementById('analysis-date').value, xLabel: document.getElementById('axis-x-label').value, yLabel: document.getElementById('axis-y-label').value, points };
            const index = analyses.findIndex(a => a.id == id);
            if (index > -1) { analyses[index] = analysisData; } else { analyses.push(analysisData); }
            
            saveData();
            showToast('Análise salva com sucesso!', 'success');
            
            const stats = calculateStatistics(analysisData.points);
            renderResults(stats);
            renderChart(analysisData.points, stats, analysisData.xLabel, analysisData.yLabel);
            document.getElementById('results-section').classList.remove('hidden');
            document.getElementById('chart-section').classList.remove('hidden');
            renderAnalysisList();
        });
        
        document.getElementById('btn-export-pdf').addEventListener('click', () => { if(formContainer.classList.contains('hidden')) { showToast('Abra uma análise para exportar.', 'info'); return; } window.print(); });

        analysisListBody.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.btn-edit');
            const deleteBtn = e.target.closest('.btn-delete');
            if (editBtn) { const analysis = analyses.find(a => a.id == editBtn.dataset.id); if (analysis) populateForm(analysis); }
            if (deleteBtn) { if (confirm('Tem certeza?')) { analyses = analyses.filter(a => a.id != deleteBtn.dataset.id); saveData(); renderAnalysisList(); showToast('Análise excluída.', 'info'); } }
        });
        
        dataTableBody.addEventListener('click', (e) => { if (e.target.closest('.btn-remove-row')) { e.target.closest('tr').remove(); Array.from(dataTableBody.rows).forEach((row, index) => row.cells[0].textContent = index + 1); } });
        
        // Backup & Restore
        document.getElementById('btn-download-backup').addEventListener('click', () => { const blob = new Blob([JSON.stringify(analyses, null, 2)],{type:'application/json'}); const l=document.createElement("a");l.href=URL.createObjectURL(blob);l.download=`dispersao_backup_${new Date().toISOString().slice(0,10)}.json`;l.click();URL.revokeObjectURL(l.href);showToast("Backup baixado!","success"); });
        document.getElementById('btn-restore-backup').addEventListener('click', () => { const i=document.createElement('input'); i.type='file';i.accept='.json';i.onchange=e=>{const r=new FileReader();r.onload=ev=>{if(!confirm('Restaurar um backup substituirá TODOS os dados atuais. Continuar?'))return;try{const d=JSON.parse(ev.target.result);if(Array.isArray(d)){analyses=d;saveData();renderAnalysisList();showToast('Backup restaurado!');}else{throw new Error('Formato inválido.');}}catch(err){showToast('Erro: Arquivo de backup inválido.','error');}};r.readAsText(e.target.files[0]);};i.click();});
        document.getElementById('btn-archive-and-clear').addEventListener('click', () => { if (confirm("ATENÇÃO: Isso irá baixar um backup e APAGAR os dados do navegador. Deseja continuar?")) { document.getElementById('btn-download-backup').click(); localStorage.removeItem(DB_KEY); showToast("Dados arquivados e limpos.", "info"); setTimeout(() => window.location.reload(), 1500); } });

        // --- INITIALIZATION ---
        const initApp = () => {
            loadData();
            showDashboard();
        };
        
        initApp();
    });
    </script>
</body>
</html>