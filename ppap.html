<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Process & Quality - Gerenciador PPAP</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
      :root{
        --bg:#0f172a; --panel:#111827; --muted:#1f2937; --card:#0b1220; --text:#e5e7eb; --accent:#22d3ee; --accent2:#a78bfa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
        --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
        --status-aberto: #0d6efd; --status-andamento: #fd7e14; --status-concluido: #22c55e; --status-cancelado: #6c757d; --status-espera: #6c757d; --status-atrasado: #dc3545;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial; background:linear-gradient(120deg,#0b1020,#0a1328); color:var(--text); display:grid; grid-template-columns:280px 1fr; grid-template-rows:auto 1fr; gap:0; }
      header{grid-column:1/3; display:flex; align-items:center; justify-content:space-between; padding:14px 20px; background:linear-gradient(90deg,#0b1020,#0a1a35); border-bottom:1px solid #1e293b; position:sticky; top:0; z-index:5}
      .header-title h1 { margin: 0; font-size: 20px; letter-spacing: .4px; color: var(--text); }
      .header-title .subtitle { margin: 4px 0 0 0; font-size: 14px; font-weight: normal; color: var(--accent); }
      .header-title .dev-credit { margin: 4px 0 0 0; font-size: 11px; font-weight: normal; color: #64748b; }
      header .actions{display:flex; flex-wrap: wrap; gap:8px}
      button, .btn{background:var(--muted); color:var(--text); border:1px solid #243041; border-radius:12px; padding:10px 14px; cursor:pointer; box-shadow:var(--shadow); transition:.2s; font-weight:600}
      button:hover, .btn:hover{transform:translateY(-1px); border-color:#334155}
      button.primary, .btn.primary{background:linear-gradient(180deg,#0ea5e9,#2563eb); border-color:transparent}
      button.ghost, .btn.ghost{background:transparent; border-color:#334155}
      aside{border-right:1px solid #1f2937; background:linear-gradient(180deg,#0b1020,#0a1328); padding:16px; display:flex; flex-direction:column; gap:24px; justify-content: space-between;}
      .menu{display:flex; flex-direction:column; gap:8px}
      .menu .tab-link{display:flex; gap:10px; align-items:center; text-decoration:none; color:#cbd5e1; padding:10px 12px; border:1px solid #1e293b; border-radius:12px; background:rgba(255,255,255,.02); cursor:pointer;}
      .menu .tab-link.active,.menu .tab-link:hover{border-color:#334155; background:rgba(34,211,238,.08); color:#e2e8f0}
      main{padding:18px; overflow:auto}
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      section{background:rgba(255,255,255,.03); border:1px solid #1f2937; border-radius:var(--radius); padding:16px; margin-bottom:18px; box-shadow:var(--shadow)}
      h2, h3{margin:0 0 12px 0; font-size:18px; color: var(--accent);}
      h4{margin:0 0 12px 0; font-size:16px; color: var(--accent2);}
      .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
      .field{display:flex; flex-direction:column; gap:6px}
      label{font-size:12px; color:#93c5fd}
      input, select, textarea{background:#0b1220; border:1px solid #243041; color:var(--text); padding:10px 12px; border-radius:10px; outline:none; font-family:inherit; font-size:14px;}
      .hidden { display: none !important; }

      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 10px 12px; border-bottom: 1px solid var(--muted); text-align: left; font-size: 14px; vertical-align: middle;}
      th { background: rgba(255,255,255,.05); font-size: 12px; color: #94a3b8; }
      tbody tr:hover { background: rgba(255,255,255,0.02); }
      .ppap-item { padding: 12px 0; border-bottom: 1px dashed var(--muted); }
      .ppap-item-header { display: grid; grid-template-columns: 1fr 150px 120px; gap: 15px; align-items: center; }
      .ppap-item-header label { font-weight: bold; color: var(--text); font-size: 15px; }
      .ppap-item-header select { font-size: 12px; padding: 5px 8px; }
      .attachments-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--muted);}
      .attachment-drop-zone { padding: 10px; font-size: 12px; margin-top: 5px; border: 2px dashed var(--muted); text-align: center; cursor: pointer; border-radius: 8px;}
      .attachment-drop-zone:hover { border-color: var(--accent); }
      .attachment-preview-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
      .attachment-item { width: 80px; height: 80px; position: relative; }
      .attachment-item img, .attachment-item .file-icon { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
      .attachment-item .file-icon { background: var(--muted); display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: 11px; padding: 5px; overflow: hidden; word-break: break-all; }
      .attachment-item .file-icon span { font-size: 24px; }
      .attachment-item .remove-attachment { position: absolute; top: -5px; right: -5px; background: var(--bad); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; line-height: 1;}
      .status-pill { padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: bold; color: white; text-align: center; display: inline-block;}
      .status-aberto { background-color: var(--status-aberto); } .status-andamento { background-color: var(--status-andamento); } .status-concluido { background-color: var(--status-concluido); } .status-cancelado { background-color: var(--status-cancelado); } .status-espera { background-color: var(--status-espera); } .status-atrasado { background-color: var(--status-atrasado); }
      .progress-bar-container { background: var(--muted); border-radius: 99px; height: 10px; width: 100%; overflow: hidden; }
      .progress-bar { background: var(--accent); height: 100%; width: 0%; transition: width 0.3s; }
      .action-item-block { padding: 12px; border: 1px solid var(--muted); border-radius: 12px; background: var(--card); position: relative; margin-top: 10px; }
      .remove-action-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; color: #fca5a5; font-size: 1.5rem; cursor: pointer;}
      .help-content p, .help-content li { color: #cbd5e1; line-height: 1.6; }
      .help-content code { background: var(--muted); padding: 2px 6px; border-radius: 6px; font-family: monospace; color: var(--accent2); }
      .help-content ul { list-style-position: inside; padding-left: 10px; }
      #record-counter { background:rgba(255,255,255,.02); border:1px solid #1e293b; border-radius: 12px; padding: 12px;}
      #record-counter p { margin: 8px 0; color: #cbd5e1; display: flex; justify-content: space-between; }
      #record-counter span { font-weight: bold; color: var(--accent); }
      #toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
      .toast { padding: 12px 18px; border-radius: 12px; color: white; font-weight: 600; font-size: 14px; box-shadow: var(--shadow); opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
      .toast.show { opacity: 1; transform: translateX(0); }
      .toast.success { background: linear-gradient(90deg, #22c55e, #16a34a); }
      .toast.error { background: linear-gradient(90deg, #ef4444, #dc2626); }
      .toast.info { background: linear-gradient(90deg, #3b82f6, #2563eb); }
      
      @media print {
        body { grid-template-columns: 1fr; color: #000; background: #fff; }
        header, aside, .hidden-print, #btn-cancel, button[type="submit"], #btn-add-action-plan, .remove-action-btn, .remove-attachment, .btn-toggle-attachments { display: none !important; }
        main { padding: 0; }
        section { border: 1px solid #ccc; box-shadow: none; background: #fff; page-break-inside: avoid; }
        input, select, textarea { border-color: #aaa; background: #f9f9f9; color: #000; }
        :root { --accent: #007bff; --accent2: #6f42c1; --text: #000; --card: #fff; }
        label, h2, h3, h4 { color: black; }
        .progress-bar-container { background: #e9ecef; }
        .progress-bar { background: var(--accent); }
      }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="header-title">
            <h1>Eng Process & Quality</h1>
            <p class="subtitle">Gerenciador de PPAP</p>
            <p class="dev-credit">Desenvolvido por Marcos Gar√ßon</p>
        </div>
        <div class="actions">
            <button class="btn ghost" id="btn-restore-backup">Restaurar Backup</button>
            <button class="btn ghost" id="btn-download-backup">Baixar Backup (.json)</button>
            <button class="btn ghost" id="btn-archive-and-clear" style="color:var(--warn);">Arquivar e Limpar</button>
            <button class="btn primary" id="btn-export-pdf">Exportar PDF</button>
        </div>
    </header>

    <aside>
        <div>
            <div class="menu">
                 <a class="tab-link active" onclick="openTab(event, 'Dashboard')">PPAPs Salvos</a>
                 <a class="tab-link" onclick="openTab(event, 'Ajuda')">Ajuda</a>
            </div>
        </div>
        <div id="record-counter">
            <h4>Registros</h4>
            <p>PPAPs Salvos: <span id="ppap-count">0</span></p>
        </div>
    </aside>

    <main>
        <div id="Dashboard" class="tab-content active">
            <section>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Listagem de Submiss√µes PPAP</h2>
                    <button id="btn-new-ppap" class="btn primary">+ Novo PPAP</button>
                </div>
                <table id="ppap-list-table">
                    <thead>
                        <tr>
                            <th>Nome da Pe√ßa</th>
                            <th>N¬∫ da Pe√ßa</th>
                            <th>Status Geral</th>
                            <th>Progresso</th>
                            <th>Prazo Original</th>
                            <th class="hidden-print">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>
        
        <div id="form-container" class="tab-content">
            <section>
                <form id="ppap-form">
                    <input type="hidden" id="ppap-id">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;">
                        <h2>Formul√°rio de Submiss√£o PPAP</h2>
                    </div>
                    
                    <section>
                        <h4>Informa√ß√µes Gerais e Prazos</h4>
                        <div class="grid">
                           <div class="field" style="grid-column: span 6;"><label for="part-name">Nome da Pe√ßa</label><input type="text" id="part-name"></div>
                           <div class="field" style="grid-column: span 6;"><label for="part-number">N¬∫ da Pe√ßa</label><input type="text" id="part-number"></div>
                           <div class="field" style="grid-column: span 6;"><label for="supplier-name">Fornecedor</label><input type="text" id="supplier-name"></div>
                           <div class="field" style="grid-column: span 6;"><label for="supplier-code">C√≥digo do Fornecedor</label><input type="text" id="supplier-code"></div>
                           
                           <div class="field" style="grid-column: span 3;"><label for="data-inicial">Data Inicial Prevista</label><input type="date" id="data-inicial"></div>
                           <div class="field" style="grid-column: span 3;"><label for="data-prazo">Prazo Original</label><input type="date" id="data-prazo"></div>
                           <div class="field" style="grid-column: span 3;"><label for="geral-status">Status Geral</label><select id="geral-status"><option value="aberto">Aberto</option><option value="andamento">Em Andamento</option><option value="espera">Em Espera</option><option value="atrasado">Atrasado</option><option value="concluido">Conclu√≠do</option><option value="cancelado">Cancelado</option></select></div>
                           <div id="nova-data-container" class="field hidden" style="grid-column: span 3;"><label for="nova-data">Nova Data de Conclus√£o</label><input type="date" id="nova-data"></div>
                        </div>
                    </section>

                    <section>
                        <h4>Evolu√ß√£o da Submiss√£o</h4>
                        <div id="progress-summary" style="text-align: right; margin-bottom: 5px; font-size: 14px;">0/18 (0%)</div>
                        <div class="progress-bar-container"><div id="progress-bar" class="progress-bar"></div></div>
                    </section>

                    <section>
                        <h4>Checklist de Itens do PPAP</h4>
                        <div id="ppap-items-container"></div>
                    </section>
                    
                    <section>
                         <h4>Planos de A√ß√£o / Pend√™ncias</h4>
                         <div id="action-plan-form-container"></div>
                         <button type="button" id="btn-add-action-plan" class="btn ghost">+ Adicionar Plano de A√ß√£o</button>
                    </section>

                    <div style="margin-top: 16px; display: flex; gap: 10px;">
                        <button type="submit" class="btn primary">Salvar PPAP</button>
                        <button type="button" id="btn-cancel" class="btn ghost">Cancelar</button>
                    </div>
                </form>
            </section>
        </div>

        <div id="Ajuda" class="tab-content">
             <section class="help-content">
                <h2>Guia de Utiliza√ß√£o - Gerenciador de PPAP</h2>
                <p>Bem-vindo ao Gerenciador de PPAP! Esta ferramenta foi projetada para ajudar no controle e acompanhamento de todas as etapas do Processo de Aprova√ß√£o de Pe√ßa de Produ√ß√£o.</p>
                <h3>Tela Principal (Dashboard)</h3>
                <p>Exibe um resumo de todos os PPAPs salvos. A barra de progresso mostra visualmente quantos itens do checklist foram conclu√≠dos.</p>
                <h3>Formul√°rio de PPAP</h3>
                <p>Aqui √© onde voc√™ preenche todos os detalhes de uma submiss√£o PPAP.</p>
                <ul>
                    <li><strong>Checklist de Itens:</strong> Para cada um dos 18 itens, defina seu status (Pendente, Conclu√≠do ou N√£o Aplic√°vel).</li>
                    <li><strong>Anexos:</strong> Para cada item do checklist, voc√™ pode clicar em <code>+ Anexos</code> para expandir a √°rea de upload. Os anexos s√£o salvos junto com o PPAP.</li>
                    <li><strong>Planos de A√ß√£o / Pend√™ncias:</strong> Se houver pend√™ncias, clique em <code>+ Adicionar Plano de A√ß√£o</code>. Voc√™ pode criar m√∫ltiplas a√ß√µes, cada uma com seu respons√°vel, status e datas.</li>
                </ul>
                <h3>Aviso Importante sobre os Dados</h3>
                <p>Esta ferramenta salva todas as informa√ß√µes diretamente no seu navegador. <strong>Limpar o cache do navegador ou os dados de site pode apagar todos os seus PPAPs salvos.</strong> Utilize a fun√ß√£o <code>Baixar Backup</code> com frequ√™ncia.</p>
            </section>
        </div>
    </main>

    <template id="ppap-item-template">
        <div class="ppap-item">
            <div class="ppap-item-header">
                <label></label>
                <select class="item-status">
                    <option value="pendente">Pendente</option>
                    <option value="concluido">Conclu√≠do</option>
                    <option value="na">N√£o Aplic√°vel</option>
                </select>
                <button type="button" class="btn ghost btn-toggle-attachments" style="font-size:12px; padding:5px 10px;">+ Anexos</button>
            </div>
            <div class="attachments-section hidden"></div>
        </div>
    </template>
    
    <template id="attachment-ui-template">
        <div class="field">
             <input type="file" class="attachments-input hidden" multiple>
             <div class="attachment-drop-zone">Arraste ou clique para adicionar arquivos (m√°x 5MB)</div>
             <div class="attachment-preview-grid"></div>
        </div>
    </template>

    <template id="action-plan-form-template">
        <div class="action-item-block">
            <button type="button" class="remove-action-btn">&times;</button>
            <div class="grid">
                <div class="field" style="grid-column: span 12;"><label>A√ß√£o / Pend√™ncia</label><textarea class="action-input" rows="2"></textarea></div>
                <div class="field" style="grid-column: span 3;"><label>Respons√°vel</label><input type="text" class="responsible-input"></div>
                <div class="field" style="grid-column: span 3;"><label>Status</label><select class="status-input"><option value="aberto">Aberto</option><option value="andamento">Em Andamento</option><option value="concluido">Conclu√≠do</option><option value="cancelado">Cancelado</option></select></div>
                <div class="field" style="grid-column: span 3;"><label>Data In√≠cio</label><input type="date" class="start-date-input"></div>
                <div class="field" style="grid-column: span 3;"><label>Data Final</label><input type="date" class="end-date-input"></div>
                <div class="field" style="grid-column: span 12; border-top: 1px solid var(--muted); padding-top: 12px; margin-top: 6px;">
                    <label>Anexos</label>
                    <div class="attachments-section" style="border-top: none; padding-top: 0; margin-top: 0;"></div>
                </div>
            </div>
        </div>
    </template>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & DBs ---
        let ppaps = [];
        const DB_KEY = 'mg_ppaps_v2';

        // --- DOM ELEMENTS ---
        const main = document.querySelector('main');
        const dashboardContainer = document.getElementById('Dashboard');
        const formContainer = document.getElementById('form-container');
        const form = document.getElementById('ppap-form');
        const btnNewPpap = document.getElementById('btn-new-ppap');
        const btnCancel = document.getElementById('btn-cancel');
        const ppapListContainer = document.querySelector('#ppap-list-table tbody');
        const ppapCountSpan = document.getElementById('ppap-count');
        const ppapItemsContainer = document.getElementById('ppap-items-container');
        const actionPlanFormContainer = document.getElementById('action-plan-form-container');
        const btnAddActionPlan = document.getElementById('btn-add-action-plan');
        const actionPlanFormTemplate = document.getElementById('action-plan-form-template');
        const attachmentUiTemplate = document.getElementById('attachment-ui-template');
        const ppapItemTemplate = document.getElementById('ppap-item-template');
        const geralStatusSelect = document.getElementById('geral-status');
        const novaDataContainer = document.getElementById('nova-data-container');
        const progressBar = document.getElementById('progress-bar');
        const progressSummary = document.getElementById('progress-summary');

        const PPAP_ELEMENTS = ["1. Registros de Projeto", "2. Documentos de Altera√ß√£o de Engenharia", "3. Aprova√ß√£o de Engenharia do Cliente", "4. DFMEA", "5. Fluxograma de Processo", "6. PFMEA", "7. Plano de Controle", "8. Estudos de An√°lise do Sistema de Medi√ß√£o (MSA)", "9. Resultados Dimensionais", "10. Registros de Testes de Material / Desempenho", "11. Estudos Iniciais de Processo (CEP)", "12. Documenta√ß√£o de Laborat√≥rio Qualificado", "13. Relat√≥rio de Aprova√ß√£o da Apar√™ncia (AAR)", "14. Amostras de Pe√ßas de Produ√ß√£o", "15. Amostra Padr√£o", "16. Aux√≠lios de Verifica√ß√£o", "17. Registros de Conformidade com Requisitos Espec√≠ficos do Cliente", "18. Mandado de Submiss√£o de Pe√ßa (PSW)"];

        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        };
        
        const saveData = () => { try { localStorage.setItem(DB_KEY, JSON.stringify(ppaps)); } catch (e) { showToast('Erro ao salvar.', 'error'); } };
        const loadData = () => { ppaps = JSON.parse(localStorage.getItem(DB_KEY)) || []; };
        
        const handleDownloadBackup = () => { const blob = new Blob([JSON.stringify(ppaps, null, 2)], { type: 'application/json' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `ppap_backup_${new Date().toISOString().slice(0, 10)}.json`; link.click(); URL.revokeObjectURL(link.href); showToast("Backup baixado!", "success"); };
        const handleRestoreBackup = () => { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = event => { if (!confirm('Aten√ß√£o: Restaurar um backup substituir√° TODOS os dados atuais. Deseja continuar?')) return; try { const restored = JSON.parse(event.target.result); if (Array.isArray(restored)) { ppaps = restored; saveData(); renderPpapList(); showToast('Backup restaurado com sucesso!'); } else { throw new Error('Formato inv√°lido.'); } } catch (err) { showToast('Erro: O arquivo de backup √© inv√°lido.', 'error'); } }; reader.readAsText(file); }; input.click(); };
        const handleArchiveAndClear = () => { if (confirm("ATEN√á√ÉO: Isso ir√° baixar um backup e depois APAGAR os dados do navegador. Deseja continuar?")) { handleDownloadBackup(); localStorage.removeItem(DB_KEY); showToast("Dados arquivados e limpos.", "info"); setTimeout(() => window.location.reload(), 2000); } };
        window.openTab = (evt, tabName) => { document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove('active')); document.querySelectorAll("aside .tab-link").forEach(link => link.classList.remove('active')); const targetTab = document.getElementById(tabName); if (targetTab) { targetTab.classList.add('active'); } if (evt && evt.currentTarget) { evt.currentTarget.classList.add('active'); } };

        const showForm = () => { dashboardContainer.classList.remove('active'); formContainer.classList.add('active'); };
        const showDashboard = () => { form.reset(); ppapItemsContainer.innerHTML = ''; actionPlanFormContainer.innerHTML = ''; document.getElementById('ppap-id').value = ''; formContainer.classList.remove('active'); dashboardContainer.classList.add('active'); renderPpapList(); };
        
        const renderPpapList = () => {
            ppapListContainer.innerHTML = '';
            if (ppaps.length === 0) { ppapListContainer.innerHTML = '<tr><td colspan="6">Nenhum PPAP salvo.</td></tr>'; } 
            else {
                ppaps.sort((a, b) => b.id - a.id).forEach(ppap => {
                    const row = ppapListContainer.insertRow();
                    const prazoDate = ppap.dataPrazo ? new Date(ppap.dataPrazo + 'T00:00:00').toLocaleDateString() : 'N/A';
                    const applicableItems = (ppap.items || []).filter(item => item.status !== 'na');
                    const completedItems = applicableItems.filter(item => item.status === 'concluido');
                    const progress = applicableItems.length > 0 ? (completedItems.length / applicableItems.length) * 100 : 0;
                    row.innerHTML = `<td>${ppap.partName || 'N/A'}</td><td>${ppap.partNumber || 'N/A'}</td><td><span class="status-pill status-${ppap.geralStatus}">${ppap.geralStatus}</span></td><td><div class="progress-bar-container" title="${completedItems.length} de ${applicableItems.length} itens (${progress.toFixed(0)}%)"><div class="progress-bar" style="width: ${progress}%;"></div></div></td><td>${prazoDate}</td><td class="hidden-print"><div style="display:flex; gap: 5px;"><button class="btn ghost btn-edit" data-id="${ppap.id}" style="padding:4px 8px; font-size:12px;">Editar</button><button class="btn ghost btn-delete" data-id="${ppap.id}" style="padding:4px 8px; font-size:12px;">Excluir</button></div></td>`;
                });
            }
            ppapCountSpan.textContent = ppaps.length;
        };
        
        const renderPpapItems = (itemsData = []) => {
            ppapItemsContainer.innerHTML = '';
            PPAP_ELEMENTS.forEach((name, index) => {
                const itemData = itemsData[index] || { name, status: 'pendente', attachments: [] };
                const clone = ppapItemTemplate.content.cloneNode(true);
                const itemDiv = clone.querySelector('.ppap-item');
                itemDiv.dataset.index = index; itemDiv.querySelector('label').textContent = name; itemDiv.querySelector('.item-status').value = itemData.status;
                const attachmentsContainer = itemDiv.querySelector('.attachments-section');
                attachmentsContainer.appendChild(attachmentUiTemplate.content.cloneNode(true));
                if (itemData.attachments && itemData.attachments.length > 0){ attachmentsContainer.classList.remove('hidden'); const grid = attachmentsContainer.querySelector('.attachment-preview-grid'); itemData.attachments.forEach(att => addAttachmentPreview(grid, att)); }
                ppapItemsContainer.appendChild(clone);
            });
            updateProgress();
        };

        const renderActionPlans = (plansData = []) => {
            actionPlanFormContainer.innerHTML = '';
            if (!plansData || plansData.length === 0) return;
            plansData.forEach(plan => {
                const clone = actionPlanFormTemplate.content.cloneNode(true);
                const block = clone.querySelector('.action-item-block');
                block.querySelector('.action-input').value = plan.action || ''; block.querySelector('.responsible-input').value = plan.responsible || ''; block.querySelector('.status-input').value = plan.status || 'aberto'; block.querySelector('.start-date-input').value = plan.startDate || ''; block.querySelector('.end-date-input').value = plan.endDate || '';
                const attachmentsContainer = block.querySelector('.attachments-section');
                attachmentsContainer.appendChild(attachmentUiTemplate.content.cloneNode(true));
                if (plan.attachments && plan.attachments.length > 0) { const grid = attachmentsContainer.querySelector('.attachment-preview-grid'); plan.attachments.forEach(att => addAttachmentPreview(grid, att)); }
                actionPlanFormContainer.appendChild(clone);
            });
        };
        
        const updateProgress = () => {
            const items = ppapItemsContainer.querySelectorAll('.ppap-item');
            const statuses = Array.from(items).map(item => item.querySelector('.item-status').value);
            const applicableItems = statuses.filter(s => s !== 'na');
            const completedItems = applicableItems.filter(s => s === 'concluido');
            const progress = applicableItems.length > 0 ? (completedItems.length / applicableItems.length) * 100 : 0;
            progressBar.style.width = `${progress}%`;
            progressSummary.textContent = `${completedItems.length}/${applicableItems.length} (${progress.toFixed(0)}%)`;
        };
        
        const addAttachmentPreview = (gridContainer, fileData) => {
            const previewItem = document.createElement('div');
            previewItem.className = 'attachment-item';
            previewItem.dataset.fileName = fileData.name; previewItem.dataset.fileData = fileData.data; previewItem.dataset.fileType = fileData.type;
            let previewContent = (fileData.type && fileData.type.startsWith('image/')) ? `<img src="${fileData.data}" alt="${fileData.name}" title="${fileData.name}">` : `<div class="file-icon" title="${fileData.name}"><span>üìÑ</span>${fileData.name}</div>`;
            previewItem.innerHTML = `${previewContent}<button type="button" class="remove-attachment">&times;</button>`;
            gridContainer.appendChild(previewItem);
        };

        const handleFiles = (files, container) => {
            const grid = container.querySelector('.attachment-preview-grid');
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) { showToast(`Arquivo "${file.name}" √© maior que 5MB.`, 'error'); continue; }
                const reader = new FileReader();
                reader.onload = (e) => addAttachmentPreview(grid, { name: file.name, type: file.type, data: e.target.result });
                reader.readAsDataURL(file);
            }
        };

        const getAttachmentsFromContainer = (container) => {
            const attachments = [];
            container.querySelectorAll('.attachment-item').forEach(item => attachments.push({ name: item.dataset.fileName, type: item.dataset.fileType, data: item.dataset.fileData }));
            return attachments;
        };

        btnNewPpap.addEventListener('click', () => {
            form.reset(); document.getElementById('ppap-id').value = ''; document.getElementById('data-inicial').value = new Date().toISOString().slice(0,10);
            renderPpapItems(); renderActionPlans(); geralStatusSelect.dispatchEvent(new Event('change'));
            showForm();
        });

        btnAddActionPlan.addEventListener('click', () => {
            const clone = actionPlanFormTemplate.content.cloneNode(true);
            const attachmentsContainer = clone.querySelector('.attachments-section');
            attachmentsContainer.appendChild(attachmentUiTemplate.content.cloneNode(true));
            actionPlanFormContainer.appendChild(clone);
        });

        btnCancel.addEventListener('click', showDashboard);
        geralStatusSelect.addEventListener('change', e => novaDataContainer.classList.toggle('hidden', e.target.value !== 'atrasado'));
        main.addEventListener('click', e => {
            const target = e.target;
            if (target.classList.contains('btn-toggle-attachments')) { target.closest('.ppap-item').querySelector('.attachments-section').classList.toggle('hidden'); } 
            else if (target.classList.contains('remove-action-btn')) { target.closest('.action-item-block').remove(); } 
            else if (target.classList.contains('attachment-drop-zone')) { target.previousElementSibling.click(); } 
            else if (target.classList.contains('remove-attachment')) { target.closest('.attachment-item').remove(); }
            else if (target.classList.contains('btn-delete')){ if(confirm('Tem certeza?')) { ppaps = ppaps.filter(p => p.id != target.dataset.id); saveData(); renderPpapList(); } } 
            else if (target.classList.contains('btn-edit')){
                const ppap = ppaps.find(p => p.id == target.dataset.id);
                if (ppap) {
                    form.reset();
                    document.getElementById('ppap-id').value = ppap.id;
                    document.getElementById('part-name').value = ppap.partName || ''; document.getElementById('part-number').value = ppap.partNumber || '';
                    document.getElementById('supplier-name').value = ppap.supplierName || ''; document.getElementById('supplier-code').value = ppap.supplierCode || '';
                    document.getElementById('data-inicial').value = ppap.dataInicial || ''; document.getElementById('data-prazo').value = ppap.dataPrazo || '';
                    document.getElementById('geral-status').value = ppap.geralStatus || 'aberto'; document.getElementById('nova-data').value = ppap.novaData || '';
                    geralStatusSelect.dispatchEvent(new Event('change'));
                    renderPpapItems(ppap.items); renderActionPlans(ppap.actionPlans);
                    showForm();
                }
            }
        });

        main.addEventListener('change', e => {
            if (e.target.classList.contains('item-status')) { updateProgress(); } 
            else if (e.target.classList.contains('attachments-input')) { handleFiles(e.target.files, e.target.closest('.field, .attachments-section')); }
        });
        
        form.addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('ppap-id').value;
            const itemsData = [];
            ppapItemsContainer.querySelectorAll('.ppap-item').forEach(item => { itemsData.push({ name: item.querySelector('label').textContent, status: item.querySelector('.item-status').value, attachments: getAttachmentsFromContainer(item.querySelector('.attachments-section')) }); });
            const actionPlansData = [];
            actionPlanFormContainer.querySelectorAll('.action-item-block').forEach(block => { actionPlansData.push({ action: block.querySelector('.action-input').value, responsible: block.querySelector('.responsible-input').value, status: block.querySelector('.status-input').value, startDate: block.querySelector('.start-date-input').value, endDate: block.querySelector('.end-date-input').value, attachments: getAttachmentsFromContainer(block.querySelector('.attachments-section')) }); });
            const ppapData = {
                id: id ? parseInt(id) : Date.now(),
                partName: document.getElementById('part-name').value, partNumber: document.getElementById('part-number').value,
                supplierName: document.getElementById('supplier-name').value, supplierCode: document.getElementById('supplier-code').value,
                dataInicial: document.getElementById('data-inicial').value, dataPrazo: document.getElementById('data-prazo').value,
                geralStatus: document.getElementById('geral-status').value, novaData: document.getElementById('nova-data').value,
                items: itemsData, actionPlans: actionPlansData
            };
            if (id) { const index = ppaps.findIndex(p => p.id == id); if (index > -1) { ppaps[index] = ppapData; } } 
            else { ppaps.push(ppapData); }
            saveData(); showToast('PPAP salvo com sucesso!', 'success'); showDashboard();
        });
        
        document.getElementById('btn-export-pdf').addEventListener('click', () => { if (!formContainer.classList.contains('active')) { showToast('Abra um PPAP para exportar.', 'info'); return; } window.print(); });
        document.getElementById('btn-download-backup').addEventListener('click', handleDownloadBackup);
        document.getElementById('btn-restore-backup').addEventListener('click', handleRestoreBackup);
        document.getElementById('btn-archive-and-clear').addEventListener('click', handleArchiveAndClear);

        loadData();
        showDashboard();
    });
    </script>
</body>
</html>