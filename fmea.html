<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Process & Quality - FMEA</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
      :root{
        --bg:#0f172a; --panel:#111827; --muted:#1f2937; --card:#0b1220; --text:#e5e7eb; --accent:#22d3ee; --accent2:#a78bfa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
        --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
        --status-iniciar: #6c757d; --status-iniciado: #0d6efd; --status-pausado: #fd7e14; --status-finalizado: #22c55e; --status-atraso: #ef4444;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial; background:linear-gradient(120deg,#0b1020,#0a1328); color:var(--text); display:grid; grid-template-columns:280px 1fr; grid-template-rows:auto 1fr; gap:0; }
      header{grid-column:1/3; display:flex; align-items:center; justify-content:space-between; padding:14px 20px; background:linear-gradient(90deg,#0b1020,#0a1a35); border-bottom:1px solid #1e293b; position:sticky; top:0; z-index:5}
      .header-title h1 { margin: 0; font-size: 20px; letter-spacing: .4px; color: var(--text); }
      .header-title .subtitle { margin: 4px 0 0 0; font-size: 14px; font-weight: normal; color: var(--accent); }
      .header-title .dev-credit { margin: 4px 0 0 0; font-size: 11px; font-weight: normal; color: #64748b; }
      header .actions{display:flex; flex-wrap: wrap; gap:8px}
      button, .btn{background:var(--muted); color:var(--text); border:1px solid #243041; border-radius:12px; padding:10px 14px; cursor:pointer; box-shadow:var(--shadow); transition:.2s; font-weight:600}
      button:hover, .btn:hover{transform:translateY(-1px); border-color:#334155}
      button.primary, .btn.primary{background:linear-gradient(180deg,#0ea5e9,#2563eb); border-color:transparent}
      button.ghost, .btn.ghost{background:transparent; border-color:#334155}
      aside{border-right:1px solid #1f2937; background:linear-gradient(180deg,#0b1020,#0a1328); padding:16px; display:flex; flex-direction:column; gap:24px; justify-content: space-between;}
      .menu{display:flex; flex-direction:column; gap:8px}
      .menu .tab-link{display:flex; gap:10px; align-items:center; text-decoration:none; color:#cbd5e1; padding:10px 12px; border:1px solid #1e293b; border-radius:12px; background:rgba(255,255,255,.02); cursor:pointer;}
      .menu .tab-link.active,.menu .tab-link:hover{border-color:#334155; background:rgba(34,211,238,.08); color:#e2e8f0}
      main{padding:18px; overflow:auto}
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      section{background:rgba(255,255,255,.03); border:1px solid #1f2937; border-radius:var(--radius); padding:16px; margin-bottom:18px; box-shadow:var(--shadow)}
      h2, h3{margin:0 0 12px 0; font-size:18px; color: var(--accent);}
      h4{margin:0 0 12px 0; font-size:16px; color: var(--accent2);}
      .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
      .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-2{grid-column:span 2} .col-12{grid-column:span 12}
      .field{display:flex; flex-direction:column; gap:6px}
      label{font-size:12px; color:#93c5fd}
      input, select, textarea{background:#0b1220; border:1px solid #243041; color:var(--text); padding:10px 12px; border-radius:10px; outline:none; font-family:inherit; font-size:14px;}
      textarea{min-height:72px}
      .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
      .section-header .remove-btn { background: none; border: none; color: var(--bad); font-size: 24px; cursor: pointer; padding:0; box-shadow: none; }
      .rpn-display { display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #0b1220; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #243041; height: 100%;}
      .rpn-display label { font-size: 12px; color: #93c5fd; }
      .rpn-display span { font-size: 24px; font-weight: bold; color: var(--accent2); }
      .actions-subsection { background: #0b1220; border:1px solid #243041; border-radius: 12px; padding: 12px; margin-top: 12px;}
      .actions-subsection h4 { margin:0 0 12px 0; font-size: 14px; color: var(--accent2);}
      .action-item { padding-top: 12px; border-top: 1px dashed #1f2b3f; position: relative;}
      .actions-container .action-item:first-child { border-top: none; padding-top: 0;}
      .remove-action-btn { position: absolute; top: 10px; right: 5px; background: none; border: none; color: #fca5a5; font-size: 1.2rem; cursor: pointer;}
      #record-counter { background:rgba(255,255,255,.02); border:1px solid #1e293b; border-radius: 12px; padding: 12px;}
      #record-counter p { margin: 8px 0; color: #cbd5e1; display: flex; justify-content: space-between; }
      #record-counter span { font-weight: bold; color: var(--accent); }
      .status-select { font-weight: bold; text-align: center; }
      .status-iniciar { background-color: var(--status-iniciar); color: white; }
      .status-iniciado { background-color: var(--status-iniciado); color: white; }
      .status-pausado { background-color: var(--status-pausado); color: white; }
      .status-finalizado { background-color: var(--status-finalizado); color: white; }
      .status-atraso { background-color: var(--status-atraso); color: white; }
      .help-content h3 { color: var(--accent2); margin-top: 24px; margin-bottom: 10px; border-bottom: 1px solid var(--muted); padding-bottom: 5px; font-size: 16px; }
      .help-content p, .help-content li { line-height: 1.6; color: var(--text); }
      .help-content ul { list-style-position: inside; padding-left: 10px; }
      .help-content code { background-color: var(--muted); padding: 2px 6px; border-radius: 4px; font-family: monospace; color: var(--accent); }
      #toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
      .toast { padding: 12px 18px; border-radius: 12px; color: white; font-weight: 600; font-size: 14px; box-shadow: var(--shadow); opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
      .toast.show { opacity: 1; transform: translateX(0); }
      .toast.success { background: linear-gradient(90deg, #22c55e, #16a34a); }
      .toast.error { background: linear-gradient(90deg, #ef4444, #dc2626); }
      .toast.info { background: linear-gradient(90deg, #3b82f6, #2563eb); }
      .hidden { display: none !important; }

      @media(max-width:980px){body{grid-template-columns:1fr} aside{display:none}}
      @media print {
        body { display: block; grid-template-columns: 1fr; }
        header, aside, .btn, .remove-btn, .remove-action-btn, .add-failure-mode-btn, #Ajuda, .hidden-print { display: none !important; }
        main { padding: 0; overflow: visible;}
        section { box-shadow: none; border: 1px solid #ccc; background: white; color: black; page-break-inside: avoid; }
        input, select, textarea { border: 1px solid #ccc; color: black; background: #f9f9f9;}
        label, h2, h3, h4, .rpn-display span { color: black !important; }
        .rpn-display { background: #eee; }
      }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="header-title">
            <h1>Eng Process & Quality</h1>
            <p class="subtitle">Formulário FMEA Avançado</p>
            <p class="dev-credit">Desenvolvido por Marcos Garçon</p>
        </div>
        <div class="actions">
            <button class="btn ghost" id="btn-restore-backup">Restaurar Backup</button>
            <button class="btn ghost" id="btn-download-backup">Baixar Backup (.json)</button>
            <button class="btn ghost" id="btn-archive-and-clear" style="color:var(--warn);">Arquivar e Limpar</button>
            <button class="btn primary" id="btn-export-pdf">Exportar PDF (Imprimir)</button>
        </div>
    </header>

    <aside>
        <div>
            <div class="menu">
                <a class="tab-link active" onclick="openTab(event, 'FMEA')">FMEA</a>
                <a class="tab-link" onclick="openTab(event, 'DFMEA')">DFMEA</a>
                <a class="tab-link" onclick="openTab(event, 'PFMEA')">PFMEA</a>
                <a class="tab-link" onclick="openTab(event, 'Ajuda')">Ajuda</a>
            </div>
        </div>
        <div id="record-counter">
            <h4>Registros</h4>
            <p>FMEA: <span id="fmea-count">0</span></p>
            <p>DFMEA: <span id="dfmea-count">0</span></p>
            <p>PFMEA: <span id="pfmea-count">0</span></p>
        </div>
    </aside>

    <main>
        <section>
             <div class="grid">
                <div class="col-3 field"><label for="projectName">Nome do Projeto/Produto</label><input type="text" id="projectName"></div>
                <div class="col-3 field"><label for="fmeaId">ID do FMEA</label><input type="text" id="fmeaId"></div>
                <div class="col-3 field"><label for="responsible">Responsável</label><input type="text" id="responsible"></div>
                <div class="col-3 field"><label for="startDate">Data de Início</label><input type="date" id="startDate"></div>
             </div>
        </section>

        <div id="FMEA" class="tab-content active">
            <div id="fmea-entries-container"></div>
            <button class="btn add-failure-mode-btn" data-type="FMEA" data-container="fmea-entries-container" data-template="fmea-template">+ Adicionar Análise FMEA</button>
        </div>
        <div id="DFMEA" class="tab-content">
            <div id="dfmea-entries-container"></div>
            <button class="btn add-failure-mode-btn" data-type="DFMEA" data-container="dfmea-entries-container" data-template="fmea-template">+ Adicionar Análise DFMEA</button>
        </div>
        <div id="PFMEA" class="tab-content">
            <div id="pfmea-entries-container"></div>
            <button class="btn add-failure-mode-btn" data-type="PFMEA" data-container="pfmea-entries-container" data-template="fmea-template">+ Adicionar Análise PFMEA</button>
        </div>
        <div id="Ajuda" class="tab-content">
            <section class="help-content">
                <h2>Guia de Utilização do Formulário FMEA</h2>
                <h3>Visão Geral</h3>
                <p>Esta ferramenta facilita a criação, gerenciamento e documentação de Análises de Modo e Efeitos de Falha (FMEA), permitindo salvar seu progresso e exportar os dados.</p>
                <h3>Realizando uma Análise</h3>
                <ul>
                    <li><strong>Adicionar Análise:</strong> Em cada aba (FMEA, DFMEA, PFMEA), clique no botão <code>+ Adicionar Análise</code> para criar um novo cartão de análise.</li>
                    <li><strong>Cálculo de RPN:</strong> Ao preencher os campos <code>S</code> (Severidade), <code>O</code> (Ocorrência) e <code>D</code> (Detecção), o valor do <strong>RPN</strong> (Número de Prioridade de Risco) é calculado automaticamente.</li>
                </ul>
                <h3>Funcionalidades Avançadas</h3>
                <ul>
                    <li><code>Backup (.json)</code>: Salva e restaura <strong>todo</strong> o conteúdo do formulário em um arquivo de segurança.</li>
                    <li><code>Arquivar e Limpar</code>: Baixa um backup completo e limpa os dados do navegador para manter a performance.</li>
                </ul>
            </section>
        </div>
    </main>

    <template id="action-template">
        <div class="action-item">
             <button class="remove-action-btn" title="Remover esta ação">&times;</button>
             <div class="grid">
                <div class="col-12 field"><label>Ação Proposta</label><textarea rows="2" data-field="actionProposed"></textarea></div>
                <div class="col-3 field"><label>Responsável</label><input type="text" data-field="actionResponsible"></div>
                <div class="col-3 field"><label>Data Início</label><input type="date" data-field="actionStartDate"></div>
                <div class="col-3 field"><label>Prazo Final</label><input type="date" data-field="actionDueDate"></div>
                <div class="col-3 field"><label>Novo Prazo</label><input type="date" data-field="actionNewDueDate"></div>
                <div class="col-12 field"><label>Evolução e Itens Concluídos</label><textarea rows="3" placeholder="Registre o andamento..." data-field="actionProgress"></textarea></div>
             </div>
        </div>
    </template>
    
    <template id="fmea-template">
        <section class="fmea-entry">
            <div class="section-header">
                <h3>Análise de Falha</h3>
                <button class="remove-btn remove-failure-mode-btn">&times;</button>
            </div>
            <div class="grid">
                <div class="col-12 field"><label>Item / Função do Processo</label><textarea rows="2" data-field="itemFunction"></textarea></div>
                <div class="col-3 field"><label>Modo de Falha Potencial</label><textarea rows="3" data-field="failureMode"></textarea></div>
                <div class="col-3 field"><label>Efeitos Potenciais da Falha</label><textarea rows="3" data-field="failureEffects"></textarea></div>
                <div class="col-3 field"><label>Causa(s) Potencial(is)</label><textarea rows="3" data-field="failureCauses"></textarea></div>
                <div class="col-3 field"><label>Detecção (Controles Atuais)</label><textarea rows="3" data-field="currentControls"></textarea></div>
                <div class="col-6 grid">
                    <div class="col-3 field"><label>Severidade (S)</label><input type="number" class="risk-input s" min="1" max="10" data-field="severity"></div>
                    <div class="col-3 field"><label>Ocorrência (O)</label><input type="number" class="risk-input o" min="1" max="10" data-field="occurrence"></div>
                    <div class="col-3 field"><label>Detecção (D)</label><input type="number" class="risk-input d" min="1" max="10" data-field="detection"></div>
                    <div class="col-3"><div class="rpn-display"><label>RPN</label><span class="rpn-value">0</span></div></div>
                </div>
                <div class="col-3 field"><label>Prioridade de Ação (AP)</label><select data-field="actionPriority"><option>Baixa</option><option>Média</option><option>Alta</option></select></div>
                <div class="col-3 field"><label>Status Geral</label><select class="status-select status-iniciar" data-field="status"><option class="status-iniciar" value="iniciar">A Iniciar</option><option class="status-iniciado" value="iniciado">Iniciado</option><option class="status-pausado" value="pausado">Pausado</option><option class="status-finalizado" value="finalizado">Finalizado</option><option class="status-atraso" value="atraso">Em Atraso</option></select></div>
                <div class="col-12 actions-subsection">
                    <h4>Ações Recomendadas</h4>
                    <div class="actions-container"></div>
                    <button class="btn ghost add-action-btn" style="width:100%; margin-top:10px;">+ Adicionar Ação</button>
                </div>
            </div>
        </section>
    </template>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & DBs ---
        const DB_KEY = 'mg_fmea_v2';

        // --- DOM ELEMENTS ---
        const mainContainer = document.querySelector('main');

        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        };
        
        const saveData = () => { try { localStorage.setItem(DB_KEY, JSON.stringify(gatherFormData())); } catch (e) { showToast('Erro ao salvar.', 'error'); } };
        const loadData = () => { const data = JSON.parse(localStorage.getItem(DB_KEY)); if (data) { populateForm(data); } };
        
        const handleDownloadBackup = () => { const blob = new Blob([JSON.stringify(gatherFormData(), null, 2)], { type: 'application/json' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `fmea_backup_${new Date().toISOString().slice(0, 10)}.json`; link.click(); URL.revokeObjectURL(link.href); };
        const handleRestoreBackup = () => { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = event => { try { const data = JSON.parse(event.target.result); populateForm(data); saveData(); showToast('Backup restaurado!', 'success'); } catch (error) { showToast('Arquivo de backup inválido.', 'error'); } }; reader.readAsText(file); } }; input.click(); };
        const handleArchiveAndClear = () => { if (confirm("ATENÇÃO: Isso irá baixar um backup e depois APAGAR os dados do navegador. Deseja continuar?")) { handleDownloadBackup(); localStorage.removeItem(DB_KEY); showToast("Dados arquivados e limpos.", "info"); setTimeout(() => window.location.reload(), 2000); } };
        
        window.openTab = (evt, tabName) => { document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove('active')); document.querySelectorAll(".tab-link").forEach(link => link.classList.remove('active')); document.getElementById(tabName).classList.add('active'); evt.currentTarget.classList.add('active'); };

        function updateRpn(card) { const s = card.querySelector('.s').value || 0; const o = card.querySelector('.o').value || 0; const d = card.querySelector('.d').value || 0; card.querySelector('.rpn-value').textContent = s * o * d; }
        function updateStatusColor(selectElement) { selectElement.className = 'status-select'; selectElement.classList.add(`status-${selectElement.value}`); }
        function updateRecordCount() { const fmeaCount = document.querySelectorAll('#fmea-entries-container .fmea-entry').length; const dfmeaCount = document.querySelectorAll('#dfmea-entries-container .fmea-entry').length; const pfmeaCount = document.querySelectorAll('#pfmea-entries-container .fmea-entry').length; document.getElementById('fmea-count').textContent = fmeaCount; document.getElementById('dfmea-count').textContent = dfmeaCount; document.getElementById('pfmea-count').textContent = pfmeaCount; }

        mainContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('add-failure-mode-btn')) {
                const container = document.getElementById(e.target.dataset.container);
                const template = document.getElementById(e.target.dataset.template);
                if (template && container) { const clone = template.content.cloneNode(true); clone.querySelector('section.fmea-entry').dataset.fmeaType = e.target.dataset.type; container.appendChild(clone); updateRecordCount(); }
            }
            if (e.target.classList.contains('remove-failure-mode-btn')) { e.target.closest('section.fmea-entry').remove(); updateRecordCount(); }
            if (e.target.classList.contains('add-action-btn')) { const actionTemplate = document.getElementById('action-template'); const actionsContainer = e.target.previousElementSibling; if (actionTemplate && actionsContainer) { actionsContainer.appendChild(actionTemplate.content.cloneNode(true)); } }
            if (e.target.classList.contains('remove-action-btn')) { e.target.closest('.action-item').remove(); }
        });

        mainContainer.addEventListener('input', function(e) {
            if (e.target.classList.contains('risk-input')) { updateRpn(e.target.closest('section.fmea-entry')); }
            if (e.target.classList.contains('status-select')) { updateStatusColor(e.target); }
            saveData();
        });

        function gatherFormData() {
            const data = { header: {}, entries: {} };
            document.querySelectorAll('#projectName, #fmeaId, #responsible, #startDate').forEach(el => { data.header[el.id] = el.value; });
            ['FMEA', 'DFMEA', 'PFMEA'].forEach(type => {
                data.entries[type] = [];
                document.querySelectorAll(`#${type.toLowerCase()}-entries-container section.fmea-entry`).forEach(card => {
                    const entry = { fields: {}, actions: [] };
                    card.querySelectorAll('[data-field]').forEach(field => { entry.fields[field.dataset.field] = field.value; });
                    card.querySelectorAll('.action-item').forEach(actionItem => { const action = {}; actionItem.querySelectorAll('[data-field]').forEach(actionField => { action[actionField.dataset.field] = actionField.value; }); entry.actions.push(action); });
                    data.entries[type].push(entry);
                });
            });
            return data;
        }

        function populateForm(data) {
            ['fmea', 'dfmea', 'pfmea'].forEach(type => { document.getElementById(`${type}-entries-container`).innerHTML = ''; });
            if (data.header) { for (const key in data.header) { const el = document.getElementById(key); if (el) el.value = data.header[key]; } }
            if (data.entries) {
                for (const type in data.entries) {
                    const container = document.getElementById(`${type.toLowerCase()}-entries-container`);
                    const template = document.getElementById('fmea-template');
                    const actionTemplate = document.getElementById('action-template');
                    if(container && data.entries[type]){
                        data.entries[type].forEach(entryData => {
                            const clone = template.content.cloneNode(true);
                            const card = clone.querySelector('section.fmea-entry');
                            card.dataset.fmeaType = type;
                            for (const fieldKey in entryData.fields) { const fieldEl = card.querySelector(`[data-field="${fieldKey}"]`); if (fieldEl) fieldEl.value = entryData.fields[fieldKey]; }
                            const actionsContainer = card.querySelector('.actions-container');
                            if (entryData.actions) {
                                entryData.actions.forEach(actionData => {
                                    const actionClone = actionTemplate.content.cloneNode(true);
                                    for(const actionKey in actionData){ const actionFieldEl = actionClone.querySelector(`[data-field="${actionKey}"]`); if(actionFieldEl) actionFieldEl.value = actionData[actionKey]; }
                                    actionsContainer.appendChild(actionClone);
                                });
                            }
                            container.appendChild(clone);
                            const newCardInDom = container.lastElementChild;
                            updateRpn(newCardInDom);
                            updateStatusColor(newCardInDom.querySelector('.status-select'));
                        });
                    }
                }
            }
            updateRecordCount();
        }

        // --- INITIALIZATION ---
        const initApp = () => {
            loadData();
            updateRecordCount();
        };

        document.getElementById('btn-download-backup').addEventListener('click', handleDownloadBackup);
        document.getElementById('btn-restore-backup').addEventListener('click', handleRestoreBackup);
        document.getElementById('btn-archive-and-clear').addEventListener('click', handleArchiveAndClear);
        document.getElementById('btn-export-pdf').addEventListener('click', () => window.print());
        
        initApp();
    });
    </script>
</body>
</html>