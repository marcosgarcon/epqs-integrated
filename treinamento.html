<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Process & Quality - Gerenciamento de Treinamentos</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--bg:#0f172a;--panel:#111827;--muted:#1f2937;--card:#0b1220;--text:#e5e7eb;--accent:#22d3ee;--accent2:#a78bfa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--shadow:0 10px 30px rgba(0,0,0,.35);--radius:16px;}
        *{box-sizing:border-box}
        html,body{height:100%}
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial;background:linear-gradient(120deg,#0b1020,#0a1328);color:var(--text);display:grid;grid-template-columns:280px 1fr;grid-template-rows:auto 1fr;gap:0;}
        
        header{grid-column:1/3;display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(90deg,#0b1020,#0a1a35);border-bottom:1px solid #1e293b;position:sticky;top:0;z-index:5}
        .header-title h1{margin:0;font-size:20px;letter-spacing:.4px;color:var(--text);}.header-title .subtitle{margin:4px 0 0 0;font-size:14px;font-weight:normal;color:var(--accent);}.header-title .dev-credit{margin:4px 0 0 0;font-size:11px;font-weight:normal;color:#64748b;}
        header .actions{display:flex;flex-wrap:wrap;gap:8px}
        
        button, .btn{background:var(--muted);color:var(--text);border:1px solid #243041;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow);transition:.2s;font-weight:600}
        button:hover, .btn:hover{transform:translateY(-1px);border-color:#334155}
        button.primary, .btn.primary{background:linear-gradient(180deg,#0ea5e9,#2563eb);border-color:transparent}
        button.ghost, .btn.ghost{background:transparent;border-color:#334155}
        
        aside{border-right:1px solid #1f2937;background:linear-gradient(180deg,#0b1020,#0a1328);padding:16px;display:flex;flex-direction:column;gap:24px;justify-content:space-between;}
        .menu{display:flex;flex-direction:column;gap:8px}
        .menu a{display:flex;gap:10px;align-items:center;text-decoration:none;color:#cbd5e1;padding:10px 12px;border:1px solid #1e293b;border-radius:12px;background:rgba(255,255,255,.02);cursor:pointer;}
        .menu a.active, .menu a:hover{border-color:#334155;background:rgba(34,211,238,.08);color:#e2e8f0}
        
        main{padding:18px;overflow:auto}
        .hidden, .tab-content.hidden{display:none !important}
        section{background:rgba(255,255,255,.03);border:1px solid #1f2937;border-radius:var(--radius);padding:20px;margin-bottom:20px;box-shadow:var(--shadow)}
        h2, h3, h4{margin:0 0 12px 0;color:var(--accent);} h4{color:var(--accent2)}
        .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));}
        .field{display:flex;flex-direction:column;gap:6px}
        label{font-size:12px;color:#93c5fd}
        input, select, textarea{background:#0b1220;border:1px solid #243041;color:var(--text);padding:10px 12px;border-radius:10px;outline:none;font-family:inherit;font-size:14px;min-height:44px}
        table{width:100%;border-collapse:collapse;} th, td{padding:10px 12px;border-bottom:1px solid var(--muted);text-align:left;font-size:14px;vertical-align:middle;} th{background:rgba(255,255,255,.05);font-size:12px;color:#94a3b8;}
        .kpi-card{background:var(--card);border-radius:var(--radius);padding:16px;text-align:center;}
        .kpi-card h3{font-size:12px;color:var(--accent2);margin:0 0 8px 0;font-weight:normal;text-transform:uppercase;}
        .kpi-card .kpi-value{font-size:2rem;font-weight:bold;color:var(--accent);}
        .kpi-card .kpi-subvalue{font-size:0.9rem;color:var(--text);margin-top:4px;}
        #record-counter{background:rgba(255,255,255,.02);border:1px solid #1e293b;border-radius:12px;padding:12px;} #record-counter p{margin:8px 0;color:#cbd5e1;display:flex;justify-content:space-between;} #record-counter span{font-weight:bold;color:var(--accent);}
        .toast-container{position:fixed;top:20px;right:20px;z-index:200;display:flex;flex-direction:column;gap:10px;}
        .toast{padding:12px 18px;border-radius:12px;color:white;font-weight:600;font-size:14px;box-shadow:var(--shadow);opacity:0;transform:translateX(100%);transition:all 0.4s ease;}
        .toast.show{opacity:1;transform:translateX(0);}.toast.success{background:linear-gradient(90deg,#22c55e,#16a34a);}.toast.error{background:linear-gradient(90deg,#ef4444,#dc2626);}.toast.info{background:linear-gradient(90deg,#3b82f6,#2563eb);}
        .participant-entry { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 8px; border: 1px solid var(--muted); padding: 8px; border-radius: 10px;}
        .participant-entry .field { flex-basis: calc(25% - 8px); min-width: 120px; margin-bottom: 0; }
        .participant-entry .field.full-width { flex-basis: 100%; }
        .participant-entry button { margin-left: auto; }
        .add-participant-btn { margin-top: 10px; }
        @media (max-width: 768px) {
            .participant-entry .field { flex-basis: calc(50% - 8px); }
            .participant-entry .field:nth-child(1), .participant-entry .field:nth-child(2) { flex-basis: calc(50% - 8px); }
        }
        @media (max-width: 480px) {
            .participant-entry .field { flex-basis: 100%; }
            .participant-entry button { margin-left: 0; width: 100%; }
        }
        @media print{body{grid-template-columns:1fr;color:#000;background:#fff;}header,aside,.hidden-print,.btn{display:none!important;}main{padding:0;}section{border:1px solid #ccc;box-shadow:none;background:#fff;page-break-inside:avoid;}h2,h3,h4,label,p{color:black;}}
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="header-title">
            <h1>Eng Process & Quality</h1>
            <p class="subtitle">Gerenciamento de Treinamentos</p>
            <p class="dev-credit">Desenvolvido por Marcos Garçon</p>
        </div>
        <div class="actions">
            <button class="btn ghost" id="btn-restore-backup"><i class="ph-bold ph-upload"></i> Restaurar Dados</button>
            <button class="btn ghost" id="btn-download-backup"><i class="ph-bold ph-download"></i> Baixar Backup</button>
            <button class="btn ghost" id="btn-clear-all-data" style="color:var(--warn);"><i class="ph-bold ph-trash"></i> Limpar Tudo</button>
            <button class="btn primary" id="btn-export-pdf">Exportar PDF</button>
        </div>
    </header>
    <aside>
        <div>
            <div class="menu">
                <a class="tab-link active" onclick="openTab(event, 'dashboard-container')"><i class="ph-bold ph-columns"></i> Dashboard</a>
                <a class="tab-link" onclick="openTab(event, 'treinamentos-container')"><i class="ph-bold ph-chalkboard-teacher"></i> Gerenciar Treinamentos</a>
            </div>
        </div>
        <div id="record-counter"><p>Treinamentos Salvos: <span id="training-count">0</span></p></div>
    </aside>
    <main>
        <div id="dashboard-container" class="tab-content">
            <section>
                <h2>Dashboard de Treinamentos</h2>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="kpi-card"><h3>Total de Treinamentos Realizados</h3><p id="kpi-total-trainings" class="kpi-value">0</p></div>
                    <div class="kpi-card"><h3>Total de Participantes (Ind.)</h3><p id="kpi-total-participants" class="kpi-value">0</p></div>
                    <div class="kpi-card"><h3>Média de Participantes/Treinamento</h3><p id="kpi-avg-participants" class="kpi-value">0</p></div>
                    <div class="kpi-card"><h3>Média de Aproveitamento</h3><p id="kpi-avg-score" class="kpi-value">0%</p></div>
                    <div class="kpi-card"><h3>Treinamento Mais Frequente</h3><p id="kpi-top-training" class="kpi-value" style="font-size: 1.5rem;">-</p></div>
                    <div class="kpi-card"><h3>Treinador Mais Ativo</h3><p id="kpi-top-trainer" class="kpi-value" style="font-size: 1.5rem;">-</p></div>
                    <div class="kpi-card"><h3>Setor com Mais Treinamentos</h3><p id="kpi-top-sector" class="kpi-value" style="font-size: 1.5rem;">-</p></div>
                    <div class="kpi-card"><h3>Turno com Mais Treinamentos</h3><p id="kpi-top-shift" class="kpi-value" style="font-size: 1.5rem;">-</p></div>
                </div>
            </section>
            <section>
                <h4>Participantes por Mês</h4>
                <div style="position: relative; min-height: 300px; width: 100%;">
                    <canvas id="participants-by-month-chart"></canvas>
                </div>
            </section>
             <section>
                <h4>Aproveitamento Médio por Setor</h4>
                <div style="position: relative; min-height: 300px; width: 100%;">
                    <canvas id="score-by-sector-chart"></canvas>
                </div>
            </section>
        </div>

        <div id="treinamentos-container" class="tab-content hidden">
            <section>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h2>Treinamentos Cadastrados</h2>
                    <button id="btn-new-training" class="btn primary">Novo Treinamento</button>
                </div>
                <table id="training-list-table">
                    <thead><tr><th>Tema</th><th>Treinador</th><th>Data</th><th>Nº Participantes</th><th class="hidden-print">Ações</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>

        <div id="form-container" class="tab-content hidden">
            <form id="training-form">
                <input type="hidden" id="training-id">
                <section>
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <h2 id="form-title">Novo Treinamento</h2>
                        <button type="button" id="btn-back-to-list" class="btn ghost">Voltar à Lista</button>
                    </div>
                    <div class="grid">
                        <div class="field" style="grid-column: span 2;"><label for="training-theme">Tema do Treinamento</label><input type="text" id="training-theme" placeholder="Ex: Boas Práticas de Fabricação" required></div>
                        <div class="field"><label for="training-trainer">Treinador</label><input type="text" id="training-trainer" placeholder="Nome do Treinador"></div>
                        <div class="field"><label for="training-date">Data do Treinamento</label><input type="date" id="training-date" required></div>
                        <div class="field"><label for="training-load">Carga Horária do Treinamento (h)</label><input type="number" id="training-load" min="0" value="1" required></div>
                        <div class="field" style="grid-column: span 2;"><label for="training-description">Descrição</label><textarea id="training-description" rows="3" placeholder="Breve descrição ou observações"></textarea></div>
                    </div>
                </section>

                <section>
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <h4>Lista de Participantes</h4>
                        <button type="button" id="btn-add-participant" class="btn ghost add-participant-btn" style="padding: 6px 10px;"><i class="ph-bold ph-plus-circle"></i> Adicionar Participante</button>
                    </div>
                    <div id="participants-list">
                        <p id="no-participants-message" style="color:var(--muted); font-size:0.9em;">Nenhum participante adicionado ainda.</p>
                    </div>
                </section>

                <div class="hidden-print" style="display:flex;justify-content:flex-end;margin-top:20px;">
                    <button type="submit" class="btn primary">Salvar Treinamento</button>
                </div>
            </form>
        </div>
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const DB_KEY = 'mg_treinamento_records_v2'; 
        let trainingRecords = [];
        let participantsChart = null;
        let scoreBySectorChart = null; 

        const trainingListBody = document.querySelector('#training-list-table tbody');
        const trainingCountSpan = document.getElementById('training-count');
        const trainingForm = document.getElementById('training-form');
        const participantsListDiv = document.getElementById('participants-list');
        const noParticipantsMessage = document.getElementById('no-participants-message');

        const showToast = (message, type = 'info') => { 
            const c=document.getElementById('toast-container');
            const t=document.createElement('div');
            t.className=`toast ${type}`;
            t.textContent=message;
            c.appendChild(t);
            setTimeout(()=>t.classList.add('show'),10);
            setTimeout(()=>{t.classList.remove('show');t.addEventListener('transitionend',()=>t.remove())},4000);
        };

        const saveData = () => { 
            try { 
                localStorage.setItem(DB_KEY, JSON.stringify(trainingRecords)); 
            } catch (e) { 
                showToast('Erro ao salvar os dados de treinamento.', 'error'); 
            } 
        };
        const loadData = () => { trainingRecords = JSON.parse(localStorage.getItem(DB_KEY)) || []; };

        window.openTab = (evt, tabId) => {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.menu a').forEach(a => a.classList.remove('active'));
            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active');
            } else { 
                const link = document.querySelector(`.menu a[onclick*="${tabId}"]`);
                if (link) link.classList.add('active');
            }
            if (tabId === 'dashboard-container') renderDashboard();
            if (tabId === 'treinamentos-container') renderTrainingList();
        };

        const renderTrainingList = () => {
            trainingListBody.innerHTML = '';
            trainingCountSpan.textContent = trainingRecords.length;
            if (trainingRecords.length === 0) {
                trainingListBody.innerHTML = '<tr><td colspan="5">Nenhum treinamento salvo.</td></tr>';
                return;
            }
            trainingRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(record => {
                const totalParticipants = (record.individualParticipants || []).length;
                const row = trainingListBody.insertRow();
                row.innerHTML = `
                    <td>${record.theme}</td><td>${record.trainer || 'N/A'}</td>
                    <td>${new Date(record.date + 'T00:00:00').toLocaleDateString()}</td>
                    <td>${totalParticipants}</td>
                    <td class="hidden-print">
                        <button class="btn ghost btn-edit" data-id="${record.id}" style="padding:5px 10px">Editar</button>
                        <button class="btn ghost btn-delete" data-id="${record.id}" style="padding:5px 10px">Excluir</button>
                    </td>
                `;
            });
        };

        const renderDashboard = () => {
            const totalTrainings = trainingRecords.length;
            const allIndividualParticipants = trainingRecords.flatMap(record => record.individualParticipants || []);
            const totalParticipants = allIndividualParticipants.length;
            const avgParticipants = totalTrainings > 0 ? (totalParticipants / totalTrainings).toFixed(1) : 0;
            const totalScore = allIndividualParticipants.reduce((sum, p) => sum + (parseFloat(p.score) || 0), 0);
            const avgScore = totalParticipants > 0 ? (totalScore / totalParticipants).toFixed(1) : 0;

            document.getElementById('kpi-total-trainings').textContent = totalTrainings;
            document.getElementById('kpi-total-participants').textContent = totalParticipants;
            document.getElementById('kpi-avg-participants').textContent = avgParticipants;
            document.getElementById('kpi-avg-score').textContent = `${avgScore}%`;

            const themeCounts = trainingRecords.reduce((acc, r) => { acc[r.theme] = (acc[r.theme] || 0) + 1; return acc; }, {});
            const topTheme = Object.keys(themeCounts).length > 0 ? Object.entries(themeCounts).sort((a,b) => b[1] - a[1])[0][0] : '-';
            document.getElementById('kpi-top-training').textContent = topTheme;

            const trainerCounts = trainingRecords.reduce((acc, r) => { if (r.trainer) acc[r.trainer] = (acc[r.trainer] || 0) + 1; return acc; }, {});
            const topTrainer = Object.keys(trainerCounts).length > 0 ? Object.entries(trainerCounts).sort((a,b) => b[1] - a[1])[0][0] : '-';
            document.getElementById('kpi-top-trainer').textContent = topTrainer;

            const sectorTrainingCounts = trainingRecords.reduce((acc, r) => { const sectorsInTraining = [...new Set((r.individualParticipants || []).map(p => p.sector).filter(s => s))]; sectorsInTraining.forEach(sector => { acc[sector] = (acc[sector] || 0) + 1; }); return acc; }, {});
            const topSector = Object.keys(sectorTrainingCounts).length > 0 ? Object.entries(sectorTrainingCounts).sort((a,b) => b[1] - a[1])[0][0] : '-';
            document.getElementById('kpi-top-sector').textContent = topSector;

            const shiftTrainingCounts = trainingRecords.reduce((acc, r) => { const shiftsInTraining = [...new Set((r.individualParticipants || []).map(p => p.shift).filter(s => s))]; shiftsInTraining.forEach(shift => { acc[shift] = (acc[shift] || 0) + 1; }); return acc; }, {});
            const topShift = Object.keys(shiftTrainingCounts).length > 0 ? Object.entries(shiftTrainingCounts).sort((a,b) => b[1] - a[1])[0][0] + 'º Turno' : '-';
            document.getElementById('kpi-top-shift').textContent = topShift;

            renderParticipantsByMonthChart(allIndividualParticipants);
            renderScoreBySectorChart(allIndividualParticipants);
        };

        const renderParticipantsByMonthChart = (participantsData) => {
            if (participantsChart) participantsChart.destroy();
            const monthlyData = participantsData.reduce((acc, p) => { const date = new Date(p.date + 'T00:00:00'); const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`; acc[monthYear] = (acc[monthYear] || 0) + 1; return acc; }, {});
            const sortedMonths = Object.keys(monthlyData).sort((a, b) => { const [mA, yA] = a.split('/').map(Number); const [mB, yB] = b.split('/').map(Number); return (yA - yB) * 12 + (mA - mB); });
            const labels = sortedMonths;
            const data = sortedMonths.map(month => monthlyData[month]);
            const ctx = document.getElementById('participants-by-month-chart').getContext('2d');
            participantsChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Número de Participantes', data: data, backgroundColor: 'rgba(34, 211, 238, 0.8)', borderColor: 'rgba(34, 211, 238, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Participantes' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#e5e7eb' } }, x: { title: { display: true, text: 'Mês/Ano' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#e5e7eb' } } }, plugins: { legend: { labels: { color: '#e5e7eb' } } } } });
        };

        const renderScoreBySectorChart = (participantsData) => {
            if (scoreBySectorChart) scoreBySectorChart.destroy();
            const sectorScores = participantsData.reduce((acc, p) => {
                if (p.sector && p.score !== undefined && p.score !== null) {
                    acc[p.sector] = acc[p.sector] || { totalScore: 0, count: 0 };
                    acc[p.sector].totalScore += parseFloat(p.score);
                    acc[p.sector].count++;
                }
                return acc;
            }, {});
            const labels = Object.keys(sectorScores);
            const data = labels.map(sector => sectorScores[sector].count > 0 ? (sectorScores[sector].totalScore / sectorScores[sector].count).toFixed(1) : 0 );
            const ctx = document.getElementById('score-by-sector-chart').getContext('2d');
            scoreBySectorChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Aproveitamento Médio (%)', data: data, backgroundColor: 'rgba(167, 139, 250, 0.8)', borderColor: 'rgba(167, 139, 250, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, title: { display: true, text: 'Aproveitamento (%)' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#e5e7eb' } }, x: { title: { display: true, text: 'Setor' }, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#e5e7eb' } } }, plugins: { legend: { labels: { color: '#e5e7eb' } } } } });
        };

        const renderParticipantsInForm = (participants = []) => {
            participantsListDiv.innerHTML = '';
            noParticipantsMessage.classList.toggle('hidden', participants.length > 0);
            participants.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'participant-entry';
                div.dataset.index = index;
                div.innerHTML = `
                    <div class="field"><label>Nome</label><input type="text" value="${p.name || ''}" placeholder="Nome" data-field="name" required></div>
                    <div class="field"><label>Registro</label><input type="text" value="${p.registration || ''}" placeholder="Registro" data-field="registration" required></div>
                    <div class="field"><label>Setor</label><input type="text" value="${p.sector || ''}" placeholder="Setor" data-field="sector" required></div>
                    <div class="field"><label>Turno</label>
                        <select data-field="shift" required>
                            <option value="">Selecione</option>
                            <option value="1" ${p.shift == '1' ? 'selected' : ''}>1º</option>
                            <option value="2" ${p.shift == '2' ? 'selected' : ''}>2º</option>
                            <option value="3" ${p.shift == '3' ? 'selected' : ''}>3º</option>
                        </select>
                    </div>
                    <div class="field"><label>Data</label><input type="date" value="${p.date || ''}" data-field="date" required></div>
                    <div class="field"><label>Carga Horária (h)</label><input type="number" value="${p.hours || ''}" placeholder="Carga Horária" data-field="hours" min="0" required></div>
                    <div class="field"><label>Aproveitamento (%)</label><input type="number" value="${p.score || ''}" placeholder="0-100" data-field="score" min="0" max="100" required></div>
                    <button type="button" class="btn ghost btn-remove-participant"><i class="ph-bold ph-trash"></i></button>
                `;
                participantsListDiv.appendChild(div);
            });
        };

        const addParticipantToForm = () => {
            noParticipantsMessage.classList.add('hidden');
            const div = document.createElement('div');
            div.className = 'participant-entry';
            const index = participantsListDiv.children.length;
            div.dataset.index = index;
            div.innerHTML = `
                <div class="field"><label>Nome</label><input type="text" placeholder="Nome" data-field="name" required></div>
                <div class="field"><label>Registro</label><input type="text" placeholder="Registro" data-field="registration" required></div>
                <div class="field"><label>Setor</label><input type="text" placeholder="Setor" data-field="sector" required></div>
                <div class="field"><label>Turno</label>
                    <select data-field="shift" required>
                        <option value="">Selecione</option><option value="1">1º</option><option value="2">2º</option><option value="3">3º</option>
                    </select>
                </div>
                <div class="field"><label>Data</label><input type="date" value="${new Date().toISOString().slice(0, 10)}" data-field="date" required></div>
                <div class="field"><label>Carga Horária (h)</label><input type="number" placeholder="Carga Horária" data-field="hours" min="0" value="${document.getElementById('training-load').value || 1}" required></div>
                <div class="field"><label>Aproveitamento (%)</label><input type="number" placeholder="0-100" data-field="score" min="0" max="100" value="0" required></div>
                <button type="button" class="btn ghost btn-remove-participant"><i class="ph-bold ph-trash"></i></button>
            `;
            participantsListDiv.appendChild(div);
            div.querySelector('[data-field="name"]').focus();
        };

        const populateForm = (record = {}) => {
            trainingForm.reset();
            document.getElementById('training-id').value = record.id || '';
            document.getElementById('training-theme').value = record.theme || '';
            document.getElementById('training-trainer').value = record.trainer || '';
            document.getElementById('training-date').value = record.date || new Date().toISOString().slice(0, 10);
            document.getElementById('training-load').value = record.load || 1; 
            document.getElementById('training-description').value = record.description || '';
            document.getElementById('form-title').textContent = record.id ? 'Editar Treinamento' : 'Novo Treinamento';
            renderParticipantsInForm(record.individualParticipants || []);
            openTab(null, 'form-container');
        };

        // --- Event Listeners ---
        document.getElementById('btn-new-training').addEventListener('click', () => populateForm());
        document.getElementById('btn-back-to-list').addEventListener('click', () => openTab(null, 'treinamentos-container'));
        document.getElementById('btn-add-participant').addEventListener('click', addParticipantToForm);

        participantsListDiv.addEventListener('click', e => {
            if (e.target.closest('.btn-remove-participant')) {
                const entry = e.target.closest('.participant-entry');
                entry.remove();
                if (participantsListDiv.children.length === 1) {
                    noParticipantsMessage.classList.remove('hidden');
                }
            }
        });

        trainingForm.addEventListener('submit', e => {
            e.preventDefault();
            const individualParticipants = [];
            let allParticipantsValid = true;
            participantsListDiv.querySelectorAll('.participant-entry').forEach(entry => {
                const pData = {};
                entry.querySelectorAll('[data-field]').forEach(input => pData[input.dataset.field] = input.value);
                if (Object.values(pData).some(v => v === '')) { allParticipantsValid = false; }
                individualParticipants.push(pData);
            });
            if (!allParticipantsValid) { return showToast('Preencha todos os campos dos participantes.', 'warn'); }
            if (individualParticipants.length === 0) { return showToast('Adicione pelo menos um participante.', 'warn'); }

            const id = document.getElementById('training-id').value;
            const recordData = {
                id: id ? parseInt(id) : Date.now(),
                theme: document.getElementById('training-theme').value,
                trainer: document.getElementById('training-trainer').value,
                date: document.getElementById('training-date').value,
                load: parseFloat(document.getElementById('training-load').value) || 0, 
                description: document.getElementById('training-description').value,
                individualParticipants
            };

            const index = trainingRecords.findIndex(r => r.id == recordData.id);
            if (index > -1) { trainingRecords[index] = recordData; } else { trainingRecords.push(recordData); }
            saveData(); showToast('Treinamento salvo com sucesso!', 'success'); openTab(null, 'treinamentos-container');
        });

        trainingListBody.addEventListener('click', e => {
            const editBtn = e.target.closest('.btn-edit');
            const deleteBtn = e.target.closest('.btn-delete');
            if(editBtn) { const record = trainingRecords.find(r => r.id == editBtn.dataset.id); if(record) populateForm(record); }
            if(deleteBtn) { if(confirm('Tem certeza?')) { trainingRecords = trainingRecords.filter(r => r.id != deleteBtn.dataset.id); saveData(); renderTrainingList(); showToast('Treinamento excluído.', 'info'); }}
        });

        document.getElementById('btn-export-pdf').addEventListener('click', () => { 
            const currentTab = document.querySelector('.tab-content:not(.hidden)').id;
            if (currentTab === 'form-container') {
                showToast('Finalize ou volte para o dashboard/lista para exportar.', 'info');
                return;
            }
            window.print(); 
        });
        document.getElementById('btn-download-backup').addEventListener('click', () => { /* ... (código inalterado) ... */ });
        document.getElementById('btn-restore-backup').addEventListener('click', () => { /* ... (código inalterado) ... */ });
        document.getElementById('btn-clear-all-data').addEventListener('click', () => { /* ... (código inalterado) ... */ });
        
        const initApp = () => {
            loadData();
            openTab(null, 'dashboard-container'); 
        };
        
        initApp();
    });
    </script>
</body>
</html>