<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Process & Quality - Relatório 8D</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
      :root{
        --bg:#0f172a; --panel:#111827; --muted:#1f2937; --card:#0b1220; --text:#e5e7eb; --accent:#22d3ee; --accent2:#a78bfa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
        --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
        --status-aberto: #0d6efd; --status-andamento: #fd7e14; --status-concluido: #22c55e; --status-cancelado: #6c757d; --status-espera: #6c757d; --status-atrasado: #dc3545; --status-correcao: var(--warn);
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial; background:linear-gradient(120deg,#0b1020,#0a1328); color:var(--text); display:grid; grid-template-columns:280px 1fr; grid-template-rows:auto 1fr; gap:0; }
      header{grid-column:1/3; display:flex; align-items:center; justify-content:space-between; padding:14px 20px; background:linear-gradient(90deg,#0b1020,#0a1a35); border-bottom:1px solid #1e293b; position:sticky; top:0; z-index:5}
      .header-title h1 { margin: 0; font-size: 20px; letter-spacing: .4px; color: var(--text); }
      .header-title .subtitle { margin: 4px 0 0 0; font-size: 14px; font-weight: normal; color: var(--accent); }
      .header-title .dev-credit { margin: 4px 0 0 0; font-size: 11px; font-weight: normal; color: #64748b; }
      header .actions{display:flex; flex-wrap: wrap; gap:8px}
      button, .btn{background:var(--muted); color:var(--text); border:1px solid #243041; border-radius:12px; padding:10px 14px; cursor:pointer; box-shadow:var(--shadow); transition:.2s; font-weight:600}
      button:hover, .btn:hover{transform:translateY(-1px); border-color:#334155}
      button.primary, .btn.primary{background:linear-gradient(180deg,#0ea5e9,#2563eb); border-color:transparent}
      button.ghost, .btn.ghost{background:transparent; border-color:#334155}
      aside{border-right:1px solid #1f2937; background:linear-gradient(180deg,#0b1020,#0a1328); padding:16px; display:flex; flex-direction:column; gap:24px; justify-content: space-between;}
      .menu{display:flex; flex-direction:column; gap:8px}
      .menu .tab-link{display:flex; gap:10px; align-items:center; text-decoration:none; color:#cbd5e1; padding:10px 12px; border:1px solid #1e293b; border-radius:12px; background:rgba(255,255,255,.02); cursor:pointer;}
      .menu .tab-link.active,.menu .tab-link:hover{border-color:#334155; background:rgba(34,211,238,.08); color:#e2e8f0}
      main{padding:18px; overflow:auto}
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      section{background:rgba(255,255,255,.03); border:1px solid #1f2937; border-radius:var(--radius); padding:16px; margin-bottom:18px; box-shadow:var(--shadow)}
      h2, h3{margin:0 0 12px 0; font-size:18px; color: var(--accent);}
      h4{margin:0 0 12px 0; font-size:16px; color: var(--accent2);}
      .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
      .field{display:flex; flex-direction:column; gap:6px}
      label{font-size:12px; color:#93c5fd}
      input, select, textarea{background:#0b1220; border:1px solid #243041; color:var(--text); padding:10px 12px; border-radius:10px; outline:none; font-family:inherit; font-size:14px;}
      .hidden { display: none !important; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 10px 12px; border-bottom: 1px solid var(--muted); text-align: left; font-size: 14px; vertical-align: middle;}
      th { background: rgba(255,255,255,.05); font-size: 12px; color: #94a3b8; }
      tbody tr:hover { background: rgba(255,255,255,0.02); }
      .action-item-block { padding: 12px; border: 1px solid var(--muted); border-radius: 12px; background: var(--card); position: relative; margin-top: 10px; }
      .remove-action-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; color: #fca5a5; font-size: 1.5rem; cursor: pointer;}
      .attachments-section { margin-top: 15px; padding-top: 15px; border-top: 1px dashed var(--muted);}
      .attachment-preview-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
      .attachment-item { width: 80px; position: relative; }
      .attachment-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
      .attachment-item .remove-attachment { position: absolute; top: -5px; right: -5px; background: var(--bad); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; }
      .status-pill { padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: bold; color: white; text-align: center; display: inline-block;}
      .status-aberto { background-color: var(--status-aberto); } .status-andamento { background-color: var(--status-andamento); } .status-concluido { background-color: var(--status-concluido); } .status-cancelado { background-color: var(--status-cancelado); } .status-espera { background-color: var(--status-espera); } .status-atrasado { background-color: var(--status-atrasado); } .status-correcao { background-color: var(--warn); color: #111827 !important}
      .team-member-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
      .team-member-row input { flex: 1; }
      .discipline-header { display: flex; justify-content: space-between; align-items: center; }
      .discipline-header label { font-size: 12px; color: var(--text); display: flex; align-items: center; gap: 6px; cursor: pointer; }
      .progress-bar-container { background: var(--muted); border-radius: 99px; height: 10px; width: 100px; overflow: hidden; }
      .progress-bar { background: var(--accent); height: 100%; width: 0%; transition: width 0.3s; }
      .help-content h3 { color: var(--accent2); margin-top: 24px; margin-bottom: 10px; border-bottom: 1px solid var(--muted); padding-bottom: 5px; font-size: 18px; }
      .help-content h4 { color: var(--accent); font-size: 14px; margin-top: 16px; }
      .help-content p, .help-content li { line-height: 1.6; color: var(--text); }
      .help-content ul { list-style-position: inside; padding-left: 10px; }
      .help-content strong { color: var(--accent); }
      #record-counter { background:rgba(255,255,255,.02); border:1px solid #1e293b; border-radius: 12px; padding: 12px;}
      #record-counter p { margin: 8px 0; color: #cbd5e1; display: flex; justify-content: space-between; }
      #record-counter span { font-weight: bold; color: var(--accent); }
      .toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
      .toast { padding: 12px 18px; border-radius: 12px; color: white; font-weight: 600; font-size: 14px; box-shadow: var(--shadow); opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
      .toast.show { opacity: 1; transform: translateX(0); }
      .toast.success { background: linear-gradient(90deg, #22c55e, #16a34a); }
      .toast.error { background: linear-gradient(90deg, #ef4444, #dc2626); }
      .toast.info { background: linear-gradient(90deg, #3b82f6, #2563eb); }

      @media print {
        body { display: block; grid-template-columns: 1fr; }
        header, aside, .btn, .hidden-print, #Dashboard, #Ajuda, .remove-btn, .remove-action-btn, .actions, .btn-add-action, .btn-add-member { display: none !important; }
        main { padding: 0; overflow: visible; }
        section { box-shadow: none; border: 1px solid #ccc; background: white; color: black; page-break-inside: avoid; }
        input, select, textarea { border: 1px solid #ccc; color: black; background: #f9f9f9; }
        label, h2, h3, h4 { color: black !important; }
      }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="header-title">
            <h1>Eng Process & Quality</h1>
            <p class="subtitle">Relatório de 8 Disciplinas (8D)</p>
            <p class="dev-credit">Desenvolvido por Marcos Garçon</p>
        </div>
        <div class="actions">
            <button class="btn ghost" id="btn-restore-backup">Restaurar Backup</button>
            <button class="btn ghost" id="btn-download-backup">Baixar Backup (.json)</button>
            <button class="btn ghost" id="btn-archive-and-clear" style="color:var(--warn);">Arquivar e Limpar</button>
            <button class="btn primary" id="btn-export-pdf">Exportar PDF</button>
        </div>
    </header>

    <aside>
        <div>
            <div class="menu">
                 <a class="tab-link active" onclick="openTab(event, 'Dashboard')">Relatórios Salvos</a>
                 <a class="tab-link" onclick="openTab(event, 'Ajuda')">Ajuda</a>
            </div>
        </div>
        <div id="record-counter">
            <h4>Registros</h4>
            <p>Relatórios Salvos: <span id="report-count">0</span></p>
        </div>
    </aside>

    <main>
        <div id="Dashboard" class="tab-content active">
            <section>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Listagem de Relatórios 8D</h2>
                    <button id="btn-new-report" class="btn primary">+ Novo Relatório 8D</button>
                </div>
                <table id="report-list-table">
                    <thead>
                        <tr>
                            <th>Nº 8D</th>
                            <th>Produto</th>
                            <th>Status Geral</th>
                            <th>Progresso</th>
                            <th>Prazo</th>
                            <th class="hidden-print">Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>
        
        <div id="form-container" class="tab-content">
            <section>
                <form id="8d-form">
                    <input type="hidden" id="report-id">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;">
                        <h2>Formulário 8D</h2>
                    </div>
                    
                    <section>
                        <h4>Informações Gerais e Prazos</h4>
                        <div class="grid">
                           <div class="field" style="grid-column: span 3;"><label for="numero-8d">Nº 8D</label><input type="text" id="numero-8d"></div>
                           <div class="field" style="grid-column: span 3;"><label for="data-abertura">Data de Abertura</label><input type="date" id="data-abertura"></div>
                           <div class="field" style="grid-column: span 3;"><label for="data-conclusao-prevista">Prazo Original</label><input type="date" id="data-conclusao-prevista"></div>
                           <div class="field" style="grid-column: span 3;"><label for="geral-status">Status Geral</label><select id="geral-status"><option value="aberto">Aberto</option><option value="andamento">Em Andamento</option><option value="espera">Em Espera</option><option value="atrasado">Atrasado</option><option value="correcao">Em Correção</option><option value="concluido">Concluído</option><option value="cancelado">Cancelado</option></select></div>
                           <div class="field" style="grid-column: span 6;"><label for="cliente">Cliente</label><input type="text" id="cliente"></div>
                           <div class="field" style="grid-column: span 6;"><label for="produto">Produto / Processo</label><input type="text" id="produto"></div>
                           <div id="nova-data-container" class="field hidden" style="grid-column: span 3;"><label for="nova-data-conclusao">Nova Data de Conclusão</label><input type="date" id="nova-data-conclusao"></div>
                           <div class="field" style="grid-column: span 9;"><label for="observacoes-gerais">Observações / Justificativa de Atraso</label><textarea id="observacoes-gerais" rows="1"></textarea></div>
                        </div>
                    </section>

                    <section>
                        <div class="discipline-header">
                            <h4>D1: Formação da Equipe</h4>
                            <label><input type="checkbox" class="discipline-complete-checkbox" data-discipline="d1"> Marcar D1 como Concluída</label>
                        </div>
                        <div class="grid">
                           <div class="field" style="grid-column: span 12;"><label for="equipe-lider">Líder da Equipe</label><input type="text" id="equipe-lider"></div>
                           <div class="field" style="grid-column: span 12;">
                                <label>Membros da Equipe</label>
                                <div id="team-member-container"></div>
                                <button type="button" id="btn-add-member" class="btn ghost" style="max-width: 200px; margin-top: 5px; font-size: 12px; padding: 5px 10px;">+ Adicionar Membro</button>
                           </div>
                        </div>
                    </section>
                    
                    <section>
                        <div class="discipline-header">
                            <h4>D2: Descrição do Problema (5W2H)</h4>
                             <label><input type="checkbox" class="discipline-complete-checkbox" data-discipline="d2"> Marcar D2 como Concluída</label>
                        </div>
                        <div class="field"><textarea id="d2-descricao" rows="5" placeholder="Descreva o problema em detalhes. Use a seção de anexos abaixo para o relatório 5W2H, fotos da falha, etc."></textarea></div>
                        <div id="d2-attachments-ui" class="attachments-section"></div>
                    </section>

                    <section>
                        <div class="discipline-header">
                            <h4>D3: Ações Imediatas / Contenção</h4>
                             <label><input type="checkbox" class="discipline-complete-checkbox" data-discipline="d3"> Marcar D3 como Concluída</label>
                        </div>
                        <div class="action-plan-container" data-discipline="d3"></div>
                        <button type="button" class="btn ghost btn-add-action" data-discipline="d3">+ Adicionar Ação de Contenção</button>
                    </section>

                    <section>
                        <div class="discipline-header">
                            <h4>D4: Análise da Causa Raiz (Ishikawa, 5 Porquês)</h4>
                             <label><input type="checkbox" class="discipline-complete-checkbox" data-discipline="d4"> Marcar D4 como Concluída</label>
                        </div>
                        <div class="field"><textarea id="d4-causa-raiz" rows="6" placeholder="Documente a análise. Use a seção de anexos abaixo para o Diagrama de Ishikawa, a análise dos 5 Porquês, etc."></textarea></div>
                         <div id="d4-attachments-ui" class="attachments-section"></div>
                    </section>

                    <section>
                        <div class="discipline-header"><h4>D5: Ações Corretivas Permanentes</h4><label><input type="checkbox" class="discipline-complete-checkbox" data-discipline="d5"> Marcar D5 como Concluída</label></div>
                        <div class="action-plan-container" data-discipline="d5"></div>
                        <button type="button" class="btn ghost btn-add-action" data-discipline="d5">+ Adicionar Ação Corretiva</button>
                    </section>

                    <section>
                        <div class="discipline-header"><h4>D6: Implementar e Validar Ações Corretivas</h4><label><input type="checkbox" class="discipline-complete-checkbox" data-discipline="d6"> Marcar D6 como Concluída</label></div>
                        <div class="action-plan-container" data-discipline="d6"></div>
                        <button type="button" class="btn ghost btn-add-action" data-discipline="d6">+ Adicionar Ação de Implementação</button>
                    </section>

                     <section>
                        <div class="discipline-header"><h4>D7: Prevenir Recorrência (FMEA, Plano de Controle)</h4><label><input type="checkbox" class="discipline-complete-checkbox" data-discipline="d7"> Marcar D7 como Concluída</label></div>
                        <div class="action-plan-container" data-discipline="d7"></div>
                        <button type="button" class="btn ghost btn-add-action" data-discipline="d7">+ Adicionar Ação Preventiva</button>
                    </section>

                    <section>
                        <div class="discipline-header"><h4>D8: Reconhecimento da Equipe</h4><label><input type="checkbox" class="discipline-complete-checkbox" data-discipline="d8"> Marcar D8 como Concluída</label></div>
                        <div class="field"><textarea id="d8-reconhecimento" rows="4" placeholder="Descreva como a equipe foi reconhecida..."></textarea></div>
                    </section>

                    <div style="margin-top: 16px; display: flex; gap: 10px;">
                        <button type="submit" class="btn primary">Salvar Relatório</button>
                        <button type="button" id="btn-cancel" class="btn ghost">Cancelar</button>
                    </div>
                </form>
            </section>
        </div>

        <div id="Ajuda" class="tab-content">
             <section class="help-content">
                <h2>Guia de Utilização - Relatório 8D</h2>
                <p>O 8D é uma metodologia estruturada para resolver problemas de forma definitiva. Siga os passos abaixo para preencher seu relatório.</p>
                <h3>Painel Principal e Controles</h3>
                <ul>
                    <li><strong>Relatórios Salvos:</strong> A tela inicial mostra uma tabela com todos os seus 8D. Você pode ver o status, o progresso e o prazo rapidamente.</li>
                    <li><strong>Progresso:</strong> Uma barra visual que enche à medida que você marca cada disciplina (D1 a D8) como "concluída" dentro do formulário.</li>
                </ul>
                <h3>As 8 Disciplinas</h3>
                <p>Dentro do formulário, cada disciplina (D1 a D8) representa uma etapa do processo. Para D3, D5, D6 e D7, você pode adicionar múltiplos "Planos de Ação" detalhados. Para D2 e D4, que são mais descritivas, utilize a seção de "Anexos" para carregar documentos como Ishikawa, 5 Porquês, fotos da falha, etc.</p>
            </section>
        </div>
    </main>

    <template id="team-member-template">
        <div class="team-member-row">
            <input type="text" class="member-name" placeholder="Nome do Membro">
            <input type="text" class="member-area" placeholder="Área/Departamento">
            <button type="button" class="btn ghost btn-remove-member" style="padding: 5px 10px;">&times;</button>
        </div>
    </template>
    
    <template id="attachment-ui-template">
        <div class="field">
            <div style="display:flex; gap:10px; align-items: center;">
                <input type="text" class="attachment-link-url" placeholder="Cole um link de anexo aqui..." style="flex-grow:1; font-size: 12px;">
                <input type="text" class="attachment-link-name" placeholder="Nome do link" style="width: 120px; font-size: 12px;">
                <button type="button" class="btn ghost btn-add-link" style="padding: 5px 10px; font-size: 12px;">Adicionar</button>
            </div>
             <input type="file" class="attachments-input hidden" multiple>
             <div class="attachment-drop-zone" style="padding: 10px; font-size: 12px; margin-top: 5px;">Arraste ou clique para adicionar arquivos (máx 5MB)</div>
             <div class="attachment-preview-grid"></div>
        </div>
    </template>

    <template id="action-plan-form-template">
        <div class="action-item-block">
            <button type="button" class="remove-action-btn">&times;</button>
            <div class="grid">
                <div class="col-12 field"><label>Ação</label><textarea class="action-input" rows="2"></textarea></div>
                <div class="col-4 field"><label>Responsável</label><input type="text" class="responsible-input"></div>
                <div class="col-2 field"><label>Status</label><select class="status-input"><option value="aberto">Aberto</option><option value="andamento">Em Andamento</option><option value="concluido">Concluído</option><option value="cancelado">Cancelado</option></select></div>
                <div class="col-2 field"><label>Data Início</label><input type="date" class="start-date-input"></div>
                <div class="col-2 field"><label>Data Final</label><input type="date" class="end-date-input"></div>
                <div class="col-2 field"><label>Nova Data</label><input type="date" class="new-date-input"></div>
                <div class="col-12 attachments-section">
                    <div class="attachment-ui"></div>
                </div>
            </div>
        </div>
    </template>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & DBs ---
        let reports = [];
        const DB_KEY = 'mg_8d_reports_v5';

        // --- DOM ELEMENTS ---
        const main = document.querySelector('main');
        const formContainer = document.getElementById('form-container');
        const form = document.getElementById('8d-form');
        const btnNewReport = document.getElementById('btn-new-report');
        const btnCancel = document.getElementById('btn-cancel');
        const reportListContainer = document.querySelector('#report-list-table tbody');
        const reportCountSpan = document.getElementById('report-count');
        const actionPlanFormTemplate = document.getElementById('action-plan-form-template');
        const teamMemberTemplate = document.getElementById('team-member-template');
        const attachmentUiTemplate = document.getElementById('attachment-ui-template');
        const teamMemberContainer = document.getElementById('team-member-container');
        const btnAddMember = document.getElementById('btn-add-member');
        const geralStatusSelect = document.getElementById('geral-status');
        const novaDataContainer = document.getElementById('nova-data-container');

        // --- Helper Functions ---
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        };
        
        // --- Data Persistence & Backup ---
        const saveData = () => { try { localStorage.setItem(DB_KEY, JSON.stringify(reports)); } catch (e) { showToast('Erro ao salvar.', 'error'); } };
        const loadData = () => { reports = JSON.parse(localStorage.getItem(DB_KEY)) || []; };
        const handleDownloadBackup = () => { const blob = new Blob([JSON.stringify(reports, null, 2)], { type: 'application/json' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `8d_backup_${new Date().toISOString().slice(0, 10)}.json`; link.click(); URL.revokeObjectURL(link.href); showToast("Backup baixado!", "success"); };
        const handleRestoreBackup = () => { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = event => { if (!confirm('Atenção: Restaurar um backup substituirá TODOS os dados atuais. Deseja continuar?')) return; try { const restored = JSON.parse(event.target.result); if (Array.isArray(restored)) { reports = restored; saveData(); renderReportList(); showToast('Backup restaurado com sucesso!'); } else { throw new Error('Formato inválido.'); } } catch (err) { showToast('Erro: Arquivo de backup inválido.', 'error'); } }; reader.readAsText(file); }; input.click(); };
        const handleArchiveAndClear = () => { if (confirm("ATENÇÃO: Isso irá baixar um backup e depois APAGAR os dados do navegador. Deseja continuar?")) { handleDownloadBackup(); localStorage.removeItem(DB_KEY); showToast("Dados arquivados e limpos.", "info"); setTimeout(() => window.location.reload(), 2000); } };

        // --- Tabs ---
        window.openTab = (evt, tabName) => {
            document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
            evt.currentTarget.classList.add('active');
        };
        
        // --- Core Application Logic ---
        const showForm = () => { document.getElementById('Dashboard').classList.remove('active'); formContainer.classList.add('active'); };
        const showDashboard = () => { form.reset(); form.querySelectorAll('.action-plan-container, .attachment-ui').forEach(c => c.innerHTML = ''); teamMemberContainer.innerHTML = ''; document.getElementById('report-id').value = ''; formContainer.classList.remove('active'); document.getElementById('Dashboard').classList.add('active'); renderReportList(); };
        
        const renderReportList = () => {
            reportListContainer.innerHTML = '';
            if (reports.length === 0) { reportListContainer.innerHTML = '<tr><td colspan="6">Nenhum relatório salvo.</td></tr>'; } 
            else {
                reports.forEach(report => {
                    const row = reportListContainer.insertRow();
                    const reportDate = report.dataConclusaoPrevista ? new Date(report.dataConclusaoPrevista + 'T00:00:00').toLocaleDateString() : 'N/A';
                    const completed = Object.values(report.completionStatus || {}).filter(Boolean).length;
                    const progress = (completed / 8) * 100;
                    row.innerHTML = `<td>${report.numero8D || 'N/A'}</td><td>${report.produto || 'N/A'}</td><td><span class="status-pill status-${report.geralStatus}">${report.geralStatus}</span></td><td><div class="progress-bar-container" title="${completed} de 8 Disciplinas (${progress.toFixed(0)}%)"> <div class="progress-bar" style="width: ${progress}%;"></div> </div></td><td>${reportDate}</td><td class="hidden-print"><div style="display:flex; gap: 5px;"><button class="btn ghost btn-edit" data-id="${report.id}" style="padding:4px 8px; font-size:12px;">Editar</button><button class="btn ghost btn-delete" data-id="${report.id}" style="padding:4px 8px; font-size:12px;">Excluir</button></div></td>`;
                });
            }
            reportCountSpan.textContent = reports.length;
        };

        const addAttachmentPreview = (container, attachment) => {
            const previewGrid = container.querySelector('.attachment-preview-grid');
            if (!previewGrid) return;
            const item = document.createElement('div');
            item.className = 'attachment-item';
            item.dataset.type = attachment.type; item.dataset.name = attachment.name; item.dataset.data = attachment.data;
            let content = '';
            if (attachment.type === 'image') { content = `<img src="${attachment.data}" alt="${attachment.name}">`; } 
            else { content = `<a href="${attachment.data}" target="_blank" title="${attachment.data}"><i class="ph ph-link" style="font-size:48px;"></i><p style="font-size:11px;word-break:break-all;">${attachment.name}</p></a>`; }
            item.innerHTML = content + `<button type="button" class="remove-attachment">&times;</button>`;
            previewGrid.appendChild(item);
        };
        
        const handleFiles = (files, container) => {
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) { showToast(`Arquivo "${file.name}" é maior que 5MB.`, 'error'); continue; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const type = file.type.startsWith('image/') ? 'image' : 'link';
                    addAttachmentPreview(container, { type: type, name: file.name, data: e.target.result });
                }
                reader.readAsDataURL(file);
            }
        };
        
        const populateAttachmentUI = (containerId, attachments = []) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const uiClone = attachmentUiTemplate.content.cloneNode(true);
            const field = uiClone.querySelector('.field');
            if(attachments) { attachments.forEach(att => addAttachmentPreview(field, att)); }
            container.appendChild(uiClone);
        };

        btnNewReport.addEventListener('click', () => {
            form.reset();
            document.getElementById('report-id').value = '';
            document.getElementById('data-abertura').value = new Date().toISOString().slice(0,10);
            form.querySelectorAll('.action-plan-container').forEach(c => c.innerHTML = '');
            teamMemberContainer.innerHTML = '';
            populateAttachmentUI('d2-attachments-ui');
            populateAttachmentUI('d4-attachments-ui');
            geralStatusSelect.dispatchEvent(new Event('change'));
            showForm();
        });
        btnCancel.addEventListener('click', showDashboard);
        btnAddMember.addEventListener('click', () => { teamMemberContainer.appendChild(teamMemberTemplate.content.cloneNode(true)); });
        geralStatusSelect.addEventListener('change', (e) => novaDataContainer.classList.toggle('hidden', e.target.value !== 'atrasado'));

        main.addEventListener('click', e => {
            const target = e.target;
            if(target.classList.contains('btn-add-action')){ const discipline = target.dataset.discipline; const container = main.querySelector(`.action-plan-container[data-discipline="${discipline}"]`); const clone = actionPlanFormTemplate.content.cloneNode(true); const attachmentContainer = clone.querySelector('.attachment-ui'); attachmentContainer.appendChild(attachmentUiTemplate.content.cloneNode(true)); container.appendChild(clone); }
            if(target.classList.contains('remove-action-btn')){ target.closest('.action-item-block').remove(); }
            if(target.classList.contains('btn-remove-member')){ target.closest('.team-member-row').remove(); }
            if(target.classList.contains('btn-add-link')){ const container = target.closest('.field'); const urlInput = container.querySelector('.attachment-link-url'); const nameInput = container.querySelector('.attachment-link-name'); if(urlInput.value && nameInput.value){ addAttachmentPreview(container, { type: 'link', name: nameInput.value, data: urlInput.value }); urlInput.value = ''; nameInput.value = ''; } }
            if(target.classList.contains('attachment-drop-zone')){ target.previousElementSibling.click(); }
            if(target.classList.contains('remove-attachment')){ target.closest('.attachment-item').remove(); }
            if(target.classList.contains('btn-delete')){ const id = target.dataset.id; if(confirm('Tem certeza?')){ reports = reports.filter(r => r.id != id); saveData(); renderReportList(); } }
            if(target.classList.contains('btn-edit')){
                const report = reports.find(r => r.id == target.dataset.id);
                if(report) {
                    showDashboard(); form.reset();
                    document.getElementById('report-id').value = report.id;
                    document.getElementById('geral-status').value = report.geralStatus || 'aberto'; document.getElementById('numero-8d').value = report.numero8D || '';
                    document.getElementById('cliente').value = report.cliente || ''; document.getElementById('produto').value = report.produto || '';
                    document.getElementById('equipe-lider').value = report.equipeLider || ''; document.getElementById('data-abertura').value = report.dataAbertura || '';
                    document.getElementById('data-conclusao-prevista').value = report.dataConclusaoPrevista || ''; document.getElementById('nova-data-conclusao').value = report.novaDataConclusao || '';
                    document.getElementById('observacoes-gerais').value = report.observacoesGerais || '';
                    if(report.teamMembers) { report.teamMembers.forEach(member => { const clone = teamMemberTemplate.content.cloneNode(true); clone.querySelector('.member-name').value = member.name; clone.querySelector('.member-area').value = member.area; teamMemberContainer.appendChild(clone); }); }
                    document.getElementById('d2-descricao').value = report.d2Descricao || ''; populateAttachmentUI('d2-attachments-ui', report.d2Attachments);
                    document.getElementById('d4-causa-raiz').value = report.d4CausaRaiz || ''; populateAttachmentUI('d4-attachments-ui', report.d4Attachments);
                    document.getElementById('d8-reconhecimento').value = report.d8Reconhecimento || '';
                    ['d3', 'd5', 'd6', 'd7'].forEach(d => {
                        const container = main.querySelector(`.action-plan-container[data-discipline="${d}"]`); container.innerHTML = '';
                        if(report[d]) {
                            report[d].forEach(action => {
                                const clone = actionPlanFormTemplate.content.cloneNode(true);
                                const itemBlock = clone.querySelector('.action-item-block');
                                itemBlock.querySelector('.action-input').value = action.action || ''; itemBlock.querySelector('.responsible-input').value = action.responsible || ''; itemBlock.querySelector('.status-input').value = action.status || 'aberto';
                                itemBlock.querySelector('.start-date-input').value = action.startDate || ''; itemBlock.querySelector('.end-date-input').value = action.endDate || ''; itemBlock.querySelector('.new-date-input').value = action.newDate || '';
                                const attachmentContainer = itemBlock.querySelector('.attachment-ui'); attachmentContainer.appendChild(attachmentUiTemplate.content.cloneNode(true));
                                if(action.attachments) { action.attachments.forEach(att => addAttachmentPreview(attachmentContainer.querySelector('.field'), att)); }
                                container.appendChild(clone);
                            });
                        }
                    });
                    if (report.completionStatus) { form.querySelectorAll('.discipline-complete-checkbox').forEach(cb => { cb.checked = report.completionStatus[cb.dataset.discipline] || false; }); }
                    geralStatusSelect.dispatchEvent(new Event('change'));
                    showForm();
                }
            }
        });

        main.addEventListener('change', e => { if(e.target.classList.contains('attachments-input')){ handleFiles(e.target.files, e.target.closest('.field')); } });
        const getAttachmentsFromContainer = (container) => { const attachments = []; container.querySelectorAll('.attachment-item').forEach(att => attachments.push({type: att.dataset.type, name: att.dataset.name, data: att.dataset.data})); return attachments; };

        form.addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('report-id').value;
            const completionStatus = {};
            form.querySelectorAll('.discipline-complete-checkbox').forEach(cb => { completionStatus[cb.dataset.discipline] = cb.checked; });
            const reportData = {
                id: id ? parseInt(id) : Date.now(),
                geralStatus: document.getElementById('geral-status').value, numero8D: document.getElementById('numero-8d').value,
                dataAbertura: document.getElementById('data-abertura').value, dataConclusaoPrevista: document.getElementById('data-conclusao-prevista').value,
                novaDataConclusao: document.getElementById('nova-data-conclusao').value, observacoesGerais: document.getElementById('observacoes-gerais').value,
                cliente: document.getElementById('cliente').value, produto: document.getElementById('produto').value,
                equipeLider: document.getElementById('equipe-lider').value,
                teamMembers: Array.from(teamMemberContainer.querySelectorAll('.team-member-row')).map(row => ({ name: row.querySelector('.member-name').value, area: row.querySelector('.member-area').value })),
                d2Descricao: document.getElementById('d2-descricao').value, d2Attachments: getAttachmentsFromContainer(document.getElementById('d2-attachments-ui')),
                d4CausaRaiz: document.getElementById('d4-causa-raiz').value, d4Attachments: getAttachmentsFromContainer(document.getElementById('d4-attachments-ui')),
                d8Reconhecimento: document.getElementById('d8-reconhecimento').value,
                completionStatus: completionStatus,
                d3: [], d5: [], d6: [], d7: []
            };
            ['d3', 'd5', 'd6', 'd7'].forEach(d => { const container = main.querySelector(`.action-plan-container[data-discipline="${d}"]`); container.querySelectorAll('.action-item-block').forEach(item => { reportData[d].push({ action: item.querySelector('.action-input').value, responsible: item.querySelector('.responsible-input').value, status: item.querySelector('.status-input').value, startDate: item.querySelector('.start-date-input').value, endDate: item.querySelector('.end-date-input').value, newDate: item.querySelector('.new-date-input').value, attachments: getAttachmentsFromContainer(item.querySelector('.attachment-ui')) }); }); });
            if(id) { const index = reports.findIndex(r => r.id == id); reports[index] = reportData; } else { reports.push(reportData); }
            saveData(); renderReportList(); showDashboard(); showToast("Relatório salvo!", "success");
        });
        
        document.getElementById('btn-download-backup').addEventListener('click', handleDownloadBackup);
        document.getElementById('btn-restore-backup').addEventListener('click', handleRestoreBackup);
        document.getElementById('btn-archive-and-clear').addEventListener('click', handleArchiveAndClear);
        document.getElementById('btn-export-pdf').addEventListener('click', () => { if(formContainer.classList.contains('active')) { window.print(); } else { showToast("Abra um relatório para exportar.", "info"); }});

        // --- INITIALIZATION ---
        loadData();
        renderReportList();
    });
    </script>
</body>
</html>