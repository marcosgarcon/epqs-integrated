<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Lacunas (Gap Analysis) - EPQS</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --muted: #1f2937;
            --card: #0b1220;
            --text: #e5e7eb;
            --accent: #22d3ee;
            --accent2: #a78bfa;
            --ok: #22c55e;
            --warn: #f59e0b;
            --bad: #ef4444;
            --shadow: 0 10px 30px rgba(0,0,0,.35);
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg) 0%, var(--panel) 100%);
            color: var(--text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid #334155;
        }

        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            margin: 0;
            color: #94a3b8;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            background: var(--muted);
            border-radius: var(--radius);
            padding: 8px;
            margin-bottom: 30px;
            border: 1px solid #334155;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--text);
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab.active {
            background: var(--accent);
            color: var(--bg);
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.3);
        }

        .tab:hover:not(.active) {
            background: rgba(34, 211, 238, 0.1);
        }

        .tab-content {
            display: none;
            background: var(--card);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            border: 1px solid #334155;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--accent);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--muted);
            border: 1px solid #374151;
            border-radius: 8px;
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 24px;
            background: var(--accent);
            color: var(--bg);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            background: #0891b2;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 211, 238, 0.3);
        }

        .btn-secondary {
            background: var(--muted);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: #374151;
        }

        .btn-success {
            background: var(--ok);
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-warning {
            background: var(--warn);
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .gap-item {
            background: var(--muted);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #374151;
            transition: all 0.3s ease;
        }

        .gap-item:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(34, 211, 238, 0.1);
        }

        .gap-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 16px;
        }

        .gap-title {
            font-weight: 600;
            color: var(--accent);
            margin: 0;
        }

        .gap-priority {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .priority-high {
            background: var(--bad);
            color: white;
        }

        .priority-medium {
            background: var(--warn);
            color: white;
        }

        .priority-low {
            background: var(--ok);
            color: white;
        }

        .gap-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .detail-item {
            background: var(--card);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .detail-label {
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text);
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .chart-container {
            background: var(--muted);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #374151;
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: var(--muted);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #374151;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .summary-label {
            color: #94a3b8;
            font-size: 14px;
        }

        .notification {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            display: none;
        }

        .notification.success {
            background: rgba(34, 197, 94, 0.1);
            border-color: var(--ok);
            color: var(--ok);
        }

        .notification.error {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--bad);
            color: var(--bad);
        }

        .notification.info {
            background: rgba(34, 211, 238, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .actions {
                flex-direction: column;
            }

            .gap-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .gap-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="ph ph-chart-line-up"></i> Análise de Lacunas (Gap Analysis)</h1>
            <p>Identifique e analise as lacunas entre o estado atual e o estado desejado dos seus processos</p>
        </div>

        <div id="notification" class="notification"></div>

        <div class="tabs">
            <button class="tab active" data-tab="setup">
                <i class="ph ph-gear"></i> Configuração
            </button>
            <button class="tab" data-tab="analysis">
                <i class="ph ph-chart-bar"></i> Análise
            </button>
            <button class="tab" data-tab="gaps">
                <i class="ph ph-warning"></i> Lacunas
            </button>
            <button class="tab" data-tab="action-plan">
                <i class="ph ph-list-checks"></i> Plano de Ação
            </button>
            <button class="tab" data-tab="report">
                <i class="ph ph-file-text"></i> Relatório
            </button>
        </div>

        <!-- Setup Tab -->
        <div class="tab-content active" id="setup">
            <h2 style="color: var(--accent); margin-bottom: 20px;">
                <i class="ph ph-gear"></i> Configuração da Análise
            </h2>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="analysis-title">Título da Análise</label>
                    <input type="text" class="form-input" id="analysis-title" placeholder="Ex: Análise de Processo de Produção">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="analysis-scope">Escopo da Análise</label>
                    <select class="form-select" id="analysis-scope">
                        <option value="">Selecione o escopo</option>
                        <option value="processo">Processo Específico</option>
                        <option value="departamento">Departamento</option>
                        <option value="organizacao">Organização Completa</option>
                        <option value="produto">Produto/Serviço</option>
                        <option value="sistema">Sistema de Gestão</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="analysis-objective">Objetivo da Análise</label>
                    <input type="text" class="form-input" id="analysis-objective" placeholder="Ex: Melhorar eficiência operacional">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="analysis-responsible">Responsável</label>
                    <input type="text" class="form-input" id="analysis-responsible" placeholder="Nome do responsável">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="analysis-date">Data da Análise</label>
                    <input type="date" class="form-input" id="analysis-date">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="analysis-deadline">Prazo para Implementação</label>
                    <input type="date" class="form-input" id="analysis-deadline">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="analysis-description">Descrição Detalhada</label>
                <textarea class="form-textarea" id="analysis-description" placeholder="Descreva o contexto e os detalhes da análise..."></textarea>
            </div>
            
            <div class="actions">
                <button class="btn" onclick="gapAnalysis.saveConfiguration()">
                    <i class="ph ph-floppy-disk"></i> Salvar Configuração
                </button>
                <button class="btn btn-secondary" onclick="gapAnalysis.loadConfiguration()">
                    <i class="ph ph-folder-open"></i> Carregar Configuração
                </button>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div class="tab-content" id="analysis">
            <h2 style="color: var(--accent); margin-bottom: 20px;">
                <i class="ph ph-chart-bar"></i> Análise de Estados
            </h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                <div>
                    <h3 style="color: var(--accent2); margin-bottom: 16px;">Estado Atual</h3>
                    <div class="form-group">
                        <label class="form-label" for="current-performance">Performance Atual (%)</label>
                        <input type="number" class="form-input" id="current-performance" min="0" max="100" placeholder="Ex: 75">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="current-description">Descrição do Estado Atual</label>
                        <textarea class="form-textarea" id="current-description" placeholder="Descreva a situação atual..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="current-metrics">Métricas Atuais</label>
                        <textarea class="form-textarea" id="current-metrics" placeholder="Liste as métricas e valores atuais..."></textarea>
                    </div>
                </div>
                
                <div>
                    <h3 style="color: var(--ok); margin-bottom: 16px;">Estado Desejado</h3>
                    <div class="form-group">
                        <label class="form-label" for="desired-performance">Performance Desejada (%)</label>
                        <input type="number" class="form-input" id="desired-performance" min="0" max="100" placeholder="Ex: 95">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="desired-description">Descrição do Estado Desejado</label>
                        <textarea class="form-textarea" id="desired-description" placeholder="Descreva a situação desejada..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="desired-metrics">Métricas Desejadas</label>
                        <textarea class="form-textarea" id="desired-metrics" placeholder="Liste as métricas e valores desejados..."></textarea>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">Comparação: Estado Atual vs Estado Desejado</div>
                <canvas id="comparisonChart" width="400" height="200"></canvas>
            </div>
            
            <div class="actions">
                <button class="btn" onclick="gapAnalysis.calculateGap()">
                    <i class="ph ph-calculator"></i> Calcular Lacuna
                </button>
                <button class="btn btn-secondary" onclick="gapAnalysis.updateChart()">
                    <i class="ph ph-chart-line"></i> Atualizar Gráfico
                </button>
            </div>
        </div>

        <!-- Gaps Tab -->
        <div class="tab-content" id="gaps">
            <h2 style="color: var(--accent); margin-bottom: 20px;">
                <i class="ph ph-warning"></i> Lacunas Identificadas
            </h2>
            
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-value" id="total-gaps">0</div>
                    <div class="summary-label">Total de Lacunas</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="high-priority-gaps">0</div>
                    <div class="summary-label">Alta Prioridade</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="gap-percentage">0%</div>
                    <div class="summary-label">Lacuna Total</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="estimated-effort">0h</div>
                    <div class="summary-label">Esforço Estimado</div>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="gapAnalysis.addGap()">
                    <i class="ph ph-plus"></i> Adicionar Lacuna
                </button>
            </div>
            
            <div id="gaps-list">
                <!-- Gaps will be populated here -->
            </div>
        </div>

        <!-- Action Plan Tab -->
        <div class="tab-content" id="action-plan">
            <h2 style="color: var(--accent); margin-bottom: 20px;">
                <i class="ph ph-list-checks"></i> Plano de Ação
            </h2>
            
            <div class="chart-container">
                <div class="chart-title">Cronograma de Implementação</div>
                <canvas id="timelineChart" width="400" height="200"></canvas>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="gapAnalysis.generateActionPlan()">
                    <i class="ph ph-magic-wand"></i> Gerar Plano Automático
                </button>
                <button class="btn btn-secondary" onclick="gapAnalysis.addAction()">
                    <i class="ph ph-plus"></i> Adicionar Ação
                </button>
            </div>
            
            <div id="action-plan-list">
                <!-- Action plan will be populated here -->
            </div>
        </div>

        <!-- Report Tab -->
        <div class="tab-content" id="report">
            <h2 style="color: var(--accent); margin-bottom: 20px;">
                <i class="ph ph-file-text"></i> Relatório de Análise de Lacunas
            </h2>
            
            <div class="actions" style="margin-bottom: 30px;">
                <button class="btn" onclick="gapAnalysis.generateReport()">
                    <i class="ph ph-file-text"></i> Gerar Relatório
                </button>
                <button class="btn btn-secondary" onclick="gapAnalysis.exportPDF()">
                    <i class="ph ph-file-pdf"></i> Exportar PDF
                </button>
                <button class="btn btn-secondary" onclick="gapAnalysis.exportExcel()">
                    <i class="ph ph-file-xls"></i> Exportar Excel
                </button>
            </div>
            
            <div id="report-content" style="background: var(--muted); padding: 30px; border-radius: 12px; border: 1px solid #374151;">
                <!-- Report content will be generated here -->
            </div>
        </div>
    </div>

    <script>
        class GapAnalysisSystem {
            constructor() {
                this.data = {
                    configuration: {},
                    analysis: {},
                    gaps: [],
                    actionPlan: []
                };
                this.charts = {};
                this.init();
            }

            init() {
                this.setupTabs();
                this.setupEventListeners();
                this.loadData();
                this.setDefaultDate();
            }

            setupTabs() {
                const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetTab = tab.dataset.tab;
                        
                        tabs.forEach(t => t.classList.remove('active'));
                        tabContents.forEach(tc => tc.classList.remove('active'));
                        
                        tab.classList.add('active');
                        document.getElementById(targetTab).classList.add('active');
                    });
                });
            }

            setupEventListeners() {
                // Auto-save on input changes
                const inputs = document.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.addEventListener('change', () => this.autoSave());
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        this.saveData();
                    }
                });
            }

            setDefaultDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('analysis-date').value = today;
                
                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                document.getElementById('analysis-deadline').value = nextMonth.toISOString().split('T')[0];
            }

            saveConfiguration() {
                this.data.configuration = {
                    title: document.getElementById('analysis-title').value,
                    scope: document.getElementById('analysis-scope').value,
                    objective: document.getElementById('analysis-objective').value,
                    responsible: document.getElementById('analysis-responsible').value,
                    date: document.getElementById('analysis-date').value,
                    deadline: document.getElementById('analysis-deadline').value,
                    description: document.getElementById('analysis-description').value
                };

                this.saveData();
                this.showNotification('Configuração salva com sucesso!', 'success');
            }

            loadConfiguration() {
                const config = this.data.configuration;
                if (Object.keys(config).length === 0) {
                    this.showNotification('Nenhuma configuração salva encontrada.', 'info');
                    return;
                }

                document.getElementById('analysis-title').value = config.title || '';
                document.getElementById('analysis-scope').value = config.scope || '';
                document.getElementById('analysis-objective').value = config.objective || '';
                document.getElementById('analysis-responsible').value = config.responsible || '';
                document.getElementById('analysis-date').value = config.date || '';
                document.getElementById('analysis-deadline').value = config.deadline || '';
                document.getElementById('analysis-description').value = config.description || '';

                this.showNotification('Configuração carregada com sucesso!', 'success');
            }

            calculateGap() {
                const currentPerf = parseFloat(document.getElementById('current-performance').value) || 0;
                const desiredPerf = parseFloat(document.getElementById('desired-performance').value) || 0;
                
                if (currentPerf === 0 || desiredPerf === 0) {
                    this.showNotification('Por favor, preencha os valores de performance atual e desejada.', 'error');
                    return;
                }

                this.data.analysis = {
                    currentPerformance: currentPerf,
                    desiredPerformance: desiredPerf,
                    currentDescription: document.getElementById('current-description').value,
                    desiredDescription: document.getElementById('desired-description').value,
                    currentMetrics: document.getElementById('current-metrics').value,
                    desiredMetrics: document.getElementById('desired-metrics').value,
                    gapPercentage: Math.max(0, desiredPerf - currentPerf)
                };

                this.updateChart();
                this.updateGapSummary();
                this.saveData();
                this.showNotification('Lacuna calculada com sucesso!', 'success');
            }

            updateChart() {
                const ctx = document.getElementById('comparisonChart').getContext('2d');
                
                if (this.charts.comparison) {
                    this.charts.comparison.destroy();
                }

                const currentPerf = this.data.analysis.currentPerformance || 0;
                const desiredPerf = this.data.analysis.desiredPerformance || 0;

                this.charts.comparison = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Estado Atual', 'Estado Desejado', 'Lacuna'],
                        datasets: [{
                            label: 'Performance (%)',
                            data: [currentPerf, desiredPerf, Math.max(0, desiredPerf - currentPerf)],
                            backgroundColor: [
                                'rgba(167, 139, 250, 0.8)',
                                'rgba(34, 197, 94, 0.8)',
                                'rgba(239, 68, 68, 0.8)'
                            ],
                            borderColor: [
                                'rgba(167, 139, 250, 1)',
                                'rgba(34, 197, 94, 1)',
                                'rgba(239, 68, 68, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e5e7eb'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    color: '#e5e7eb'
                                },
                                grid: {
                                    color: '#374151'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#e5e7eb'
                                },
                                grid: {
                                    color: '#374151'
                                }
                            }
                        }
                    }
                });
            }

            addGap() {
                const gap = {
                    id: Date.now(),
                    title: 'Nova Lacuna',
                    description: '',
                    priority: 'medium',
                    impact: 'medium',
                    effort: 8,
                    responsible: '',
                    deadline: '',
                    status: 'identified'
                };

                this.data.gaps.push(gap);
                this.renderGaps();
                this.updateGapSummary();
                this.saveData();
            }

            renderGaps() {
                const container = document.getElementById('gaps-list');
                container.innerHTML = '';

                this.data.gaps.forEach(gap => {
                    const gapElement = document.createElement('div');
                    gapElement.className = 'gap-item';
                    gapElement.innerHTML = `
                        <div class="gap-header">
                            <h3 class="gap-title">${gap.title}</h3>
                            <span class="gap-priority priority-${gap.priority}">${this.getPriorityLabel(gap.priority)}</span>
                        </div>
                        <div class="gap-details">
                            <div class="detail-item">
                                <div class="detail-label">Impacto</div>
                                <div class="detail-value">${this.getImpactLabel(gap.impact)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Esforço</div>
                                <div class="detail-value">${gap.effort}h</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Responsável</div>
                                <div class="detail-value">${gap.responsible || 'Não definido'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Prazo</div>
                                <div class="detail-value">${gap.deadline || 'Não definido'}</div>
                            </div>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="btn btn-secondary" onclick="gapAnalysis.editGap(${gap.id})">
                                <i class="ph ph-pencil"></i> Editar
                            </button>
                            <button class="btn btn-warning" onclick="gapAnalysis.deleteGap(${gap.id})">
                                <i class="ph ph-trash"></i> Excluir
                            </button>
                        </div>
                    `;
                    container.appendChild(gapElement);
                });
            }

            editGap(gapId) {
                const gap = this.data.gaps.find(g => g.id === gapId);
                if (!gap) return;

                const newTitle = prompt('Título da lacuna:', gap.title);
                if (newTitle !== null) gap.title = newTitle;

                const newDescription = prompt('Descrição da lacuna:', gap.description);
                if (newDescription !== null) gap.description = newDescription;

                const newPriority = prompt('Prioridade (high/medium/low):', gap.priority);
                if (newPriority && ['high', 'medium', 'low'].includes(newPriority)) {
                    gap.priority = newPriority;
                }

                const newEffort = prompt('Esforço estimado (horas):', gap.effort);
                if (newEffort && !isNaN(newEffort)) gap.effort = parseInt(newEffort);

                const newResponsible = prompt('Responsável:', gap.responsible);
                if (newResponsible !== null) gap.responsible = newResponsible;

                const newDeadline = prompt('Prazo (YYYY-MM-DD):', gap.deadline);
                if (newDeadline !== null) gap.deadline = newDeadline;

                this.renderGaps();
                this.updateGapSummary();
                this.saveData();
            }

            deleteGap(gapId) {
                if (confirm('Tem certeza que deseja excluir esta lacuna?')) {
                    this.data.gaps = this.data.gaps.filter(g => g.id !== gapId);
                    this.renderGaps();
                    this.updateGapSummary();
                    this.saveData();
                }
            }

            updateGapSummary() {
                const totalGaps = this.data.gaps.length;
                const highPriorityGaps = this.data.gaps.filter(g => g.priority === 'high').length;
                const gapPercentage = this.data.analysis.gapPercentage || 0;
                const totalEffort = this.data.gaps.reduce((sum, gap) => sum + (gap.effort || 0), 0);

                document.getElementById('total-gaps').textContent = totalGaps;
                document.getElementById('high-priority-gaps').textContent = highPriorityGaps;
                document.getElementById('gap-percentage').textContent = gapPercentage.toFixed(1) + '%';
                document.getElementById('estimated-effort').textContent = totalEffort + 'h';
            }

            generateActionPlan() {
                // Generate automatic action plan based on gaps
                this.data.actionPlan = this.data.gaps.map(gap => ({
                    id: Date.now() + Math.random(),
                    gapId: gap.id,
                    action: `Implementar solução para: ${gap.title}`,
                    responsible: gap.responsible || 'A definir',
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: gap.deadline || '',
                    status: 'planned',
                    priority: gap.priority
                }));

                this.renderActionPlan();
                this.saveData();
                this.showNotification('Plano de ação gerado automaticamente!', 'success');
            }

            addAction() {
                const action = {
                    id: Date.now(),
                    action: 'Nova ação',
                    responsible: '',
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: '',
                    status: 'planned',
                    priority: 'medium'
                };

                this.data.actionPlan.push(action);
                this.renderActionPlan();
                this.saveData();
            }

            renderActionPlan() {
                const container = document.getElementById('action-plan-list');
                container.innerHTML = '';

                this.data.actionPlan.forEach(action => {
                    const actionElement = document.createElement('div');
                    actionElement.className = 'gap-item';
                    actionElement.innerHTML = `
                        <div class="gap-header">
                            <h3 class="gap-title">${action.action}</h3>
                            <span class="gap-priority priority-${action.priority}">${this.getPriorityLabel(action.priority)}</span>
                        </div>
                        <div class="gap-details">
                            <div class="detail-item">
                                <div class="detail-label">Responsável</div>
                                <div class="detail-value">${action.responsible || 'Não definido'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Início</div>
                                <div class="detail-value">${action.startDate || 'Não definido'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Fim</div>
                                <div class="detail-value">${action.endDate || 'Não definido'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Status</div>
                                <div class="detail-value">${this.getStatusLabel(action.status)}</div>
                            </div>
                        </div>
                        <div style="margin-top: 16px;">
                            <button class="btn btn-secondary" onclick="gapAnalysis.editAction(${action.id})">
                                <i class="ph ph-pencil"></i> Editar
                            </button>
                            <button class="btn btn-warning" onclick="gapAnalysis.deleteAction(${action.id})">
                                <i class="ph ph-trash"></i> Excluir
                            </button>
                        </div>
                    `;
                    container.appendChild(actionElement);
                });
            }

            editAction(actionId) {
                const action = this.data.actionPlan.find(a => a.id === actionId);
                if (!action) return;

                const newAction = prompt('Descrição da ação:', action.action);
                if (newAction !== null) action.action = newAction;

                const newResponsible = prompt('Responsável:', action.responsible);
                if (newResponsible !== null) action.responsible = newResponsible;

                const newStartDate = prompt('Data de início (YYYY-MM-DD):', action.startDate);
                if (newStartDate !== null) action.startDate = newStartDate;

                const newEndDate = prompt('Data de fim (YYYY-MM-DD):', action.endDate);
                if (newEndDate !== null) action.endDate = newEndDate;

                this.renderActionPlan();
                this.saveData();
            }

            deleteAction(actionId) {
                if (confirm('Tem certeza que deseja excluir esta ação?')) {
                    this.data.actionPlan = this.data.actionPlan.filter(a => a.id !== actionId);
                    this.renderActionPlan();
                    this.saveData();
                }
            }

            generateReport() {
                const reportContent = document.getElementById('report-content');
                const config = this.data.configuration;
                const analysis = this.data.analysis;

                reportContent.innerHTML = `
                    <h3 style="color: var(--accent); margin-bottom: 20px;">Relatório de Análise de Lacunas</h3>
                    
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--accent2);">Informações Gerais</h4>
                        <p><strong>Título:</strong> ${config.title || 'Não definido'}</p>
                        <p><strong>Escopo:</strong> ${config.scope || 'Não definido'}</p>
                        <p><strong>Objetivo:</strong> ${config.objective || 'Não definido'}</p>
                        <p><strong>Responsável:</strong> ${config.responsible || 'Não definido'}</p>
                        <p><strong>Data da Análise:</strong> ${config.date || 'Não definido'}</p>
                        <p><strong>Prazo:</strong> ${config.deadline || 'Não definido'}</p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--accent2);">Análise de Performance</h4>
                        <p><strong>Performance Atual:</strong> ${analysis.currentPerformance || 0}%</p>
                        <p><strong>Performance Desejada:</strong> ${analysis.desiredPerformance || 0}%</p>
                        <p><strong>Lacuna Identificada:</strong> ${analysis.gapPercentage || 0}%</p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--accent2);">Resumo das Lacunas</h4>
                        <p><strong>Total de Lacunas:</strong> ${this.data.gaps.length}</p>
                        <p><strong>Alta Prioridade:</strong> ${this.data.gaps.filter(g => g.priority === 'high').length}</p>
                        <p><strong>Esforço Total Estimado:</strong> ${this.data.gaps.reduce((sum, gap) => sum + (gap.effort || 0), 0)} horas</p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--accent2);">Plano de Ação</h4>
                        <p><strong>Total de Ações:</strong> ${this.data.actionPlan.length}</p>
                        <p><strong>Ações Planejadas:</strong> ${this.data.actionPlan.filter(a => a.status === 'planned').length}</p>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--accent2);">Recomendações</h4>
                        <ul>
                            <li>Priorizar lacunas de alta prioridade</li>
                            <li>Definir responsáveis para cada ação</li>
                            <li>Estabelecer cronograma detalhado</li>
                            <li>Implementar sistema de monitoramento</li>
                            <li>Revisar progresso regularmente</li>
                        </ul>
                    </div>
                `;

                this.showNotification('Relatório gerado com sucesso!', 'success');
            }

            exportPDF() {
                this.showNotification('Funcionalidade de exportação PDF em desenvolvimento.', 'info');
            }

            exportExcel() {
                this.showNotification('Funcionalidade de exportação Excel em desenvolvimento.', 'info');
            }

            getPriorityLabel(priority) {
                const labels = {
                    high: 'Alta',
                    medium: 'Média',
                    low: 'Baixa'
                };
                return labels[priority] || priority;
            }

            getImpactLabel(impact) {
                const labels = {
                    high: 'Alto',
                    medium: 'Médio',
                    low: 'Baixo'
                };
                return labels[impact] || impact;
            }

            getStatusLabel(status) {
                const labels = {
                    planned: 'Planejado',
                    inprogress: 'Em Andamento',
                    completed: 'Concluído',
                    cancelled: 'Cancelado'
                };
                return labels[status] || status;
            }

            saveData() {
                try {
                    localStorage.setItem('epqs_gap_analysis', JSON.stringify(this.data));
                    
                    // Integration with EPQS system
                    if (window.EPQS && typeof window.EPQS.saveData === 'function') {
                        window.EPQS.saveData('gap_analysis', this.data);
                    }
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            }

            loadData() {
                try {
                    // Try to load from EPQS system first
                    if (window.EPQS && typeof window.EPQS.loadData === 'function') {
                        const epqsData = window.EPQS.loadData('gap_analysis');
                        if (epqsData) {
                            this.data = epqsData;
                            return;
                        }
                    }

                    // Fallback to localStorage
                    const saved = localStorage.getItem('epqs_gap_analysis');
                    if (saved) {
                        this.data = JSON.parse(saved);
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
            }

            autoSave() {
                clearTimeout(this.autoSaveTimeout);
                this.autoSaveTimeout = setTimeout(() => {
                    this.saveData();
                }, 2000);
            }

            showNotification(message, type = 'info') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.style.display = 'block';

                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }
        }

        // Initialize the system
        const gapAnalysis = new GapAnalysisSystem();

        // Integration with EPQS system
        if (window.EPQS) {
            window.EPQS.registerTool('gap-analysis', {
                name: 'Análise de Lacunas',
                version: '1.0.0',
                description: 'Ferramenta para análise de lacunas entre estado atual e desejado',
                author: 'EPQS System',
                category: 'analysis'
            });
        }
    </script>
</body>
</html>
