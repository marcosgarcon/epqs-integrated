<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Process & Quality - Auditoria 5S</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
      :root{
        --bg:#0f172a; --panel:#111827; --muted:#1f2937; --card:#0b1220; --text:#e5e7eb; --accent:#22d3ee; --accent2:#a78bfa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
        --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial; background:linear-gradient(120deg,#0b1020,#0a1328); color:var(--text); display:grid; grid-template-columns:280px 1fr; grid-template-rows:auto 1fr; gap:0; }
      header{grid-column:1/3; display:flex; align-items:center; justify-content:space-between; padding:14px 20px; background:linear-gradient(90deg,#0b1020,#0a1a35); border-bottom:1px solid #1e293b; position:sticky; top:0; z-index:5}
      .header-title h1 { margin: 0; font-size: 20px; letter-spacing: .4px; color: var(--text); }
      .header-title .subtitle { margin: 4px 0 0 0; font-size: 14px; font-weight: normal; color: var(--accent); }
      .header-title .dev-credit { margin: 4px 0 0 0; font-size: 11px; font-weight: normal; color: #64748b; }
      header .actions{display:flex; flex-wrap: wrap; gap:8px}
      button, .btn{background:var(--muted); color:var(--text); border:1px solid #243041; border-radius:12px; padding:10px 14px; cursor:pointer; box-shadow:var(--shadow); transition:.2s; font-weight:600}
      button:hover, .btn:hover{transform:translateY(-1px); border-color:#334155}
      button.primary, .btn.primary{background:linear-gradient(180deg,#0ea5e9,#2563eb); border-color:transparent}
      button.ghost, .btn.ghost{background:transparent; border-color:#334155}
      aside{border-right:1px solid #1f2937; background:linear-gradient(180deg,#0b1020,#0a1328); padding:16px; display:flex; flex-direction:column; gap:24px; justify-content: space-between;}
      .menu{display:flex; flex-direction:column; gap:8px}
      .menu .tab-link{display:flex; gap:10px; align-items:center; text-decoration:none; color:#cbd5e1; padding:10px 12px; border:1px solid #1e293b; border-radius:12px; background:rgba(255,255,255,.02); cursor:pointer;}
      .menu .tab-link.active,.menu .tab-link:hover{border-color:#334155; background:rgba(34,211,238,.08); color:#e2e8f0}
      main{padding:18px; overflow:auto}
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      section{background:rgba(255,255,255,.03); border:1px solid #1f2937; border-radius:var(--radius); padding:16px; margin-bottom:18px; box-shadow:var(--shadow)}
      h2, h3{margin:0 0 12px 0; font-size:18px; color: var(--accent);}
      h4{margin:0 0 12px 0; font-size:16px; color: var(--accent2);}
      .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
      .field{display:flex; flex-direction:column; gap:6px}
      label{font-size:12px; color:#93c5fd}
      input, select, textarea{background:#0b1220; border:1px solid #243041; color:var(--text); padding:10px 12px; border-radius:10px; outline:none; font-family:inherit; font-size:14px;}
      .hidden { display: none !important; }
      .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
      .dashboard-card { background: var(--card); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid var(--muted); }
      .dashboard-card .value { font-size: 2rem; font-weight: bold; color: var(--accent); }
      .dashboard-card .label { font-size: 12px; color: #94a3b8; }
      .checklist-item { display: grid; grid-template-columns: 1fr 220px 1fr; gap: 15px; align-items: center; padding: 10px 0; border-bottom: 1px dashed var(--muted); }
      .checklist-item-model { display: grid; grid-template-columns: 1fr 100px; gap: 15px; align-items: center; padding: 8px 0; border-bottom: 1px dashed var(--muted); }
      .rating-group { display: flex; justify-content: space-around; background: var(--card); padding: 5px; border-radius: 8px; }
      .rating-group label { display: flex; flex-direction: column; align-items: center; cursor: pointer; font-size: 11px; padding: 4px; border-radius: 4px; }
      .rating-group input { display:none; }
      .rating-group input:checked + span { background: var(--accent); color: var(--bg); }
      .rating-group span { padding: 4px 8px; border-radius: 4px; }
      .audit-card { padding: 16px; border: 1px solid var(--muted); border-radius: var(--radius); margin-bottom: 12px; background: var(--card); }
      .audit-header { display: flex; justify-content: space-between; align-items: flex-start; }
      .audit-header h3 { color: var(--accent); font-size: 16px; margin: 0; }
      .action-item-block { padding: 12px; border: 1px solid var(--muted); border-radius: 12px; background: var(--card); position: relative; margin-top: 10px; }
      .remove-action-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; color: #fca5a5; font-size: 1.5rem; cursor: pointer;}
      #record-counter { background:rgba(255,255,255,.02); border:1px solid #1e293b; border-radius: 12px; padding: 12px;}
      #record-counter p { margin: 8px 0; color: #cbd5e1; display: flex; justify-content: space-between; }
      #record-counter span { font-weight: bold; color: var(--accent); }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 8px 12px; border: 1px solid var(--muted); text-align: left; font-size: 14px; }
      th { background: rgba(255,255,255,.05); }
      .help-content p, .help-content li { color: #cbd5e1; line-height: 1.6; }
      .help-content code { background: var(--muted); padding: 2px 6px; border-radius: 6px; font-family: monospace; color: var(--accent2); }
      .help-content ul { list-style-position: inside; padding-left: 10px; }
      .toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
      .toast { padding: 12px 18px; border-radius: 12px; color: white; font-weight: 600; font-size: 14px; box-shadow: var(--shadow); opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
      .toast.show { opacity: 1; transform: translateX(0); }
      .toast.success { background: linear-gradient(90deg, #22c55e, #16a34a); }
      .toast.error { background: linear-gradient(90deg, #ef4444, #dc2626); }
      .toast.info { background: linear-gradient(90deg, #3b82f6, #2563eb); }

      @media print {
        body { grid-template-columns: 1fr; color: #000; background: #fff; }
        header, aside, .hidden-print, #btn-cancel, button[type="submit"], #btn-add-action-plan, .remove-action-btn, .audit-header .actions { display: none !important; }
        main { padding: 0; overflow: visible; }
        section { border: 1px solid #ccc; box-shadow: none; background: #fff; page-break-inside: avoid;}
        input, select, textarea { border-color: #aaa; background: #f9f9f9; color: #000; }
        :root { --accent: #007bff; --accent2: #6f42c1; --text: #000; --card: #fff; }
        label, h2, h3, h4 { color: black; }
        .dashboard-card { border-color: #aaa; }
        .rating-group { display: none; }
      }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="header-title">
            <h1>Eng Process & Quality</h1>
            <p class="subtitle">Auditoria e Checklist 5S</p>
            <p class="dev-credit">Desenvolvido por Marcos Garçon</p>
        </div>
        <div class="actions">
            <button class="btn ghost" id="btn-restore-backup">Restaurar Backup (.json)</button>
            <button class="btn ghost" id="btn-download-backup">Baixar Backup (.json)</button>
            <button class="btn ghost" id="btn-archive-and-clear" style="color:var(--warn);">Arquivar e Limpar</button>
            <button class="btn primary" id="btn-export-pdf">Exportar PDF</button>
        </div>
    </header>

    <aside>
        <div>
            <div class="menu">
                 <a class="tab-link active" onclick="openTab(event, 'Dashboard')">Dashboard</a>
                 <a class="tab-link" onclick="openTab(event, 'Auditorias')">Auditorias Salvas</a>
                 <a class="tab-link" onclick="openTab(event, 'Modelo')">Modelo de Checklist</a>
                 <a class="tab-link" onclick="openTab(event, 'Ajuda')">Ajuda</a>
            </div>
        </div>
        <div id="record-counter">
            <h4>Registros</h4>
            <p>Auditorias Salvas: <span id="audit-count">0</span></p>
        </div>
    </aside>

    <main>
        <div id="Dashboard" class="tab-content active">
            <section>
                <h2>Dashboard de Resultados 5S</h2>
                <div class="dashboard-grid" id="kpi-cards">
                    <div class="dashboard-card"><div class="value" id="kpi-best-sector">-</div><div class="label">Melhor Setor</div></div>
                    <div class="dashboard-card"><div class="value" id="kpi-worst-sector">-</div><div class="label">Pior Setor</div></div>
                    <div class="dashboard-card"><div class="value" id="kpi-average-score">0%</div><div class="label">Média Geral</div></div>
                </div>
            </section>
            <section>
                <h4>Desempenho por Setor (Última Auditoria)</h4>
                <canvas id="sector-chart"></canvas>
            </section>
            <section>
                <h4>Ranking de Auditorias</h4>
                <table id="ranking-table">
                    <thead><tr><th>Ranking</th><th>Setor</th><th>Local</th><th>Data</th><th>Score</th></tr></thead>
                    <tbody></tbody>
                </table>
            </section>
        </div>
        <div id="Auditorias" class="tab-content">
            <button id="btn-new-audit" class="btn primary" style="margin-bottom: 18px;">+ Nova Auditoria 5S</button>
            <div id="audit-list-container"></div>
            <section id="form-section" class="hidden">
                <form id="5s-form">
                    <input type="hidden" id="audit-id">
                    <div class="grid">
                       <div class="col-3 field"><label for="audit-location">Local/Prédio</label><input type="text" id="audit-location" required></div>
                       <div class="col-3 field"><label for="audit-sector">Setor/Linha</label><input type="text" id="audit-sector" required></div>
                       <div class="col-3 field"><label for="audit-responsible">Responsável pela Área</label><input type="text" id="audit-responsible"></div>
                       <div class="col-2 field"><label for="auditor-name">Auditor</label><input type="text" id="auditor-name"></div>
                       <div class="col-1 field"><label for="audit-date">Data</label><input type="date" id="audit-date"></div>
                    </div>
                    <section style="margin-top: 20px;">
                        <h4>Resultados da Auditoria (Cálculo Automático)</h4>
                        <div class="dashboard-grid">
                            <div class="dashboard-card"><div class="value" id="score-Seiri">0%</div><div class="label">Seiri</div></div>
                            <div class="dashboard-card"><div class="value" id="score-Seiton">0%</div><div class="label">Seiton</div></div>
                            <div class="dashboard-card"><div class="value" id="score-Seiso">0%</div><div class="label">Seiso</div></div>
                            <div class="dashboard-card"><div class="value" id="score-Seiketsu">0%</div><div class="label">Seiketsu</div></div>
                            <div class="dashboard-card"><div class="value" id="score-Shitsuke">0%</div><div class="label">Shitsuke</div></div>
                            <div class="dashboard-card" style="border-color: var(--accent);"><div class="value" id="score-total">0%</div><div class="label">Pontuação Geral</div></div>
                        </div>
                    </section>
                    <section>
                        <h4>Checklist</h4>
                        <div id="checklist-container"></div>
                    </section>
                    <section>
                         <h4>Planos de Ação</h4>
                         <div id="action-plan-form-container"></div>
                         <button type="button" id="btn-add-action-plan" class="btn ghost">+ Adicionar Plano de Ação</button>
                    </section>
                    <div style="margin-top: 16px; display: flex; gap: 10px;">
                        <button type="submit" class="btn primary">Salvar Auditoria</button>
                        <button type="button" id="btn-cancel" class="btn ghost">Cancelar</button>
                    </div>
                </form>
            </section>
        </div>
        <div id="Modelo" class="tab-content">
            <section>
                <h2>Modelo de Checklist 5S (Customizável)</h2>
                <p>Adicione ou remova itens de checagem para cada Senso. Este modelo será usado em todas as novas auditorias.</p>
                <div id="checklist-model-container"></div>
            </section>
        </div>
        <div id="Ajuda" class="tab-content">
             <section class="help-content">
                <h2>Guia de Utilização - Auditoria 5S</h2>
                <h3>Dashboard</h3>
                <p>A tela inicial que apresenta os indicadores chave de performance (KPIs) de todas as auditorias salvas.</p>
                <ul>
                    <li><strong>Melhor/Pior Setor e Média:</strong> Mostra o setor com a maior e a menor pontuação geral, além da média de todas as auditorias.</li>
                    <li><strong>Desempenho por Setor:</strong> O gráfico de barras exibe a pontuação da <strong>última auditoria realizada</strong> em cada setor.</li>
                </ul>
                <h3>Auditorias</h3>
                <p>Nesta aba você gerencia suas auditorias.</p>
                <ul>
                    <li>Clique em <code>+ Nova Auditoria 5S</code> para abrir o formulário de preenchimento.</li>
                    <li>No <strong>Checklist</strong>, dê uma nota de 1 a 5 para cada item. As pontuações são calculadas automaticamente.</li>
                    <li>Na seção <strong>Planos de Ação</strong>, documente não-conformidades ou oportunidades de melhoria.</li>
                </ul>
                <h3>Modelo de Checklist</h3>
                <p>Esta seção permite que você personalize o checklist padrão usado nas auditorias para adequá-lo à sua realidade.</p>
                <ul>
                    <li>Você pode <code>Excluir</code> itens existentes e <code>Adicionar</code> novos.</li>
                    <li><strong>Importante:</strong> As alterações feitas aqui serão aplicadas <strong>apenas a novas auditorias</strong>.</li>
                </ul>
                <h3>Funcionalidades Avançadas</h3>
                <p>Use os botões no cabeçalho para gerenciar seus dados de forma segura e profissional, incluindo backups completos e arquivamento para manter a performance.</p>
            </section>
        </div>
    </main>
    
    <template id="action-plan-form-template">
        <div class="action-item-block">
            <button type="button" class="remove-action-btn">&times;</button>
            <div class="grid">
                <div class="col-12 field"><label>Ação Corretiva / Ponto de Melhoria</label><textarea class="action-input" rows="2" placeholder="Descreva a ação..."></textarea></div>
                <div class="col-4 field"><label>Responsável</label><input type="text" class="responsible-input"></div>
                <div class="col-2 field"><label>Status</label><select class="status-input"><option value="aberto">Aberto</option><option value="andamento">Em Andamento</option><option value="concluido">Concluído</option><option value="cancelado">Cancelado</option></select></div>
                <div class="col-2 field"><label>Data Início</label><input type="date" class="start-date-input"></div>
                <div class="col-2 field"><label>Data Final</label><input type="date" class="end-date-input"></div>
                <div class="col-2 field"><label>Nova Data</label><input type="date" class="new-date-input"></div>
            </div>
        </div>
    </template>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & DBs ---
        let audits = [];
        let checklistModel = [];
        let sectorChart = null;
        const DB_KEY = 'mg_5s_audits_v5';
        const MODEL_KEY = 'mg_5s_checklist_model_v2';
        
        // --- DOM Elements ---
        const main = document.querySelector('main');
        const formSection = document.getElementById('form-section');
        const form = document.getElementById('5s-form');
        const btnNewAudit = document.getElementById('btn-new-audit');
        const btnCancel = document.getElementById('btn-cancel');
        const auditListContainer = document.getElementById('audit-list-container');
        const auditCountSpan = document.getElementById('audit-count');
        const checklistModelContainer = document.getElementById('checklist-model-container');
        const checklistContainer = document.getElementById('checklist-container');
        const actionPlanFormContainer = document.getElementById('action-plan-form-container');
        const btnAddActionPlan = document.getElementById('btn-add-action-plan');
        const actionPlanFormTemplate = document.getElementById('action-plan-form-template');

        // --- Helper Functions ---
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        };
        
        // --- Data Persistence & Backup ---
        const saveData = () => {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(audits));
                localStorage.setItem(MODEL_KEY, JSON.stringify(checklistModel));
            } catch (e) { showToast('Erro: Não foi possível salvar os dados.', 'error'); }
        };

        const loadData = () => {
            audits = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            checklistModel = JSON.parse(localStorage.getItem(MODEL_KEY)) || [
                { s: 'Seiri', title: 'Senso de Utilização', items: ['Materiais/ferramentas desnecessários estão fora da área?', 'Itens obsoletos ou quebrados são descartados corretamente?'] },
                { s: 'Seiton', title: 'Senso de Organização', items: ['As ferramentas estão em locais definidos e identificados?', 'A identificação visual (etiquetas, etc) está clara e funcional?'] },
                { s: 'Seiso', title: 'Senso de Limpeza', items: ['O ambiente (piso, bancadas, máquinas) está visivelmente limpo?', 'Fontes de sujeira são tratadas na origem?'] },
                { s: 'Seiketsu', title: 'Senso de Padronização', items: ['Existem padrões visuais para organização e limpeza?', 'As responsabilidades pela manutenção do 5S estão claras?'] },
                { s: 'Shitsuke', title: 'Senso de Disciplina', items: ['A equipe segue os padrões do 5S consistentemente?', 'As melhorias das auditorias anteriores foram mantidas?'] }
            ];
        };

        const handleDownloadBackup = () => {
            const dataToSave = { audits, checklistModel };
            const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `5s_backup_${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
            showToast("Backup baixado!", "success");
        };

        const handleRestoreBackup = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    if (!confirm('Atenção: Restaurar um backup substituirá TODOS os dados atuais. Deseja continuar?')) return;
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.audits && data.checklistModel) {
                            audits = data.audits;
                            checklistModel = data.checklistModel;
                            saveData();
                            showToast('Backup restaurado com sucesso!');
                            setTimeout(() => window.location.reload(), 1000);
                        } else { throw new Error('Formato inválido.'); }
                    } catch (err) { showToast('Erro: Arquivo de backup inválido.', 'error'); }
                };
                reader.readAsText(file);
            };
            input.click();
        };
        
        const handleArchiveAndClear = () => {
            if (confirm("ATENÇÃO: Isso irá baixar um backup e depois APAGAR os dados do navegador. Deseja continuar?")) {
                handleDownloadBackup();
                localStorage.removeItem(DB_KEY);
                localStorage.removeItem(MODEL_KEY);
                showToast("Dados arquivados e limpos.", "info");
                setTimeout(() => window.location.reload(), 2000);
            }
        };

        // --- Tabs ---
        window.openTab = (evt, tabName) => {
            document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll(".tab-link").forEach(link => link.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
            if (tabName === 'Dashboard') {
                renderDashboard();
            }
        };

        // --- RENDER FUNCTIONS ---
        const renderDashboard = () => {
            const rankingTableBody = document.querySelector('#ranking-table tbody');
            const kpiBest = document.getElementById('kpi-best-sector');
            const kpiWorst = document.getElementById('kpi-worst-sector');
            const kpiAvg = document.getElementById('kpi-average-score');
            
            rankingTableBody.innerHTML = '';
            if (audits.length === 0) {
                kpiBest.textContent = '-';
                kpiWorst.textContent = '-';
                kpiAvg.textContent = '0%';
                if (sectorChart) { sectorChart.destroy(); sectorChart = null; }
                rankingTableBody.innerHTML = '<tr><td colspan="5">Nenhuma auditoria encontrada.</td></tr>';
                return;
            }
            const sortedAudits = [...audits].sort((a, b) => b.totalScore - a.totalScore);
            sortedAudits.forEach((audit, index) => {
                const row = rankingTableBody.insertRow();
                row.innerHTML = `<td>${index + 1}º</td><td>${audit.sector}</td><td>${audit.location}</td><td>${new Date(audit.date + 'T00:00:00').toLocaleDateString()}</td><td>${audit.totalScore.toFixed(0)}%</td>`;
            });
            kpiBest.textContent = sortedAudits[0].sector;
            kpiWorst.textContent = sortedAudits[sortedAudits.length - 1].sector;
            const avg = audits.reduce((acc, a) => acc + a.totalScore, 0) / audits.length;
            kpiAvg.textContent = `${avg.toFixed(0)}%`;
            const latestBySector = {};
            audits.forEach(audit => {
                if (!latestBySector[audit.sector] || new Date(audit.date) > new Date(latestBySector[audit.sector].date)) {
                    latestBySector[audit.sector] = audit;
                }
            });
            const chartData = Object.values(latestBySector).sort((a,b) => b.totalScore - a.totalScore);
            if (sectorChart) sectorChart.destroy();
            sectorChart = new Chart(document.getElementById('sector-chart'), {
                type: 'bar',
                data: {
                    labels: chartData.map(a => a.sector),
                    datasets: [{
                        label: 'Pontuação da Última Auditoria (%)',
                        data: chartData.map(a => a.totalScore),
                        backgroundColor: 'rgba(34, 211, 238, 0.6)',
                        borderColor: 'rgba(34, 211, 238, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                     indexAxis: 'y',
                     scales: { x: { beginAtZero: true, max: 100, ticks: { color: '#e5e7eb' } }, y: { ticks: { color: '#e5e7eb' } } },
                     plugins: { legend: { labels: { color: '#e5e7eb' } } }
                }
            });
        };
        
        const renderAuditList = () => {
            auditListContainer.innerHTML = '';
            if (audits.length === 0) {
                auditListContainer.innerHTML = '<section><p>Nenhuma auditoria salva. Clique em "+ Nova Auditoria 5S" para começar.</p></section>';
            } else {
                [...audits].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(audit => {
                    const card = document.createElement('div');
                    card.className = 'audit-card';
                    card.innerHTML = `
                        <div class="audit-header">
                            <div>
                                <h3>${audit.sector} (${audit.location})</h3>
                                <small>Auditor: ${audit.auditor || 'N/A'} | Data: ${new Date(audit.date + 'T00:00:00').toLocaleDateString()} | Score: ${audit.totalScore.toFixed(0)}%</small>
                            </div>
                            <div class="actions hidden-print">
                                <button class="btn ghost btn-edit" data-id="${audit.id}" style="padding: 5px 10px;">Editar</button>
                                <button class="btn ghost btn-delete" data-id="${audit.id}" style="padding: 5px 10px;">Excluir</button>
                            </div>
                        </div>
                    `;
                    auditListContainer.appendChild(card);
                });
            }
            auditCountSpan.textContent = audits.length;
        };

        const renderChecklistModel = () => {
            checklistModelContainer.innerHTML = '';
            checklistModel.forEach((senso, sensoIndex) => {
                const sensoDiv = document.createElement('div');
                sensoDiv.innerHTML = `<h4 style="border-bottom: 1px solid var(--muted); padding-bottom: 8px;">${senso.title} (${senso.s})</h4>`;
                const itemsList = document.createElement('div');
                senso.items.forEach((itemText, itemIndex) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'checklist-item-model';
                    itemDiv.innerHTML = `<span>${itemText}</span><button type="button" class="btn ghost btn-delete-model-item" data-senso-index="${sensoIndex}" data-item-index="${itemIndex}" style="padding: 5px 10px;">Excluir</button>`;
                    itemsList.appendChild(itemDiv);
                });
                sensoDiv.appendChild(itemsList);
                const newItemDiv = document.createElement('div');
                newItemDiv.innerHTML = `<div style="display:flex; gap:10px; margin-top:10px;"><input type="text" placeholder="Adicionar novo item..." class="new-item-input" style="flex-grow:1;"><button type="button" class="btn ghost btn-add-model-item" data-senso-index="${sensoIndex}">Adicionar</button></div>`;
                sensoDiv.appendChild(newItemDiv);
                checklistModelContainer.appendChild(sensoDiv);
            });
        };

        const renderAuditFormChecklist = (auditToLoad) => {
            const modelToUse = auditToLoad ? (auditToLoad.checklistModel || checklistModel) : checklistModel;
            const results = auditToLoad ? auditToLoad.results : [];
            checklistContainer.innerHTML = '';
            modelToUse.forEach((senso) => {
                const sensoDiv = document.createElement('div');
                sensoDiv.innerHTML = `<h4>${senso.title}</h4>`;
                senso.items.forEach((itemText, itemIndex) => {
                    const result = results.find(r => r.question === itemText);
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'checklist-item';
                    itemDiv.dataset.question = itemText;
                    itemDiv.dataset.senso = senso.s;
                    itemDiv.innerHTML = `
                        <p>${itemText}</p>
                        <div class="rating-group">
                            ${[1,2,3,4,5].map(n => `<label><input type="radio" name="${senso.s}-${itemIndex}" value="${n}" ${result && result.score == n ? 'checked' : ''}><span>${n}</span></label>`).join('')}
                        </div>
                        <input type="text" class="comment-input" placeholder="Comentário..." value="${result && result.comment ? result.comment : ''}">
                    `;
                    sensoDiv.appendChild(itemDiv);
                });
                checklistContainer.appendChild(sensoDiv);
            });
        };
        
        const calculateScores = () => {
            let totalScore = 0; let totalPossible = 0;
            const modelInUse = JSON.parse(form.dataset.modelInUse || JSON.stringify(checklistModel));
            modelInUse.forEach(senso => {
                let sensoScore = 0;
                let sensoItems = checklistContainer.querySelectorAll(`.checklist-item[data-senso="${senso.s}"]`);
                sensoItems.forEach(item => { const checkedRadio = item.querySelector('input[type="radio"]:checked'); if (checkedRadio) sensoScore += parseInt(checkedRadio.value); });
                const maxScore = sensoItems.length * 5;
                const percentage = maxScore > 0 ? (sensoScore / maxScore) * 100 : 0;
                document.getElementById(`score-${senso.s}`).textContent = `${percentage.toFixed(0)}%`;
                totalScore += sensoScore;
                totalPossible += maxScore;
            });
            const totalPercentage = totalPossible > 0 ? (totalScore / totalPossible) * 100 : 0;
            document.getElementById('score-total').textContent = `${totalPercentage.toFixed(0)}%`;
        };
        
        const showForm = () => { formSection.classList.remove('hidden'); btnNewAudit.classList.add('hidden'); auditListContainer.classList.add('hidden'); };
        const hideForm = () => { form.reset(); document.getElementById('audit-id').value = ''; checklistContainer.innerHTML = ''; actionPlanFormContainer.innerHTML = ''; formSection.classList.add('hidden'); btnNewAudit.classList.remove('hidden'); auditListContainer.classList.remove('hidden'); };

        // --- EVENT LISTENERS ---
        btnNewAudit.addEventListener('click', () => {
            hideForm(); 
            renderAuditFormChecklist(null); 
            calculateScores();
            document.getElementById('audit-date').value = new Date().toISOString().slice(0,10);
            form.removeAttribute('data-model-in-use');
            showForm();
        });

        btnCancel.addEventListener('click', hideForm);

        checklistModelContainer.addEventListener('click', e => {
            if(e.target.classList.contains('btn-delete-model-item')){ const { sensoIndex, itemIndex } = e.target.dataset; checklistModel[sensoIndex].items.splice(itemIndex, 1); saveData(); renderChecklistModel(); }
            if(e.target.classList.contains('btn-add-model-item')){ const { sensoIndex } = e.target.dataset; const input = e.target.previousElementSibling; if(input.value.trim()){ checklistModel[sensoIndex].items.push(input.value.trim()); input.value = ''; saveData(); renderChecklistModel(); } }
        });

        main.addEventListener('change', e => { if(e.target.type === 'radio'){ calculateScores(); } });
        main.addEventListener('click', e => { if(e.target.id === 'btn-add-action-plan'){ actionPlanFormContainer.appendChild(actionPlanFormTemplate.content.cloneNode(true)); } if(e.target.classList.contains('remove-action-btn')){ e.target.closest('.action-item-block').remove(); } });

        form.addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('audit-id').value;
            const results = [];
            checklistContainer.querySelectorAll('.checklist-item').forEach(item => { const checkedRadio = item.querySelector('input[type="radio"]:checked'); results.push({ question: item.dataset.question, senso: item.dataset.senso, score: checkedRadio ? parseInt(checkedRadio.value) : 0, comment: item.querySelector('.comment-input').value }); });
            const actionPlans = [];
            actionPlanFormContainer.querySelectorAll('.action-item-block').forEach(item => { actionPlans.push({ action: item.querySelector('.action-input').value, responsible: item.querySelector('.responsible-input').value, status: item.querySelector('.status-input').value, startDate: item.querySelector('.start-date-input').value, endDate: item.querySelector('.end-date-input').value, newDate: item.querySelector('.new-date-input').value }); });
            let totalScore = 0; results.forEach(r => { totalScore += r.score; });
            const maxTotalScore = results.length * 5;
            const modelForThisAudit = id ? JSON.parse(form.dataset.modelInUse) : checklistModel;
            const auditData = { id: id ? parseInt(id) : Date.now(), location: document.getElementById('audit-location').value, sector: document.getElementById('audit-sector').value, responsible: document.getElementById('audit-responsible').value, auditor: document.getElementById('auditor-name').value, date: document.getElementById('audit-date').value, totalScore: maxTotalScore > 0 ? (totalScore / maxTotalScore) * 100 : 0, results, actionPlans, checklistModel: modelForThisAudit };
            if(id) { const index = audits.findIndex(a => a.id == id); audits[index] = auditData; } else { audits.push(auditData); }
            saveData(); renderAuditList(); renderDashboard(); hideForm(); showToast("Auditoria salva!", "success");
        });
        
        auditListContainer.addEventListener('click', e => {
             if(e.target.classList.contains('btn-delete')){ const id = e.target.dataset.id; if(confirm('Tem certeza?')){ audits = audits.filter(a => a.id != id); saveData(); renderAuditList(); renderDashboard(); showToast("Auditoria excluída.", "success"); } }
            if(e.target.classList.contains('btn-edit')){
                hideForm();
                const audit = audits.find(a => a.id == e.target.dataset.id);
                form.dataset.modelInUse = JSON.stringify(audit.checklistModel || checklistModel);
                document.getElementById('audit-id').value = audit.id;
                document.getElementById('audit-location').value = audit.location; document.getElementById('audit-sector').value = audit.sector;
                document.getElementById('audit-responsible').value = audit.responsible; document.getElementById('auditor-name').value = audit.auditor;
                document.getElementById('audit-date').value = audit.date;
                renderAuditFormChecklist(audit); calculateScores();
                actionPlanFormContainer.innerHTML = '';
                if(audit.actionPlans && audit.actionPlans.length > 0){
                    audit.actionPlans.forEach(plan => {
                         const planClone = actionPlanFormTemplate.content.cloneNode(true);
                         const itemBlock = planClone.querySelector('.action-item-block');
                         itemBlock.querySelector('.action-input').value = plan.action; itemBlock.querySelector('.responsible-input').value = plan.responsible;
                         itemBlock.querySelector('.status-input').value = plan.status; itemBlock.querySelector('.start-date-input').value = plan.startDate;
                         itemBlock.querySelector('.end-date-input').value = plan.endDate; itemBlock.querySelector('.new-date-input').value = plan.newDate;
                         actionPlanFormContainer.appendChild(planClone);
                    });
                }
                showForm();
            }
        });
        
        document.getElementById('btn-export-pdf').addEventListener('click', () => { if (!formSection.classList.contains('hidden')) { window.print(); } else { showToast('Abra uma auditoria para exportar.', 'info'); } });
        document.getElementById('btn-download-backup').addEventListener('click', handleDownloadBackup);
        document.getElementById('btn-restore-backup').addEventListener('click', handleRestoreBackup);
        document.getElementById('btn-archive-and-clear').addEventListener('click', handleArchiveAndClear);

        // --- INITIALIZATION ---
        loadData();
        renderChecklistModel();
        renderAuditList();
        renderDashboard();
    });
    </script>
</body>
</html>