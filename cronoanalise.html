<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eng Process & Quality - Cronoanálise MTM</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
      :root{
        --bg:#0f172a; --panel:#111827; --muted:#1f2937; --card:#0b1220; --text:#e5e7eb; --accent:#22d3ee; --accent2:#a78bfa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
        --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial; background:linear-gradient(120deg,#0b1020,#0a1328); color:var(--text); display:grid; grid-template-columns:280px 1fr; grid-template-rows:auto 1fr; gap:0; }
      header{grid-column:1/3; display:flex; align-items:center; justify-content:space-between; padding:14px 20px; background:linear-gradient(90deg,#0b1020,#0a1a35); border-bottom:1px solid #1e293b; position:sticky; top:0; z-index:5}
      .header-title h1 { margin: 0; font-size: 20px; letter-spacing: .4px; color: var(--text); }
      .header-title .subtitle { margin: 4px 0 0 0; font-size: 14px; font-weight: normal; color: var(--accent); }
      .header-title .dev-credit { margin: 4px 0 0 0; font-size: 11px; font-weight: normal; color: #64748b; }
      header .actions{display:flex; flex-wrap: wrap; gap:8px}
      button, .btn{background:var(--muted); color:var(--text); border:1px solid #243041; border-radius:12px; padding:10px 14px; cursor:pointer; box-shadow:var(--shadow); transition:.2s; font-weight:600}
      button:hover, .btn:hover{transform:translateY(-1px); border-color:#334155}
      button.primary, .btn.primary{background:linear-gradient(180deg,#0ea5e9,#2563eb); border-color:transparent}
      button.ghost, .btn.ghost{background:transparent; border-color:#334155}
      aside{border-right:1px solid #1f2937; background:linear-gradient(180deg,#0b1020,#0a1328); padding:16px; display:flex; flex-direction:column; gap:24px; justify-content: space-between;}
      .menu{display:flex; flex-direction:column; gap:8px}
      .menu .tab-link{display:flex; gap:10px; align-items:center; text-decoration:none; color:#cbd5e1; padding:10px 12px; border:1px solid #1e293b; border-radius:12px; background:rgba(255,255,255,.02); cursor:pointer;}
      .menu .tab-link.active,.menu .tab-link:hover{border-color:#334155; background:rgba(34,211,238,.08); color:#e2e8f0}
      main{padding:18px; overflow:auto}
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      section{background:rgba(255,255,255,.03); border:1px solid #1f2937; border-radius:var(--radius); padding:16px; margin-bottom:18px; box-shadow:var(--shadow)}
      h2, h3{margin:0 0 12px 0; font-size:18px; color: var(--accent);}
      h4{margin:0 0 12px 0; font-size:16px; color: var(--accent2);}
      .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:12px}
      .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}
      .field{display:flex; flex-direction:column; gap:6px}
      label{font-size:12px; color:#93c5fd}
      input, select, textarea{background:#0b1220; border:1px solid #243041; color:var(--text); padding:10px 12px; border-radius:10px; outline:none; font-family:inherit; font-size:14px;}
      .hidden { display: none !important; }

      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 8px 12px; border: 1px solid var(--muted); text-align: left; font-size: 14px; vertical-align: middle;}
      th { background: rgba(255,255,255,.05); }
      tfoot td { font-weight: bold; background: rgba(34,211,238,.08); }
      .analysis-card { padding: 16px; border: 1px solid var(--muted); border-radius: var(--radius); margin-bottom: 12px; background: var(--card); }
      .analysis-header { display: flex; justify-content: space-between; align-items: flex-start; }
      video { width: 100%; border-radius: 8px; background: #000; }
      video[poster] { object-fit: contain; background-color: #000; }
      #crono-display { font-size: 3rem; font-weight: bold; text-align: center; color: var(--accent); background: var(--card); padding: 10px; border-radius: 8px; font-family: monospace; }
      #analysis-table input, #analysis-table select { padding: 4px 6px; font-size: 13px; width: 100%; }
      #mtm-database-table input { padding: 4px 6px; font-size: 13px; width: 100%; }
      .keypoint-cell img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid var(--muted); }
      .keypoint-cell .no-image { width: 80px; height: 60px; display:flex; align-items:center; justify-content:center; background: var(--muted); border-radius: 4px; font-size:11px; color: var(--text); }
      .action-plan-form-item { padding: 12px; border: 1px solid var(--muted); border-radius: 12px; background: var(--card); position: relative; margin-top: 10px;}
      .remove-action-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; color: #fca5a5; font-size: 1.5rem; cursor: pointer;}
      
      #fit-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center; }
      #fit-container { background: var(--bg); padding: 20px; border-radius: 16px; width: 90%; max-width: 1200px; height: 90vh; overflow-y: auto; border: 1px solid var(--muted); }
      .fit-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--muted); padding-bottom: 10px; margin-bottom: 20px;}
      .fit-step { display: grid; grid-template-columns: 200px 1fr; gap: 20px; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed var(--muted); }
      .fit-step img { width: 200px; border-radius: 8px; border: 1px solid var(--muted); }
      .fit-step-info h5 { margin: 0 0 10px 0; color: var(--accent); }
      .fit-step-info p { margin: 0; color: var(--text); }
      
      #record-counter { background:rgba(255,255,255,.02); border:1px solid #1e293b; border-radius: 12px; padding: 12px;}
      #record-counter p { margin: 8px 0; color: #cbd5e1; display: flex; justify-content: space-between; }
      #record-counter span { font-weight: bold; color: var(--accent); }
      
      .help-content h3 { color: var(--accent2); margin-top: 24px; margin-bottom: 10px; border-bottom: 1px solid var(--muted); padding-bottom: 5px; font-size: 16px; }
      .help-content p, .help-content li { color: #cbd5e1; line-height: 1.6; }
      .help-content code { background-color: var(--muted); padding: 2px 6px; border-radius: 4px; font-family: monospace; color: var(--accent); }
      .help-content ul { list-style-position: inside; padding-left: 10px; }
      .toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
      .toast { padding: 12px 18px; border-radius: 12px; color: white; font-weight: 600; font-size: 14px; box-shadow: var(--shadow); opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
      .toast.show { opacity: 1; transform: translateX(0); }
      .toast.success { background: linear-gradient(90deg, #22c55e, #16a34a); }
      .toast.error { background: linear-gradient(90deg, #ef4444, #dc2626); }
      .toast.info { background: linear-gradient(90deg, #3b82f6, #2563eb); }

      @media print {
        body { display: block; background: white; color: black; grid-template-columns: 1fr; }
        header, aside, .btn, .hidden-print, #form-section, #Ajuda, #analysis-list-container, #MtmDb, #fit-modal:not(.printable-fit) { display: none !important; }
        main, section { padding: 0; overflow: visible; box-shadow: none; border: none; }
        .fit-modal.printable-fit { display: block !important; position: static; width: 100%; height: auto; background: transparent; }
        .fit-modal.printable-fit #fit-container { width: 100%; height: auto; overflow: visible; background: transparent; padding: 0; border: none; }
        table { width: 100%; page-break-inside: auto; }
        tr { page-break-inside: avoid; page-break-after: auto; }
        th, td { border: 1px solid #ccc !important; }
        .fit-step { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; page-break-inside: avoid; }
        .fit-step img { max-width: 250px; }
        .fit-step-info p { color: black; }
        h1,h2,h3,h4,h5 { color: black; }
      }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="header-title">
            <h1>Eng Process & Quality</h1>
            <p class="subtitle">Cronoanálise e Folha de Instrução de Trabalho</p>
            <p class="dev-credit">Desenvolvido por Marcos Garçon</p>
        </div>
        <div class="actions">
            <button class="btn ghost" id="btn-restore-backup">Restaurar Backup (.json)</button>
            <button class="btn ghost" id="btn-download-backup">Baixar Backup (.json)</button>
            <button class="btn ghost" id="btn-archive-and-clear" style="color:var(--warn);">Arquivar e Limpar</button>
            <button class="btn primary" id="btn-export-pdf">Exportar FIT (PDF)</button>
        </div>
    </header>

    <aside>
        <div>
            <div class="menu">
                 <a class="tab-link active" onclick="openTab(event, 'Analise')">Cronoanálises Salvas</a>
                 <a class="tab-link" onclick="openTab(event, 'MtmDb')">Base de Dados MTM</a>
                 <a class="tab-link" onclick="openTab(event, 'Ajuda')">Ajuda</a>
            </div>
        </div>
        <div id="record-counter">
            <h4>Registros</h4>
            <p>Análises Salvas: <span id="analysis-count">0</span></p>
        </div>
    </aside>

    <main>
        <div id="Analise" class="tab-content active">
            <button id="btn-new-analysis" class="btn primary" style="margin-bottom: 18px;">+ Nova Cronoanálise</button>
            <div id="analysis-list-container"></div>
            <section id="form-section" class="hidden">
                <form id="crono-form">
                    <input type="hidden" id="analysis-id">
                    <div class="grid">
                       <div class="col-4 field"><label for="analysis-name">Nome da Análise / Processo</label><input type="text" id="analysis-name" required></div>
                       <div class="col-4 field"><label for="analyst-name">Nome do Analista</label><input type="text" id="analyst-name"></div>
                       <div class="col-4 field"><label for="analysis-date">Data da Análise</label><input type="date" id="analysis-date"></div>
                    </div>
                    <div class="grid" style="margin-top: 20px;">
                        <div class="col-8">
                            <video id="video-player" controls></video>
                            <div class="field" style="margin-top: 10px;"><label for="video-upload">Carregar vídeo:</label><input type="file" id="video-upload" accept="video/*"></div>
                        </div>
                        <div class="col-4">
                            <h4>Medição</h4>
                            <div id="crono-display">00:00.000</div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button type="button" id="btn-add-step" class="btn primary" style="flex-grow: 1;">+ Adicionar Etapa</button>
                                <button type="button" id="btn-view-fit" class="btn ghost">Visualizar FIT</button>
                            </div>
                        </div>
                    </div>
                    <section style="margin-top: 20px;">
                        <h4>Tabela de Tempos e Movimentos</h4>
                        <table id="analysis-table">
                            <thead><tr><th>Nº</th><th>Descrição da Etapa</th><th>Foto (Key Point)</th><th>Código MTM</th><th>Tipo</th><th>TMU</th><th>Fator (%)</th><th>TMU Corrig.</th><th>Tempo (s)</th><th class="hidden-print">Ação</th></tr></thead>
                            <tbody></tbody>
                            <tfoot><tr><td colspan="7"><strong>TOTAIS</strong></td><td id="total-tmu-corr"><strong>0.00</strong></td><td id="total-tempo-s"><strong>0.000</strong></td><td class="hidden-print"></td></tr></tfoot>
                        </table>
                    </section>
                    <section>
                         <h4>Planos de Ação e Melhorias</h4>
                         <div id="action-plan-form-container"></div>
                         <button type="button" id="btn-add-action-form" class="btn ghost">+ Adicionar Plano de Ação</button>
                    </section>
                    <div style="margin-top: 16px; display: flex; gap: 10px;">
                        <button type="submit" class="btn primary">Salvar Cronoanálise</button>
                        <button type="button" id="btn-cancel" class="btn ghost">Cancelar</button>
                    </div>
                </form>
            </section>
        </div>

        <div id="MtmDb" class="tab-content">
            <section>
                <h2>Base de Dados MTM (Editável Globalmente)</h2>
                <p>Adicione ou edite os códigos de movimento MTM. Estes valores estarão disponíveis em todas as suas cronoanálises.</p>
                <table id="mtm-database-table">
                    <thead><tr><th>Código</th><th>Tipo de Movimento</th><th>TMU Padrão</th><th class="hidden-print">Ação</th></tr></thead>
                    <tbody></tbody>
                </table>
                <div style="margin-top: 10px;"><button id="add-mtm-row" type="button" class="btn ghost">Adicionar Novo Código MTM</button></div>
            </section>
        </div>

        <div id="Ajuda" class="tab-content">
             <section class="help-content">
                <h2>Guia de Utilização - Cronoanálise e FIT</h2>
                <h3>Base de Dados MTM (Primeiros Passos)</h3>
                <p>Antes de iniciar uma análise, popule sua base de dados de movimentos MTM na aba <code>Base de Dados MTM</code>. Estes códigos estarão disponíveis na lista de seleção durante a cronoanálise.</p>
                <h3>Realizando uma Cronoanálise</h3>
                <ol>
                    <li>Na aba <code>Cronoanálises Salvas</code>, clique em <code>+ Nova Cronoanálise</code>.</li>
                    <li>Carregue o vídeo da operação.</li>
                    <li>Assista ao vídeo. Ao final de uma etapa, pause e clique em <code>+ Adicionar Etapa</code>.</li>
                    <li>Na nova linha, preencha a <code>Descrição</code> e selecione o <code>Código MTM</code>. Os tempos são calculados automaticamente.</li>
                </ol>
                <h3>Criando a FIT (Folha de Instrução de Trabalho)</h3>
                <ul>
                    <li>Durante a análise, pause o vídeo em um momento chave e clique em <code>Capturar Foto</code> na linha da etapa correspondente.</li>
                    <li>Após capturar as fotos, clique em <code>Visualizar FIT</code> para abrir a prévia da instrução de trabalho.</li>
                    <li>Com a FIT aberta, o botão <code>Exportar FIT (PDF)</code> no cabeçalho se torna funcional.</li>
                </ul>
            </section>
        </div>
        
        <div id="fit-modal" class="hidden-print">
            <div id="fit-container">
                <div class="fit-header">
                    <h2 id="fit-title">Folha de Instrução de Trabalho</h2>
                    <button id="close-fit-modal" class="btn ghost">&times;</button>
                </div>
                <div id="fit-steps-container"></div>
            </div>
        </div>
    </main>
    
    <template id="analysis-card-template">
      <section class="analysis-card">
          <div class="analysis-header">
              <div>
                  <h3 class="analysis-name"></h3>
                  <small class="analysis-details"></small>
              </div>
              <div class="actions">
                  <button class="btn ghost btn-edit" style="padding: 5px 10px;">Editar</button>
                  <button class="btn ghost btn-delete" style="padding: 5px 10px;">Excluir</button>
              </div>
          </div>
      </section>
    </template>
    
    <template id="action-plan-form-template">
        <div class="action-plan-form-item">
            <button type="button" class="remove-action-btn">&times;</button>
            <div class="grid">
                <div class="col-12 field"><label>Ação Corretiva / Ponto de Melhoria</label><textarea class="action-input" rows="2" placeholder="Descreva a ação..."></textarea></div>
                <div class="col-4 field"><label>Responsável</label><input type="text" class="responsible-input"></div>
                <div class="col-2 field"><label>Status</label><select class="status-input"><option value="aberto">Aberto</option><option value="andamento">Em Andamento</option><option value="concluido">Concluído</option><option value="cancelado">Cancelado</option></select></div>
                <div class="col-2 field"><label>Data Início</label><input type="date" class="start-date-input"></div>
                <div class="col-2 field"><label>Data Final</label><input type="date" class="end-date-input"></div>
                <div class="col-2 field"><label>Nova Data</label><input type="date" class="new-date-input"></div>
            </div>
        </div>
    </template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & DBs ---
        let state = {};
        let currentAnalysisSteps = [];
        const DB_KEY = 'mg_crono_v3';
        const VIDEO_PLACEHOLDER = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgNDUwIiBmaWxsPSIjMDYwYzE4Ij48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9InN5c3RlbS11aSIsIHNlc29lLXVpIiBmb250LXNpemU9IjI0cHgiIGZpbGw9IiNjYmQ1ZTEiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPjxzcGFuPkNhcnJlZ3VlIHVtIHbDrWRlbyBwYXJhIGNvbWXDp2FyPC9zcGFuPjwvdGV4dD48L3N2Zz4=";
        
        // --- DOM ELEMENTS ---
        const main = document.querySelector('main');
        const formSection = document.getElementById('form-section');
        const cronoForm = document.getElementById('crono-form');
        const btnNewAnalysis = document.getElementById('btn-new-analysis');
        const btnCancel = document.getElementById('btn-cancel');
        const analysisListContainer = document.getElementById('analysis-list-container');
        const analysisCardTemplate = document.getElementById('analysis-card-template');
        const analysisCountSpan = document.getElementById('analysis-count');
        const mtmDbTableBody = document.querySelector('#mtm-database-table tbody');
        const btnAddMtmRow = document.getElementById('add-mtm-row');
        const videoPlayer = document.getElementById('video-player');
        const videoUpload = document.getElementById('video-upload');
        const cronoDisplay = document.getElementById('crono-display');
        const btnAddStep = document.getElementById('btn-add-step');
        const analysisTableBody = document.querySelector('#analysis-table tbody');
        const actionPlanFormContainer = document.getElementById('action-plan-form-container');
        const btnAddActionForm = document.getElementById('btn-add-action-form');
        const actionPlanFormTemplate = document.getElementById('action-plan-form-template');
        const btnViewFit = document.getElementById('btn-view-fit');
        const fitModal = document.getElementById('fit-modal');
        const closeFitModal = document.getElementById('close-fit-modal');
        const fitStepsContainer = document.getElementById('fit-steps-container');
        const fitTitle = document.getElementById('fit-title');

        // --- Helper Functions ---
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        };
        
        // --- Data Persistence & Backup ---
        const saveData = () => { try { localStorage.setItem(DB_KEY, JSON.stringify(state)); } catch (e) { showToast('Erro ao salvar.', 'error'); } };
        const loadData = () => {
            const loadedState = JSON.parse(localStorage.getItem(DB_KEY));
            state = {
                analyses: loadedState?.analyses || [],
                mtmDatabase: loadedState?.mtmDatabase || [ { code: 'M10C', type: 'Mover Obj', tmu: 12.9 }, { code: 'G1A', type: 'Pegar Obj Pequeno', tmu: 2.0 }, { code: 'RL1', type: 'Soltar Obj', tmu: 2.0 } ]
            };
        };
        const handleDownloadBackup = () => { const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'}); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `backup_cronoanalise_${new Date().toISOString().slice(0,10)}.json`; link.click(); URL.revokeObjectURL(link.href); showToast("Backup baixado!", "success"); };
        const handleRestoreBackup = () => { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = event => { if (!confirm("Isso irá substituir TODOS os dados atuais. Deseja continuar?")) return; try { state = JSON.parse(event.target.result); saveData(); showToast("Backup restaurado!", "success"); setTimeout(() => window.location.reload(), 1000); } catch(err) { showToast("Erro ao ler o arquivo.", "error"); } }; reader.readAsText(file); }; input.click(); };
        const handleArchiveAndClear = () => { if (confirm("ATENÇÃO: Isso irá baixar um backup e depois APAGAR os dados do navegador. Deseja continuar?")) { handleDownloadBackup(); localStorage.removeItem(DB_KEY); showToast("Dados arquivados e limpos.", "info"); setTimeout(() => window.location.reload(), 2000); } };

        // --- Tabs ---
        window.openTab = (evt, tabName) => {
            document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
            evt.currentTarget.classList.add('active');
        };

        // --- Core Application Logic ---
        const showForm = () => { formSection.classList.remove('hidden'); btnNewAnalysis.classList.add('hidden'); analysisListContainer.classList.add('hidden'); };
        const hideForm = () => { cronoForm.reset(); document.getElementById('analysis-id').value = ''; analysisTableBody.innerHTML = ''; actionPlanFormContainer.innerHTML = ''; videoPlayer.src = ''; videoPlayer.poster = VIDEO_PLACEHOLDER; videoUpload.value = ''; currentAnalysisSteps = []; updateTotals(); formSection.classList.add('hidden'); btnNewAnalysis.classList.remove('hidden'); analysisListContainer.classList.remove('hidden'); };
        const updateTotals = () => { let totalTmuCorr = 0; analysisTableBody.querySelectorAll('tr').forEach(row => { const tmuCorrText = row.querySelector('.step-tmu-corr').textContent; totalTmuCorr += parseFloat(tmuCorrText) || 0; }); const totalTempoS = totalTmuCorr * 0.036; document.getElementById('total-tmu-corr').textContent = totalTmuCorr.toFixed(2); document.getElementById('total-tempo-s').textContent = totalTempoS.toFixed(3); };
        const renderMtmDb = () => {
            mtmDbTableBody.innerHTML = '';
            state.mtmDatabase.forEach((item, index) => {
                const row = mtmDbTableBody.insertRow();
                row.innerHTML = `<td><input type="text" value="${item.code}" data-prop="code" data-index="${index}"></td><td><input type="text" value="${item.type}" data-prop="type" data-index="${index}"></td><td><input type="number" step="0.1" value="${item.tmu}" data-prop="tmu" data-index="${index}"></td><td class="hidden-print"><button type="button" class="btn ghost btn-delete-mtm" data-index="${index}" style="padding: 5px 10px;">Excluir</button></td>`;
            });
        };
        const renderAnalysesList = () => {
            analysisListContainer.innerHTML = '';
             if (state.analyses.length === 0) { analysisListContainer.innerHTML = '<section><p>Nenhuma análise salva. Clique em "+ Nova Cronoanálise" para começar.</p></section>'; } else {
                [...state.analyses].sort((a,b) => b.id - a.id).forEach(analysis => {
                    const cardClone = analysisCardTemplate.content.cloneNode(true);
                    const card = cardClone.querySelector('.analysis-card');
                    card.dataset.id = analysis.id; card.querySelector('.analysis-name').textContent = analysis.name;
                    const analysisDate = analysis.date ? new Date(analysis.date + 'T00:00:00').toLocaleDateString() : 'N/A';
                    card.querySelector('.analysis-details').textContent = `Analista: ${analysis.analyst || 'N/A'} - Data: ${analysisDate}`;
                    analysisListContainer.appendChild(cardClone);
                });
            }
            analysisCountSpan.textContent = state.analyses.length;
        };
        const renderAnalysisTable = () => {
            analysisTableBody.innerHTML = '';
            currentAnalysisSteps.forEach((step, index) => {
                const row = analysisTableBody.insertRow(); row.dataset.id = step.id;
                const mtmOptions = state.mtmDatabase.map(item => `<option value="${item.code}" ${item.code === step.mtmCode ? 'selected' : ''}>${item.code} - ${item.type}</option>`).join('');
                row.innerHTML = `<td>${index + 1}</td><td><input type="text" class="step-description" value="${step.description}"></td><td class="keypoint-cell">${step.keypointImage ? `<img src="${step.keypointImage}" alt="Keypoint">` : '<div class="no-image">Sem Foto</div>'}<button type="button" class="btn ghost btn-capture hidden-print" style="width:100%; font-size:11px; padding: 2px 4px; margin-top: 4px;">Capturar Foto</button></td><td><select class="step-mtm-code"><option value="">-</option>${mtmOptions}</select></td><td><input type="text" class="step-type" value="${step.type}" readonly></td><td><input type="number" step="0.1" class="step-tmu" value="${step.tmu}" readonly></td><td><input type="number" class="step-factor" value="${step.factor}" step="1"></td><td class="step-tmu-corr">0.00</td><td class="step-tempo-s">0.000</td><td class="hidden-print"><button type="button" class="btn ghost btn-delete-step">Excluir</button></td>`;
                updateStepCalculations(row);
            });
            updateTotals();
        };
        const updateStepCalculations = (row) => { const stepId = row.dataset.id; const step = currentAnalysisSteps.find(s => s.id == stepId); if(!step) return; const tmu = parseFloat(step.tmu) || 0; const factor = parseFloat(step.factor) || 100; const tmuCorr = tmu * (factor / 100); const tempoS = tmuCorr * 0.036; row.querySelector('.step-tmu-corr').textContent = tmuCorr.toFixed(2); row.querySelector('.step-tempo-s').textContent = tempoS.toFixed(3); };
        
        // --- EVENT LISTENERS ---
        btnNewAnalysis.addEventListener('click', () => { hideForm(); document.getElementById('analysis-date').value = new Date().toISOString().slice(0,10); showForm(); });
        btnCancel.addEventListener('click', hideForm);
        btnAddMtmRow.addEventListener('click', () => { state.mtmDatabase.push({ code: 'NOVO', type: '', tmu: 0 }); renderMtmDb(); });
        mtmDbTableBody.addEventListener('change', (e) => { const index = e.target.dataset.index; const prop = e.target.dataset.prop; state.mtmDatabase[index][prop] = e.target.value; saveData(); });
        mtmDbTableBody.addEventListener('click', (e) => { if (e.target.classList.contains('btn-delete-mtm')) { if(confirm('Tem certeza?')){ state.mtmDatabase.splice(e.target.dataset.index, 1); saveData(); renderMtmDb(); } } });
        videoUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) { videoPlayer.poster = ''; videoPlayer.src = URL.createObjectURL(file); } });
        videoPlayer.addEventListener('timeupdate', () => { const time = videoPlayer.currentTime; const minutes = Math.floor(time / 60).toString().padStart(2, '0'); const seconds = Math.floor(time % 60).toString().padStart(2, '0'); const milliseconds = Math.floor((time % 1) * 1000).toString().padStart(3, '0'); cronoDisplay.textContent = `${minutes}:${seconds}.${milliseconds}`; });
        btnAddStep.addEventListener('click', () => { const newStep = { id: Date.now(), description: '', keypointImage: null, mtmCode: '', type: '', tmu: 0, factor: 100 }; currentAnalysisSteps.push(newStep); renderAnalysisTable(); });
        analysisTableBody.addEventListener('change', (e) => { const row = e.target.closest('tr'); if(!row) return; const stepId = row.dataset.id; const step = currentAnalysisSteps.find(s => s.id == stepId); if(!step) return; if (e.target.classList.contains('step-description')) step.description = e.target.value; if (e.target.classList.contains('step-factor')) step.factor = e.target.value; if (e.target.classList.contains('step-mtm-code')) { const selectedCode = e.target.value; const mtmItem = state.mtmDatabase.find(item => item.code === selectedCode); step.mtmCode = selectedCode; step.type = mtmItem ? mtmItem.type : ''; step.tmu = mtmItem ? mtmItem.tmu : 0; row.querySelector('.step-type').value = step.type; row.querySelector('.step-tmu').value = step.tmu; } updateStepCalculations(row); updateTotals(); });
        analysisTableBody.addEventListener('click', (e) => { const row = e.target.closest('tr'); if(!row) return; const stepId = row.dataset.id; if (e.target.classList.contains('btn-delete-step')) { currentAnalysisSteps = currentAnalysisSteps.filter(s => s.id != stepId); renderAnalysisTable(); } if (e.target.classList.contains('btn-capture')) { if (!videoPlayer.src || videoPlayer.networkState === 3) { showToast("Carregue um vídeo para capturar a imagem.", "info"); return; } const step = currentAnalysisSteps.find(s => s.id == stepId); const canvas = document.createElement('canvas'); canvas.width = videoPlayer.videoWidth; canvas.height = videoPlayer.videoHeight; const ctx = canvas.getContext('2d'); ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height); step.keypointImage = canvas.toDataURL('image/jpeg', 0.8); row.querySelector('.keypoint-cell').innerHTML = `<img src="${step.keypointImage}" alt="Keypoint"><button type="button" class="btn ghost btn-capture hidden-print" style="width:100%; font-size:11px; padding: 2px 4px; margin-top: 4px;">Capturar Foto</button>`; } });
        btnAddActionForm.addEventListener('click', () => { actionPlanFormContainer.appendChild(actionPlanFormTemplate.content.cloneNode(true)); });
        main.addEventListener('click', e => { if(e.target.classList.contains('remove-action-btn')) { e.target.closest('.action-plan-form-item').remove(); } });
        cronoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('analysis-id').value;
            const actionPlans = []; actionPlanFormContainer.querySelectorAll('.action-plan-form-item').forEach(item => { actionPlans.push({ action: item.querySelector('.action-input').value, responsible: item.querySelector('.responsible-input').value, status: item.querySelector('.status-input').value, startDate: item.querySelector('.start-date-input').value, endDate: item.querySelector('.end-date-input').value, newDate: item.querySelector('.new-date-input').value, }); });
            const analysisData = { name: document.getElementById('analysis-name').value, analyst: document.getElementById('analyst-name').value, date: document.getElementById('analysis-date').value, steps: currentAnalysisSteps, actionPlans: actionPlans };
            if(id) { const index = state.analyses.findIndex(a => a.id == id); state.analyses[index] = { ...analysisData, id: parseInt(id) }; showToast('Análise atualizada!', 'success'); } else { analysisData.id = Date.now(); state.analyses.push(analysisData); showToast('Análise salva!', 'success'); }
            saveData(); renderAnalysesList(); hideForm();
        });
        analysisListContainer.addEventListener('click', (e) => { const card = e.target.closest('.analysis-card'); if (!card) return; const id = card.dataset.id; if (e.target.classList.contains('btn-delete')) { if(confirm('Tem certeza?')) { state.analyses = state.analyses.filter(a => a.id != id); saveData(); renderAnalysesList(); } } if (e.target.classList.contains('btn-edit')) { hideForm(); const analysis = state.analyses.find(a => a.id == id); document.getElementById('analysis-id').value = analysis.id; document.getElementById('analysis-name').value = analysis.name; document.getElementById('analyst-name').value = analysis.analyst; document.getElementById('analysis-date').value = analysis.date; currentAnalysisSteps = analysis.steps || []; renderAnalysisTable(); actionPlanFormContainer.innerHTML = ''; if(analysis.actionPlans) { analysis.actionPlans.forEach(plan => { const planClone = actionPlanFormTemplate.content.cloneNode(true); const itemBlock = planClone.querySelector('.action-plan-form-item'); itemBlock.querySelector('.action-input').value = plan.action; itemBlock.querySelector('.responsible-input').value = plan.responsible; itemBlock.querySelector('.status-input').value = plan.status; itemBlock.querySelector('.start-date-input').value = plan.startDate; itemBlock.querySelector('.end-date-input').value = plan.endDate; itemBlock.querySelector('.new-date-input').value = plan.newDate; actionPlanFormContainer.appendChild(planClone); }); } showForm(); } });
        btnViewFit.addEventListener('click', () => { fitTitle.textContent = `Folha de Instrução: ${document.getElementById('analysis-name').value}`; fitStepsContainer.innerHTML = ''; currentAnalysisSteps.forEach((step, index) => { const stepDiv = document.createElement('div'); stepDiv.className = 'fit-step'; stepDiv.innerHTML = `<img src="${step.keypointImage || 'https://via.placeholder.com/200x150?text=Sem+Foto'}" alt="Etapa ${index+1}"><div class="fit-step-info"><h5>Etapa ${index + 1}</h5><p>${step.description}</p></div>`; fitStepsContainer.appendChild(stepDiv); }); fitModal.style.display = 'flex'; });
        closeFitModal.addEventListener('click', () => fitModal.style.display = 'none');
        document.getElementById('btn-export-pdf').addEventListener('click', () => { if(fitModal.style.display === 'flex') { fitModal.classList.add('printable-fit'); window.print(); fitModal.classList.remove('printable-fit'); } else { showToast('Para exportar, primeiro clique em "Visualizar FIT".', 'info'); } });
        
        // --- INITIALIZATION ---
        loadData();
        videoPlayer.poster = VIDEO_PLACEHOLDER;
        renderMtmDb();
        renderAnalysesList();
    });
    </script>
</body>
</html>