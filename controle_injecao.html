<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Inje√ß√£o de Pl√°sticos</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
      :root{
        --bg:#0f172a; --panel:#111827; --muted:#1f2937; --card:#0b1220; --text:#e5e7eb; --accent:#22d3ee; --accent2:#a78bfa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
        --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial; background:linear-gradient(120deg,#0b1020,#0a1328); color:var(--text); display:grid; grid-template-columns:280px 1fr; grid-template-rows:auto 1fr; gap:0; }
      header{grid-column:1/3; display:flex; align-items:center; justify-content:space-between; padding:14px 20px; background:linear-gradient(90deg,#0b1020,#0a1a35); border-bottom:1px solid #1e293b; position:sticky; top:0; z-index:5}
      .header-title h1 { margin: 0; font-size: 20px; letter-spacing: .4px; color: var(--text); }
      .header-title .subtitle { margin: 4px 0 0 0; font-size: 14px; font-weight: normal; color: var(--accent); }
      .header-title .dev-credit { margin: 4px 0 0 0; font-size: 11px; font-weight: normal; color: #64748b; }
      header .actions{display:flex; flex-wrap: wrap; gap:8px}
      button, .btn{background:var(--muted); color:var(--text); border:1px solid #243041; border-radius:12px; padding:10px 14px; cursor:pointer; box-shadow:var(--shadow); transition:.2s; font-weight:600}
      button:hover, .btn:hover{transform:translateY(-1px); border-color:#334155}
      button.primary{background:linear-gradient(180deg,#0ea5e9,#2563eb); border-color:transparent}
      button.ghost{background:transparent; border-color:#334155}
      aside{border-right:1px solid #1f2937; background:linear-gradient(180deg,#0b1020,#0a1328); padding:16px; display:flex; flex-direction:column; gap:24px; justify-content: space-between;}
      .menu{display:flex; flex-direction:column; gap:8px}
      .menu .tab-link{display:flex; gap:10px; align-items:center; text-decoration:none; color:#cbd5e1; padding:10px 12px; border:1px solid #1e293b; border-radius:12px; background:rgba(255,255,255,.02); cursor:pointer;}
      .menu .tab-link.active,.menu .tab-link:hover{border-color:#334155; background:rgba(34,211,238,.08); color:#e2e8f0}
      main{padding:18px; overflow:auto}
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      section{background:rgba(255,255,255,.03); border:1px solid #1f2937; border-radius:var(--radius); padding:16px; margin-bottom:18px; box-shadow:var(--shadow)}
      h2, h3{margin:0 0 12px 0; font-size:18px; color: var(--accent);}
      h4{margin:0 0 12px 0; font-size:16px; color: var(--accent2);}
      .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
      .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-2{grid-column:span 2} .col-12{grid-column:span 12}
      @media(max-width: 900px){ .col-6,.col-4,.col-3, .col-2{grid-column:span 6} }
      @media(max-width: 600px){ .col-6,.col-4,.col-3, .col-2{grid-column:span 12} }
      .field{display:flex; flex-direction:column; gap:6px}
      label{font-size:12px; color:#93c5fd}
      input, select, textarea{background:#0b1220; border:1px solid #243041; color:var(--text); padding:10px 12px; border-radius:10px; outline:none; font-family: inherit; font-size:14px;}
      .hidden { display: none !important; }
      table{width:100%; border-collapse:collapse;}
      th, td { padding: 8px 12px; border-bottom: 1px solid var(--muted); text-align: left; font-size: 13px; vertical-align: middle; }
      th { background: rgba(255,255,255,.05); }
      tbody tr:hover { background: rgba(34,211,238,.04); }
      .kpi-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:16px;}
      .kpi-card { background: var(--card); border-radius: var(--radius); padding: 16px; text-align: center; }
      .kpi-card h3 { font-size: 12px; color: var(--accent2); margin:0 0 8px 0; font-weight:normal; text-transform: uppercase;}
      .kpi-card .kpi-value { font-size: 2rem; font-weight: bold; color:var(--accent); }
      .kpi-ok{color:var(--ok)!important} .kpi-warn{color:var(--warn)!important} .kpi-bad{color:var(--bad)!important}
      .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; }
      .modal-content { background: var(--bg); padding: 24px; border-radius: 16px; width: 90%; max-width: 400px; border: 1px solid var(--muted); text-align: center; }
      .autocomplete-container { position: relative; }
      .autocomplete-list { position: absolute; top: 100%; left: 0; right: 0; z-index: 10; background: var(--panel); border: 1px solid var(--muted); border-radius: 10px; max-height: 200px; overflow-y: auto; margin-top: 4px; }
      .autocomplete-item { padding: 10px 12px; cursor: pointer; font-size: 14px; text-align: left; }
      .autocomplete-item:hover { background: var(--muted); }
      .autocomplete-item.is-new { font-style: italic; color: var(--accent); }
      #toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; }
      .toast { padding: 12px 18px; border-radius: 12px; color: white; font-weight: 600; font-size: 14px; box-shadow: var(--shadow); opacity: 0; transform: translateX(100%); transition: all 0.4s ease; }
      .toast.show { opacity: 1; transform: translateX(0); }
      .toast.success { background: linear-gradient(90deg, #22c55e, #16a34a); }
      .toast.error { background: linear-gradient(90deg, #ef4444, #dc2626); }
      .toast.info { background: linear-gradient(90deg, #3b82f6, #2563eb); }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <header>
        <div class="header-title">
            <h1>Eng Process & Quality</h1>
            <p class="subtitle">Controle de Inje√ß√£o de Pl√°sticos</p>
            <p class="dev-credit">Desenvolvido por Marcos Gar√ßon</p>
        </div>
        <div class="actions">
            <button class="btn ghost" id="btn-restore-backup">Restaurar Backup (.json)</button>
            <button class="btn ghost" id="btn-download-backup">Baixar Backup (.json)</button>
            <button class="btn ghost" id="btn-archive-and-clear" style="color:var(--warn);">Arquivar e Limpar</button>
        </div>
    </header>
    <aside>
        <div>
            <div class="menu">
                 <a class="tab-link active" onclick="openTab(event, 'Material')">üì¶ Material</a>
                 <a class="tab-link" onclick="openTab(event, 'Processo')">‚öôÔ∏è M√°quina & Processo</a>
                 <a class="tab-link" onclick="openTab(event, 'Producao')">üßæ Lote / Produ√ß√£o</a>
                 <a class="tab-link" onclick="openTab(event, 'Qualidade')">üß™ Controle de Qualidade</a>
                 <a class="tab-link" onclick="openTab(event, 'Defeitos')">üö® Defeitos & A√ß√µes</a>
                 <a class="tab-link" onclick="openTab(event, 'Cadastros')">üó≥Ô∏è Cadastros</a>
                 <a class="tab-link" onclick="openTab(event, 'Ajuda')">‚ùì Ajuda</a>
            </div>
        </div>
    </aside>
    <main>
        <div id="Material" class="tab-content active">
            <section>
                <h4>Dados do Pol√≠mero / Material</h4>
                <form id="form-material" autocomplete="off">
                    <input type="hidden" id="mat_id">
                    <div class="grid">
                        <div class="field col-4"><label>Tipo de pol√≠mero</label><input id="mat_tipo" placeholder="PP, ABS, PA6..." required/></div>
                        <div class="field col-4"><label>Fornecedor</label><input id="mat_fornecedor"/></div>
                        <div class="field col-4"><label>C√≥digo/Lote</label><input id="mat_lote" /></div>
                        <div class="field col-3"><label>Data de fabrica√ß√£o</label><input id="mat_fabricacao" type="date"/></div>
                        <div class="field col-3"><label>Data de recebimento</label><input id="mat_recebimento" type="date"/></div>
                        <div class="field col-3"><label>Secagem (¬∞C / h)</label><input id="mat_secagem" placeholder="80¬∞C / 3h"/></div>
                        <div class="field col-3"><label>Observa√ß√µes</label><input id="mat_obs" placeholder="Aditivos, etc."/></div>
                    </div>
                    <div style="margin-top:16px; display:flex; gap:10px;">
                        <button type="submit" class="primary">Salvar Material</button>
                        <button type="button" class="ghost" id="btn-clear-mat">Limpar</button>
                    </div>
                </form>
            </section>
            <section>
                <h4>Materiais Cadastrados</h4>
                <div style="max-height:300px; overflow:auto">
                    <table ><thead><tr><th>Tipo</th><th>Fornecedor</th><th>Lote</th><th>Fabrica√ß√£o</th><th>Recebimento</th><th>Secagem</th><th>A√ß√µes</th></tr></thead><tbody id="tblMaterial"></tbody></table>
                </div>
            </section>
        </div>

        <div id="Processo" class="tab-content">
            <section>
                <h4>Par√¢metros da M√°quina & Processo</h4>
                <form id="form-processo" autocomplete="off">
                    <input type="hidden" id="proc_id">
                    <div class="grid">
                        <div class="field col-3 autocomplete-container"><label>M√°quina</label><input id="proc_maquina" required/></div>
                        <div class="field col-3 autocomplete-container"><label>Molde</label><input id="proc_molde" /></div>
                        <div class="field col-3"><label>Material (Lote)</label><input id="proc_material" placeholder="PP L2309-001"/></div>
                        <div class="field col-3"><label>Operador</label><input id="proc_operador" /></div>
                        <div class="field col-3"><label>Temp. Cilindro (¬∞C)</label><input id="proc_t_cil" /></div>
                        <div class="field col-3"><label>Temp. Bico (¬∞C)</label><input id="proc_t_bico" /></div>
                        <div class="field col-3"><label>Temp. Molde (¬∞C)</label><input id="proc_t_molde" /></div>
                        <div class="field col-3"><label>Press√£o Inje√ß√£o (bar)</label><input id="proc_p_inj" /></div>
                        <div class="field col-3"><label>Press√£o Recalque (bar)</label><input id="proc_p_rec" /></div>
                        <div class="field col-3"><label>Vel. Inje√ß√£o (%)</label><input id="proc_v_inj" /></div>
                        <div class="field col-3"><label>Tempo Resfriam. (s)</label><input id="proc_t_resf" /></div>
                        <div class="field col-3"><label>Tempo Ciclo (s)</label><input id="proc_ciclo" /></div>
                        <div class="field col-12"><label>Observa√ß√µes de Setup</label><textarea id="proc_obs"></textarea></div>
                    </div>
                    <div style="margin-top:16px; display:flex; gap:10px;">
                        <button type="submit" class="primary">Salvar Par√¢metros</button>
                        <button type="button" class="ghost" id="btn-clear-proc">Limpar</button>
                    </div>
                </form>
            </section>
            <section>
                <h4>Hist√≥rico de Par√¢metros</h4>
                <div style="max-height:300px; overflow:auto">
                    <table><thead><tr><th>M√°quina</th><th>Molde</th><th>Material</th><th>Ciclo (s)</th><th>Operador</th><th>A√ß√µes</th></tr></thead><tbody id="tblProcesso"></tbody></table>
                </div>
            </section>
        </div>

        <div id="Producao" class="tab-content">
             <section>
                <h4>Lote de Produ√ß√£o</h4>
                <form id="form-producao" autocomplete="off">
                    <input type="hidden" id="lote_id">
                     <div class="grid">
                        <div class="field col-3"><label>Ordem / Lote</label><input id="lote_codigo" placeholder="OP-2025-001" required/></div>
                        <div class="field col-3 autocomplete-container"><label>Pe√ßa / C√≥digo</label><input id="lote_peca"/></div>
                        <div class="field col-3"><label>Cavidades</label><input id="lote_cav" type="number" min="1" value="1"/></div>
                        <div class="field col-3"><label>Qtde Produzida</label><input id="lote_produzido" type="number" min="0" value="0"/></div>
                        <div class="field col-3"><label>Data In√≠cio</label><input id="lote_inicio" type="datetime-local"/></div>
                        <div class="field col-3"><label>Data Fim</label><input id="lote_fim" type="datetime-local"/></div>
                        <div class="field col-3"><label>Refugo (pe√ßas)</label><input id="lote_refugo" type="number" min="0" value="0"/></div>
                        <div class="field col-3"><label>Turno</label><select id="lote_turno"><option>1¬∫</option><option>2¬∫</option><option>3¬∫</option></select></div>
                        <div class="field col-12"><label>Observa√ß√µes</label><textarea id="lote_obs" placeholder="Paradas, troca de cor, etc."></textarea></div>
                    </div>
                    <div style="margin-top:16px; display:flex; gap:10px;">
                        <button type="submit" class="primary">Salvar Lote</button>
                        <button type="button" class="ghost" id="btn-clear-lote">Limpar</button>
                    </div>
                </form>
            </section>
            <section>
                <h4>Indicadores do Lote (Estimativa com base no √∫ltimo ciclo salvo)</h4>
                 <div class="kpi-grid">
                  <div class="kpi-card"><h3>Produtividade</h3><b class="kpi-value" id="kpiProd">‚Äì p√ßs/h</b></div>
                  <div class="kpi-card"><h3>Aproveitamento</h3><b class="kpi-value" id="kpiYield">‚Äì %</b></div>
                  <div class="kpi-card"><h3>Taxa de Refugo</h3><b class="kpi-value" id="kpiScrap">‚Äì %</b></div>
                </div>
            </section>
            <section>
                <h4>Hist√≥rico de Lotes</h4>
                <div style="max-height:300px; overflow:auto">
                    <table><thead><tr><th>Lote</th><th>Pe√ßa</th><th>Produzido</th><th>Refugo</th><th>In√≠cio</th><th>Fim</th><th>Turno</th><th>A√ß√µes</th></tr></thead><tbody id="tblLote"></tbody></table>
                </div>
            </section>
        </div>
        
        <div id="Qualidade" class="tab-content">
             <section>
                <h4>Controle de Qualidade da Pe√ßa</h4>
                <form id="form-qualidade" autocomplete="off">
                     <input type="hidden" id="qc_id">
                    <div class="grid">
                        <div class="field col-3 autocomplete-container"><label>Pe√ßa / Lote</label><input id="qc_peca" placeholder="Ref. Lote ou C√≥d. Pe√ßa" required/></div>
                        <div class="field col-3"><label>Dimens√£o (mm)</label><input id="qc_dim" type="number" step="0.01"/></div>
                        <div class="field col-3"><label>Peso (g)</label><input id="qc_peso" type="number" step="0.01"/></div>
                        <div class="field col-3"><label>Apar√™ncia</label><select id="qc_aparencia"><option>OK</option><option>N√£o OK</option></select></div>
                        <div class="field col-6"><label>Observa√ß√£o da Apar√™ncia</label><input id="qc_obs" placeholder="Risco leve, ponto preto, etc."/></div>
                        <div class="field col-3"><label>Data/Hora</label><input id="qc_data" type="datetime-local"/></div>
                        <div class="field col-3"><label>Inspecionado por</label><input id="qc_inspetor" /></div>
                    </div>
                     <div style="margin-top:16px; display:flex; gap:10px;">
                        <button type="submit" class="primary">Salvar Medi√ß√£o</button>
                        <button type="button" class="ghost" id="btn-clear-qc">Limpar</button>
                    </div>
                </form>
            </section>
             <section>
                <h4>Hist√≥rico de Medi√ß√µes</h4>
                <div style="max-height:300px; overflow:auto">
                    <table><thead><tr><th>Pe√ßa/Lote</th><th>Dimens√£o</th><th>Peso</th><th>Apar√™ncia</th><th>Obs.</th><th>Data</th><th>Inspetor</th><th>A√ß√µes</th></tr></thead><tbody id="tblQualidade"></tbody></table>
                </div>
            </section>
        </div>

         <div id="Defeitos" class="tab-content">
             <section>
                <h4>Registro de Defeito & A√ß√£o Corretiva</h4>
                 <form id="form-defeitos" autocomplete="off">
                    <input type="hidden" id="def_id">
                    <div class="grid">
                        <div class="field col-3"><label>Tipo de defeito</label><input id="def_tipo" required /></div>
                        <div class="field col-3 autocomplete-container"><label>Pe√ßa / Lote de Refer√™ncia</label><input id="def_ref" /></div>
                        <div class="field col-2"><label>Qtde</label><input id="def_qtde" type="number" min="1" value="1"/></div>
                        <div class="field col-4"><label>Causa prov√°vel</label><input id="def_causa" /></div>
                        <div class="field col-6"><label>A√ß√£o corretiva</label><input id="def_acao" /></div>
                        <div class="field col-3"><label>Respons√°vel</label><input id="def_resp" /></div>
                        <div class="field col-3"><label>Data/Hora</label><input id="def_data" type="datetime-local"/></div>
                    </div>
                    <div style="margin-top:16px; display:flex; gap:10px;">
                        <button type="submit" class="primary">Salvar Defeito</button>
                        <button type="button" class="ghost" id="btn-clear-def">Limpar</button>
                    </div>
                </form>
            </section>
            <section>
                <h4>Hist√≥rico de Defeitos</h4>
                 <div style="max-height:300px; overflow:auto">
                    <table><thead><tr><th>Defeito</th><th>Ref</th><th>Qtde</th><th>Causa</th><th>A√ß√£o</th><th>Resp.</th><th>Data</th><th>A√ß√µes</th></tr></thead><tbody id="tblDefeitos"></tbody></table>
                </div>
            </section>
        </div>

        <div id="Cadastros" class="tab-content">
            <section><h4>Cadastro de M√°quinas</h4><div style="display:flex; gap:8px; margin-bottom:12px;"><button class="btn ghost" id="btn-import-maquinas">Importar (CSV)</button><button class="btn ghost" id="btn-export-maquinas">Exportar (CSV)</button></div><table id="tblCadMaquinas"><thead><tr><th>Nome da M√°quina</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table><div style="margin-top:10px;display:flex;gap:10px;"><input type="text" id="new-maquina" placeholder="Nome da nova m√°quina" style="flex-grow:1;"><button class="btn ghost" data-type="maquinas">Adicionar</button></div></section>
            <section><h4>Cadastro de Moldes</h4><div style="display:flex; gap:8px; margin-bottom:12px;"><button class="btn ghost" id="btn-import-moldes">Importar (CSV)</button><button class="btn ghost" id="btn-export-moldes">Exportar (CSV)</button></div><table id="tblCadMoldes"><thead><tr><th>Nome do Molde</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table><div style="margin-top:10px;display:flex;gap:10px;"><input type="text" id="new-molde" placeholder="Nome do novo molde" style="flex-grow:1;"><button class="btn ghost" data-type="moldes">Adicionar</button></div></section>
            <section><h4>Cadastro de Pe√ßas</h4><div style="display:flex; gap:8px; margin-bottom:12px;"><button class="btn ghost" id="btn-import-pecas">Importar (CSV)</button><button class="btn ghost" id="btn-export-pecas">Exportar (CSV)</button></div><table id="tblCadPecas"><thead><tr><th>C√≥digo</th><th>Descri√ß√£o</th><th>A√ß√£o</th></tr></thead><tbody></tbody></table><div style="margin-top:10px;display:flex;gap:10px;"><input type="text" id="new-peca-codigo" placeholder="C√≥digo" style="flex:1;"><input type="text" id="new-peca-desc" placeholder="Descri√ß√£o" style="flex:2;"><button class="btn ghost" data-type="pecas">Adicionar</button></div></section>
        </div>

        <div id="Ajuda" class="tab-content">
            <section>
                <h2>Guia Completo - Controle de Inje√ß√£o</h2>
                <p>Esta ferramenta foi projetada para um controle detalhado e integrado do processo de inje√ß√£o de pl√°sticos.</p>
                <h4>1. Fluxo de Trabalho Recomendado</h4>
                <p>A ferramenta √© organizada em abas que seguem o fluxo natural do processo produtivo:</p>
                <ol>
                    <li><strong>üì¶ Material:</strong> Cadastre a mat√©ria-prima que chega.</li>
                    <li><strong>‚öôÔ∏è M√°quina & Processo:</strong> Registre os par√¢metros de setup da m√°quina. Use os campos com autocompletar para M√°quina e Molde.</li>
                    <li><strong>üßæ Lote / Produ√ß√£o:</strong> Abra uma ordem de produ√ß√£o. Use o autocompletar para selecionar a Pe√ßa. Os KPIs s√£o calculados com base nos dados deste lote e no √∫ltimo ciclo salvo na aba de Processo.</li>
                    <li><strong>üß™ Controle de Qualidade:</strong> Anote medi√ß√µes e inspe√ß√µes.</li>
                    <li><strong>üö® Defeitos & A√ß√µes:</strong> Registre problemas e as a√ß√µes corretivas.</li>
                </ol>
                 <h4>2. O C√©rebro da Ferramenta: A Aba Cadastros</h4>
                <p>Esta √© uma das abas mais importantes. Nela, voc√™ gerencia as listas de base que alimentam os campos inteligentes das outras se√ß√µes:</p>
                <ul>
                    <li><strong>Listas Gerenci√°veis:</strong> Controle suas listas de <strong>M√°quinas, Moldes e Pe√ßas</strong> (c√≥digo e descri√ß√£o).</li>
                    <li><strong>Adicionar "Na Hora":</strong> Se voc√™ digitar um nome de m√°quina, molde ou pe√ßa que n√£o existe em um formul√°rio, a op√ß√£o "+ Adicionar..." aparecer√°, permitindo cadastr√°-lo sem precisar vir para esta aba.</li>
                    <li><strong>Gerenciamento em Massa (CSV):</strong> Utilize <strong>Importar (CSV)</strong> para carregar rapidamente suas listas e <strong>Exportar (CSV)</strong> para fazer um backup delas.</li>
                </ul>
                <h4>3. Funcionalidades Avan√ßadas</h4>
                 <ul>
                    <li><strong>Edi√ß√£o Direta:</strong> Clique em "Editar" em qualquer registro para carregar seus dados no formul√°rio da aba, permitindo corre√ß√µes r√°pidas.</li>
                    <li><strong>Backup e Restaura√ß√£o:</strong> Use os bot√µes no cabe√ßalho para salvar um backup completo de todos os dados (<code>.json</code>) ou restaurar um backup anterior.</li>
                    <li><strong>Arquivamento:</strong> Para manter a performance, use periodicamente o bot√£o "Arquivar e Limpar", que salva um backup e depois limpa os dados do navegador.</li>
                </ul>
            </section>
        </div>
        
        <div id="add-item-desc-modal" class="modal hidden"><div class="modal-content"><h3>Adicionar Nova Pe√ßa</h3><p>C√≥digo: <b id="new-item-code-display"></b></p><form id="new-item-desc-form"><div class="field" style="text-align: left;"><label for="new-item-desc-input">Descri√ß√£o</label><input type="text" id="new-item-desc-input" required></div><div style="display:flex;gap:10px;margin-top:15px;"><button type="button" id="btn-cancel-new-item" class="btn ghost">Cancelar</button><button type="submit" class="btn primary">Salvar Item</button></div></form></div></div>
    </main>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE & DBs ---
        let state = {};
        const DB_KEY = 'mg_injecao_v3';

        // --- Helper Functions ---
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove()); }, 4000);
        };
        const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : '';
        const formatDateTime = (dateString) => dateString ? new Date(dateString).toLocaleString('pt-BR', {timeZone: 'UTC'}) : '';
        
        // --- Data Persistence & Backup ---
        const saveData = () => {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify(state));
            } catch (e) { console.error("Erro ao salvar:", e); showToast("Erro ao salvar.", "error"); }
        };

        const loadData = () => {
            const loadedState = JSON.parse(localStorage.getItem(DB_KEY));
            state = {
                material: loadedState?.material || [],
                processo: loadedState?.processo || [],
                producao: loadedState?.producao || [],
                qualidade: loadedState?.qualidade || [],
                defeitos: loadedState?.defeitos || [],
                maquinas: loadedState?.maquinas || ["Injetora 01", "Injetora 02", "Injetora 03"],
                moldes: loadedState?.moldes || ["Molde A-10", "Molde B-25"],
                pecas: loadedState?.pecas || [{codigo: "PC-001", descricao: "Tampa Superior"}, {codigo: "PC-002", descricao: "Base Inferior"}],
            };
        };
        
        const handleDownloadBackup = () => {
            const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `backup_injecao_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            URL.revokeObjectURL(link.href);
            showToast("Backup baixado!", "success");
        };

        const handleRestoreBackup = () => {
            const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    if (!confirm("Isso ir√° substituir TODOS os dados atuais. Deseja continuar?")) return;
                    try {
                        const backupData = JSON.parse(event.target.result);
                        state = backupData;
                        saveData();
                        showToast("Backup restaurado!", "success");
                        setTimeout(() => window.location.reload(), 1000);
                    } catch(err) { showToast("Erro ao ler o arquivo.", "error"); }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        const handleArchiveAndClear = () => {
            if (confirm("ATEN√á√ÉO: Isso ir√° baixar um backup e depois APAGAR os dados do navegador. Deseja continuar?")) {
                handleDownloadBackup();
                localStorage.removeItem(DB_KEY);
                showToast("Dados arquivados e limpos.", "info");
                setTimeout(() => window.location.reload(), 2000);
            }
        };

        // --- Tabs ---
        window.openTab = (evt, tabName) => {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName)?.classList.add('active');
            document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
            evt.currentTarget.classList.add('active');
        };

        // --- Form & Table Handlers ---
        const setupMainForm = (formId, dbArrayName, requiredFieldId, clearBtnId) => {
            const form = document.getElementById(formId);
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (document.getElementById(requiredFieldId)?.value.trim() === '') {
                    return showToast('Preencha o campo obrigat√≥rio.', 'error');
                }
                const idField = form.querySelector('input[type="hidden"]');
                const id = idField.value;
                const record = { id: id ? parseInt(id) : Date.now() };
                form.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(el => {
                    record[el.id.split('_')[1]] = el.value;
                });
                
                if (id) {
                    const index = state[dbArrayName].findIndex(item => item.id == id);
                    if (index > -1) state[dbArrayName][index] = record;
                    showToast('Registro atualizado!', 'success');
                } else {
                    state[dbArrayName].push(record);
                    showToast('Registro salvo!', 'success');
                }
                
                saveData();
                renderAllTables();
                form.reset();
                idField.value = '';
            });

            document.getElementById(clearBtnId).addEventListener('click', () => {
                form.reset();
                form.querySelector('input[type="hidden"]').value = '';
                showToast('Formul√°rio limpo.', 'info');
            });
        };

        const renderMainTable = (tbodyId, dbArrayName, columns, displayFormatters = {}) => {
            const tbody = document.getElementById(tbodyId);
            if(!tbody) return;
            tbody.innerHTML = '';
            state[dbArrayName].forEach(record => {
                const tr = tbody.insertRow();
                columns.forEach(col => {
                    const value = record[col] || '';
                    tr.insertCell().textContent = displayFormatters[col] ? displayFormatters[col](value) : value;
                });

                const actionsCell = tr.insertCell();
                const btnEdit = document.createElement('button');
                btnEdit.textContent = 'Editar';
                btnEdit.onclick = () => {
                    const formId = `form-${tbodyId.replace('tbl', '').toLowerCase()}`;
                    const form = document.getElementById(formId);
                    form.querySelector('input[type="hidden"]').value = record.id;
                    Object.keys(record).forEach(key => {
                        const inputId = `${formId.split('-')[1]}_${key}`;
                        const input = document.getElementById(inputId);
                        if (input) input.value = record[key];
                    });
                    showToast(`Dados carregados para edi√ß√£o.`, 'info');
                    window.scrollTo(0, 0);
                };
                
                const btnDelete = document.createElement('button');
                btnDelete.textContent = 'Excluir';
                btnDelete.className = 'ghost';
                btnDelete.onclick = () => {
                    if (confirm('Tem certeza?')) {
                        state[dbArrayName] = state[dbArrayName].filter(item => item.id !== record.id);
                        saveData();
                        renderAllTables();
                        showToast('Registro exclu√≠do.', 'success');
                    }
                };
                actionsCell.append(btnEdit, btnDelete);
            });
        };
        
        // --- Cadastros Tab specific handler ---
        const setupCadastros = (dbArrayName, tableId, addBtn, inputIds, isComplex = false) => {
            const tbody = document.querySelector(`#${tableId} tbody`);
            const render = () => {
                tbody.innerHTML = '';
                state[dbArrayName].forEach((item, index) => {
                    const row = tbody.insertRow();
                    if(isComplex) {
                        row.innerHTML = `<td>${item.codigo}</td><td>${item.descricao}</td>`;
                    } else {
                        row.innerHTML = `<td>${item}</td>`;
                    }
                    const actionCell = row.insertCell();
                    const btnDelete = document.createElement('button'); btnDelete.textContent = 'Excluir';
                    btnDelete.onclick = () => { if(confirm('Tem certeza?')) { state[dbArrayName].splice(index, 1); saveData(); render(); }};
                    actionCell.appendChild(btnDelete);
                });
            };

            addBtn.addEventListener('click', () => {
                const values = inputIds.map(id => document.getElementById(id).value.trim());
                if(values.some(v => !v)) return showToast('Preencha todos os campos', 'error');
                
                if(isComplex) {
                    if(state[dbArrayName].some(i => i.codigo.toLowerCase() === values[0].toLowerCase())) return showToast('Este c√≥digo j√° existe', 'error');
                    state[dbArrayName].push({codigo: values[0], descricao: values[1]});
                } else {
                    if(state[dbArrayName].some(i => i.toLowerCase() === values[0].toLowerCase())) return showToast('Este item j√° existe', 'error');
                    state[dbArrayName].push(values[0]);
                }
                saveData();
                render();
                inputIds.forEach(id => document.getElementById(id).value = '');
                showToast('Item adicionado!', 'success');
            });
            return render;
        };

        // --- Autocomplete ---
        const createAutocomplete = (inputId, dataArray, isComplex = false) => {
             const input = document.getElementById(inputId);
            const container = input.parentElement;
            let list = container.querySelector('.autocomplete-list');
            if (!list) { list = document.createElement('div'); list.className = 'autocomplete-list hidden'; container.appendChild(list); }
            const renderList = (filter = '') => {
                list.innerHTML = '';
                const filterLower = filter.toLowerCase();
                if (!filter) { list.classList.add('hidden'); return; }
                const matches = isComplex ? dataArray.filter(item => item.codigo.toLowerCase().includes(filterLower) || item.descricao.toLowerCase().includes(filterLower)) : dataArray.filter(item => item.toLowerCase().includes(filterLower));
                matches.forEach(item => { const itemEl = document.createElement('div'); itemEl.className = 'autocomplete-item'; itemEl.textContent = isComplex ? `${item.codigo} - ${item.descricao}` : item; itemEl.addEventListener('mousedown', () => { input.value = isComplex ? item.codigo : item; list.classList.add('hidden'); }); list.appendChild(itemEl); });
                const exactMatch = isComplex ? dataArray.some(item => item.codigo.toLowerCase() === filterLower) : dataArray.some(item => item.toLowerCase() === filterLower);
                if (filter && !exactMatch) {
                    const newItemEl = document.createElement('div'); newItemEl.className = 'autocomplete-item is-new'; newItemEl.textContent = `+ Adicionar "${filter}"...`;
                    newItemEl.addEventListener('mousedown', () => {
                        list.classList.add('hidden');
                        if (isComplex) {
                            const modal = document.getElementById('add-item-desc-modal');
                            document.getElementById('new-item-code-display').textContent = filter;
                            const descInput = document.getElementById('new-item-desc-input');
                            descInput.value = ''; modal.classList.remove('hidden'); descInput.focus();
                            document.getElementById('new-item-desc-form').onsubmit = e => { e.preventDefault(); const desc = descInput.value.trim(); if (desc) { dataArray.push({ codigo: filter, descricao: desc }); input.value = filter; saveData(); renderAllCadastrosTables(); showToast(`Item "${filter}" adicionado!`, "success"); } modal.classList.add('hidden'); };
                            document.getElementById('btn-cancel-new-item').onclick = () => modal.classList.add('hidden');
                        } else {
                           dataArray.push(filter); input.value = filter; saveData(); renderAllCadastrosTables(); showToast(`Item "${filter}" adicionado!`, "success");
                        }
                    });
                    list.appendChild(newItemEl);
                }
                list.classList.toggle('hidden', list.children.length === 0);
            };
            input.addEventListener('input', () => renderList(input.value)); input.addEventListener('focus', () => renderList(input.value)); input.addEventListener('blur', () => setTimeout(() => list.classList.add('hidden'), 200));
        };

        // --- KPIs ---
        const updateLoteKPIs = () => {
            const lastProcess = state.processo.length > 0 ? state.processo[state.processo.length - 1] : {};
            const cav = parseInt(document.getElementById('lote_cav').value) || 1;
            const ciclo = parseFloat(lastProcess.ciclo) || 0;
            const produzido = parseInt(document.getElementById('lote_produzido').value) || 0;
            const refugo = parseInt(document.getElementById('lote_refugo').value) || 0;

            const prodHora = ciclo > 0 ? Math.round((3600 / ciclo) * cav) : 0;
            const total = produzido + refugo;
            const yieldVal = total > 0 ? (produzido / total) * 100 : 100;
            const scrapVal = total > 0 ? (refugo / total) * 100 : 0;

            const kpiProd = document.getElementById('kpiProd'); const kpiYield = document.getElementById('kpiYield'); const kpiScrap = document.getElementById('kpiScrap');
            
            kpiProd.textContent = `${prodHora} p√ßs/h`;
            kpiYield.textContent = `${yieldVal.toFixed(1)} %`;
            kpiScrap.textContent = `${scrapVal.toFixed(1)} %`;

            kpiYield.className = 'kpi-value'; if (yieldVal >= 98) kpiYield.classList.add('kpi-ok'); else if (yieldVal >= 95) kpiYield.classList.add('kpi-warn'); else kpiYield.classList.add('kpi-bad');
            kpiScrap.className = 'kpi-value'; if (scrapVal <= 2) kpiScrap.classList.add('kpi-ok'); else if (scrapVal <= 5) kpiScrap.classList.add('kpi-warn'); else kpiScrap.classList.add('kpi-bad');
        };

        // --- Main Render Functions ---
        let renderMaquinas, renderMoldes, renderPecas;
        const renderAllCadastrosTables = () => { if(renderMaquinas) { renderMaquinas(); renderMoldes(); renderPecas(); } };
        const renderAllTables = () => {
            renderMainTable('tblMaterial', 'material', ['tipo', 'fornecedor', 'lote', 'fabricacao', 'recebimento', 'secagem'], { fabricacao: formatDate, recebimento: formatDate });
            renderMainTable('tblProcesso', 'processo', ['maquina', 'molde', 'material', 'ciclo', 'operador']);
            renderMainTable('tblLote', 'producao', ['codigo', 'peca', 'produzido', 'refugo', 'inicio', 'fim', 'turno'], { inicio: formatDateTime, fim: formatDateTime });
            renderMainTable('tblQualidade', 'qualidade', ['peca', 'dim', 'peso', 'aparencia', 'obs', 'data', 'inspetor'], { data: formatDateTime });
            renderMainTable('tblDefeitos', 'defeitos', ['tipo', 'ref', 'qtde', 'causa', 'acao', 'resp', 'data'], { data: formatDateTime });
            updateLoteKPIs();
        };

        // --- INITIALIZATION & EVENT LISTENERS ---
        loadData();
        
        document.getElementById('btn-download-backup').addEventListener('click', handleDownloadBackup);
        document.getElementById('btn-restore-backup').addEventListener('click', handleRestoreBackup);
        document.getElementById('btn-archive-and-clear').addEventListener('click', handleArchiveAndClear);

        setupMainForm('form-material', 'material', 'mat_tipo', 'btn-clear-mat');
        setupMainForm('form-processo', 'processo', 'proc_maquina', 'btn-clear-proc');
        setupMainForm('form-producao', 'producao', 'lote_codigo', 'btn-clear-lote');
        setupMainForm('form-qualidade', 'qualidade', 'qc_peca', 'btn-clear-qc');
        setupMainForm('form-defeitos', 'defeitos', 'def_tipo', 'btn-clear-def');
        
        renderMaquinas = setupCadastros('maquinas', 'tblCadMaquinas', document.querySelector('button[data-type="maquinas"]'), ['new-maquina']);
        renderMoldes = setupCadastros('moldes', 'tblCadMoldes', document.querySelector('button[data-type="moldes"]'), ['new-molde']);
        renderPecas = setupCadastros('pecas', 'tblCadPecas', document.querySelector('button[data-type="pecas"]'), ['new-peca-codigo', 'new-peca-desc'], true);

        createAutocomplete('proc_maquina', state.maquinas);
        createAutocomplete('proc_molde', state.moldes);
        createAutocomplete('lote_peca', state.pecas, true);
        createAutocomplete('qc_peca', state.pecas, true);
        createAutocomplete('def_ref', state.pecas, true);
        
        ['lote_produzido', 'lote_refugo', 'lote_cav'].forEach(id => document.getElementById(id).addEventListener('input', updateLoteKPIs));
        document.getElementById('proc_ciclo').addEventListener('input', updateLoteKPIs);
        
        document.getElementById('btn-export-maquinas').addEventListener('click', () => handleExportCSV(state.maquinas, 'maquinas.csv'));
        document.getElementById('btn-import-maquinas').addEventListener('click', () => handleImportCSV(state.maquinas));
        document.getElementById('btn-export-moldes').addEventListener('click', () => handleExportCSV(state.moldes, 'moldes.csv'));
        document.getElementById('btn-import-moldes').addEventListener('click', () => handleImportCSV(state.moldes));
        document.getElementById('btn-export-pecas').addEventListener('click', () => handleExportCSV(state.pecas, 'pecas.csv', true));
        document.getElementById('btn-import-pecas').addEventListener('click', () => handleImportCSV(state.pecas, true));

        renderAllTables();
        renderAllCadastrosTables();
    });
    </script>
</body>
</html>